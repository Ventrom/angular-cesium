!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common"),require("geodesy"),require("util"),require("rxjs/operators"),require("rxjs"),require("primitive-primitives"),require("json-string-mapper"),require("angular2parse"),require("lodash.get")):"function"==typeof define&&define.amd?define("angular-cesium",["exports","@angular/core","@angular/common","geodesy","util","rxjs/operators","rxjs","primitive-primitives","json-string-mapper","angular2parse","lodash.get"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["angular-cesium"]={},t.ng.core,t.ng.common,t.geodesy,t.util,t.rxjs.operators,t.rxjs,t.primitivePrimitives,t.jsonStringMapper,t.angular2parse,t._get)}(this,(function(t,e,i,n,o,r,s,a,c,p,l){"use strict";function d(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var u=d(n),h=d(l),g=function(){function t(){this.cesium=Cesium}return t.prototype.createViewer=function(t,e){return e?new this.cesium.Viewer(t,Object.assign({contextOptions:{webgl:{preserveDrawingBuffer:!0}}},e)):new this.cesium.Viewer(t,{contextOptions:{webgl:{preserveDrawingBuffer:!0}}})},t}();g.decorators=[{type:e.Injectable}],g.ctorParameters=function(){return[]};var y=function(){function t(){this.nextViewerOptionsIndex=0,this.nextViewerModifierIndex=0}return Object.defineProperty(t.prototype,"viewerOptions",{get:function(){return this._viewerOptions},set:function(t){this._viewerOptions=t},enumerable:!1,configurable:!0}),t.prototype.getNextViewerOptions=function(){return this._viewerOptions instanceof Array?this._viewerOptions[this.nextViewerOptionsIndex++]:this._viewerOptions},Object.defineProperty(t.prototype,"viewerModifier",{get:function(){return this._viewerModifier},set:function(t){this._viewerModifier=t},enumerable:!1,configurable:!0}),t.prototype.getNextViewerModifier=function(){return this._viewerModifier instanceof Array?this._viewerModifier[this.nextViewerModifierIndex++]:this._viewerModifier},t}();y.decorators=[{type:e.Injectable}];var f=function(){function t(t,e,i){this.ngZone=t,this.viewerFactory=e,this.viewerConfiguration=i}return t.prototype.init=function(t,e){var i=this;this.map=e,this.ngZone.runOutsideAngular((function(){var e=i.viewerConfiguration?i.viewerConfiguration.getNextViewerOptions():void 0;i.cesiumViewer=i.viewerFactory.createViewer(t,e);var n=i.viewerConfiguration&&i.viewerConfiguration.getNextViewerModifier();"function"==typeof n&&n(i.cesiumViewer)}))},t.prototype.getViewer=function(){return this.cesiumViewer},t.prototype.getScene=function(){return this.cesiumViewer.scene},t.prototype.getCanvas=function(){return this.cesiumViewer.canvas},t.prototype.getMap=function(){return this.map},t}();f.decorators=[{type:e.Injectable}],f.ctorParameters=function(){return[{type:e.NgZone},{type:g},{type:y,decorators:[{type:e.Optional}]}]};var m=Cesium.AssociativeArray,v=Cesium.Color,E=Cesium.ColorGeometryInstanceAttribute,P=Cesium.defined,b=Cesium.DistanceDisplayCondition,C=Cesium.DistanceDisplayConditionGeometryInstanceAttribute,_=Cesium.ShowGeometryInstanceAttribute,M=Cesium.Primitive,S=Cesium.ShadowMode,T=Cesium.BoundingSphereState,A=Cesium.ColorMaterialProperty,O=Cesium.MaterialProperty,I=Cesium.Property,D=new v,L=new b,w=new b;function R(t,e,i,n,o,r,s){var a;this.translucent=e,this.appearanceType=i,this.depthFailAppearanceType=n,this.depthFailMaterialProperty=o,this.depthFailMaterial=void 0,this.closed=r,this.shadows=s,this.primitives=t,this.createPrimitive=!1,this.waitingOnCreate=!1,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new m,this.updaters=new m,this.updatersWithAttributes=new m,this.attributes=new m,this.subscriptions=new m,this.showsUpdated=new m,this.itemsToRemove=[],this.invalidated=!1,P(o)&&(a=o.definitionChanged.addEventListener(R.prototype.onMaterialChanged,this)),this.removeMaterialSubscription=a}R.prototype.onMaterialChanged=function(){this.invalidated=!0},R.prototype.isMaterial=function(t){var e=this.depthFailMaterialProperty,i=t.depthFailMaterialProperty;return i===e||!!P(e)&&e.equals(i)},R.prototype.add=function(t,e){var i=t.id;if(this.createPrimitive=!0,this.geometry.set(i,e),this.updaters.set(i,t),t.hasConstantFill&&t.fillMaterialProperty.isConstant&&I.isConstant(t.distanceDisplayConditionProperty)){var n=this;this.subscriptions.set(i,t.entity.definitionChanged.addEventListener((function(e,i,o,r){"isShowing"===i&&n.showsUpdated.set(t.id,t)})))}else this.updatersWithAttributes.set(i,t)},R.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);P(i)&&(i(),this.subscriptions.remove(e))}},R.prototype.update=function(t){var e,i,n=!0,o=0,r=this.primitive,s=this.primitives;if(this.createPrimitive){var a=this.geometry.values,c=a.length;if(c>0){for(P(r)&&(P(this.oldPrimitive)?s.remove(r):this.oldPrimitive=r),i=0;i<c;i++){var p=a[i],l=p.attributes;e=this.attributes.get(p.id.id),P(e)&&(P(l.show)&&(l.show.value=e.show),P(l.color)&&(l.color.value=e.color),P(l.depthFailColor)&&(l.depthFailColor.value=e.depthFailColor))}var d;P(this.depthFailAppearanceType)&&(P(this.depthFailMaterialProperty)&&(this.depthFailMaterial=O.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial)),d=new this.depthFailAppearanceType({material:this.depthFailMaterial,translucent:this.translucent,closed:this.closed})),r=new M({show:!1,asynchronous:!0,geometryInstances:a,appearance:new this.appearanceType({flat:this.shadows===S.DISABLED||this.shadows===S.CAST_ONLY,translucent:this.translucent,closed:this.closed}),depthFailAppearance:d,shadows:this.shadows}),s.add(r),n=!1}else{P(r)&&(s.remove(r),r=void 0);var u=this.oldPrimitive;P(u)&&(s.remove(u),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=r,this.createPrimitive=!1,this.waitingOnCreate=!0}else if(P(r)&&r.ready){r.show=!0,P(this.oldPrimitive)&&(s.remove(this.oldPrimitive),this.oldPrimitive=void 0),!P(this.depthFailAppearanceType)||this.depthFailMaterialProperty instanceof A||(this.depthFailMaterial=O.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),this.primitive.depthFailAppearance.material=this.depthFailMaterial);var h=this.updatersWithAttributes.values,g=h.length,y=this.waitingOnCreate;for(i=0;i<g;i++){var f=h[i],m=this.geometry.get(f.id);if(e=this.attributes.get(m.id.id),P(e)||(e=r.getGeometryInstanceAttributes(m.id),this.attributes.set(m.id.id,e)),!f.fillMaterialProperty.isConstant||y){var T=f.fillMaterialProperty.color,R=I.getValueOrDefault(T,t,v.WHITE,D);v.equals(e._lastColor,R)||(e._lastColor=v.clone(R,e._lastColor),e.color=E.toValue(R,e.color),(this.translucent&&255===e.color[3]||!this.translucent&&255!==e.color[3])&&(this.itemsToRemove[o++]=f))}if(P(this.depthFailAppearanceType)&&f.depthFailMaterialProperty instanceof A&&(!f.depthFailMaterialProperty.isConstant||y)){var x=f.depthFailMaterialProperty.color,j=I.getValueOrDefault(x,t,v.WHITE,D);v.equals(e._lastDepthFailColor,j)||(e._lastDepthFailColor=v.clone(j,e._lastDepthFailColor),e.depthFailColor=E.toValue(j,e.depthFailColor))}var k=f.entity.isShowing&&(f.hasConstantFill||f.isFilled(t));k!==(1===e.show[0])&&(e.show=_.toValue(k,e.show));var N=f.distanceDisplayConditionProperty;if(!I.isConstant(N)){var F=I.getValueOrDefault(N,t,w,L);b.equals(F,e._lastDistanceDisplayCondition)||(e._lastDistanceDisplayCondition=b.clone(F,e._lastDistanceDisplayCondition),e.distanceDisplayCondition=C.toValue(F,e.distanceDisplayCondition))}}this.updateShows(r),this.waitingOnCreate=!1}else P(r)&&!r.ready&&(n=!1);return this.itemsToRemove.length=o,n},R.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,n=0;n<i;n++){var o=e[n],r=this.geometry.get(o.id),s=this.attributes.get(r.id.id);P(s)||(s=t.getGeometryInstanceAttributes(r.id),this.attributes.set(r.id.id,s));var a=o.entity.isShowing;a!==(1===s.show[0])&&(s.show=_.toValue(a,s.show))}this.showsUpdated.removeAll()},R.prototype.contains=function(t){return this.updaters.contains(t.id)},R.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return T.PENDING;var n=i.getGeometryInstanceAttributes(t.entity);return!P(n)||!P(n.boundingSphere)||P(n.show)&&0===n.show[0]?T.FAILED:(n.boundingSphere.clone(e),T.DONE)},R.prototype.removeAllPrimitives=function(){var t=this.primitives,e=this.primitive;P(e)&&(t.remove(e),this.primitive=void 0,this.geometry.removeAll(),this.updaters.removeAll());var i=this.oldPrimitive;P(i)&&(t.remove(i),this.oldPrimitive=void 0)},R.prototype.destroy=function(){var t=this.primitive,e=this.primitives;P(t)&&e.remove(t);var i=this.oldPrimitive;P(i)&&e.remove(i),P(this.removeMaterialSubscription)&&this.removeMaterialSubscription()};var x=!1;var j,k=new e.InjectionToken("ANGULAR_CESIUM_CONFIG"),N=function(t){this.config=t,!1!==(!t||t.fixEntitiesShadows)&&(x||(Cesium.StaticGeometryColorBatch.prototype.add=function(t,e){var i,n,o=e.createFillGeometryInstance(t);255===o.attributes.color.value[3]?(i=this._solidItems,n=!1):(i=this._translucentItems,n=!0);for(var r=i.length,s=0;s<r;s++){var a=i[s];if(a.isMaterial(e))return void a.add(e,o)}var c=new R(this._primitives,n,this._appearanceType,this._depthFailAppearanceType,e.depthFailMaterialProperty,this._closed,this._shadows);c.add(e,o),i.push(c)},x=!0))};N.decorators=[{type:e.Injectable}],N.ctorParameters=function(){return[{type:void 0,decorators:[{type:e.Optional},{type:e.Inject,args:[k]}]}]},(j=t.SceneMode||(t.SceneMode={}))[j.SCENE3D=0]="SCENE3D",j[j.COLUMBUS_VIEW=1]="COLUMBUS_VIEW",j[j.SCENE2D=2]="SCENE2D",j[j.PERFORMANCE_SCENE2D=3]="PERFORMANCE_SCENE2D";var F,H,V=function(){function e(){this.isSceneModePerformance2D=!1}return e.prototype.init=function(t){this.viewer=t.getViewer(),this.scene=t.getScene(),this.screenSpaceCameraController=this.scene.screenSpaceCameraController,this.camera=this.scene.camera,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastLook=this.screenSpaceCameraController.enableLook},e.prototype._listenToSceneModeMorph=function(t){this.morphListenerCancelFn=this.scene.morphStart.addEventListener(t)},e.prototype._revertCameraProperties=function(){this.isSceneModePerformance2D=!1,this.enableTilt(this.lastTilt),this.enableRotate(this.lastRotate),this.enableLook(this.lastLook)},e.prototype.getCamera=function(){return this.camera},e.prototype.getScreenSpaceCameraController=function(){return this.screenSpaceCameraController},e.prototype.getMinimumZoom=function(){return this.screenSpaceCameraController.minimumZoomDistance},e.prototype.setMinimumZoom=function(t){this.screenSpaceCameraController.minimumZoomDistance=t},e.prototype.getMaximumZoom=function(){return this.screenSpaceCameraController.maximumZoomDistance},e.prototype.setMaximumZoom=function(t){this.screenSpaceCameraController.maximumZoomDistance=t},e.prototype.enableTilt=function(t){this.screenSpaceCameraController.enableTilt=t},e.prototype.enableRotate=function(t){this.screenSpaceCameraController.enableRotate=t},e.prototype.enableLook=function(t){this.screenSpaceCameraController.enableLook=t},e.prototype.enableTranslate=function(t){this.screenSpaceCameraController.enableTranslate=t},e.prototype.enableZoom=function(t){this.screenSpaceCameraController.enableZoom=t},e.prototype.enableInputs=function(t){this.screenSpaceCameraController.enableInputs=t},e.prototype.setSceneMode=function(i,n){var o=this;switch(i){case t.SceneMode.SCENE3D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo3D(n);break;case t.SceneMode.COLUMBUS_VIEW:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphToColumbusView(n);break;case t.SceneMode.SCENE2D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo2D(n);break;case t.SceneMode.PERFORMANCE_SCENE2D:this.isSceneModePerformance2D=!0,this.lastLook=this.screenSpaceCameraController.enableLook,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.screenSpaceCameraController.enableTilt=!1,this.screenSpaceCameraController.enableRotate=!1,this.screenSpaceCameraController.enableLook=!1,this.morphListenerCancelFn&&this.morphListenerCancelFn(),this.scene.morphToColumbusView(n);var r=this.scene.morphComplete.addEventListener((function(){o.camera.setView({destination:Cesium.Cartesian3.fromDegrees(0,0,Math.min(e.PERFORMANCE_2D_ALTITUDE,o.getMaximumZoom())),orientation:{pitch:Cesium.Math.toRadians(-90)}}),r(),o._listenToSceneModeMorph(o._revertCameraProperties.bind(o))}))}},e.prototype.cameraFlyTo=function(t){if(t)return this.camera.flyTo(t)},e.prototype.flyTo=function(t,e){return this.viewer.flyTo(t,e)},e.prototype.zoomIn=function(t){return this.camera.zoomIn(t||this.camera.defaultZoomAmount)},e.prototype.zoomOut=function(t){return this.camera.zoomOut(t||this.camera.defaultZoomAmount)},e.prototype.zoomTo=function(t,e){return this.viewer.zoomTo(t,e)},e.prototype.setView=function(t){this.camera.setView(t)},e.prototype.setRotation=function(t){this.setView({orientation:{heading:t}})},e.prototype.lockRotation=function(t){this.scene.screenSpaceCameraController.enableRotate=!t},e.prototype.trackEntity=function(t,e){var i=this,n=e&&e.flyTo||!1;return this.viewer.trackedEntity=void 0,new Promise((function(o){if(n){var r=e&&e.flyToDuration||1,s=e&&e.altitude||1e4,a=t.position.getValue(Cesium.JulianDate.now()),c=Cesium.Cartographic.fromCartesian(a),p=s-c.height;c.height=s;var l=Cesium.Cartesian3.fromRadians(c.longitude,c.latitude,c.height);i.cameraFlyTo({duration:r,destination:l,complete:function(){i.viewer.trackedEntity=t,setTimeout((function(){p>0?i.camera.zoomOut(p):i.camera.zoomIn(p)}),0),o()}})}else i.viewer.trackedEntity=t,o()}))},e.prototype.untrackEntity=function(){this.trackEntity()},e}();V.PERFORMANCE_2D_ALTITUDE=25e6,V.decorators=[{type:e.Injectable}],V.ctorParameters=function(){return[]},(F=t.CesiumEvent||(t.CesiumEvent={}))[F.MOUSE_MOVE=Cesium.ScreenSpaceEventType.MOUSE_MOVE]="MOUSE_MOVE",F[F.LEFT_CLICK=Cesium.ScreenSpaceEventType.LEFT_CLICK]="LEFT_CLICK",F[F.LEFT_DOUBLE_CLICK=Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK]="LEFT_DOUBLE_CLICK",F[F.LEFT_DOWN=Cesium.ScreenSpaceEventType.LEFT_DOWN]="LEFT_DOWN",F[F.LEFT_UP=Cesium.ScreenSpaceEventType.LEFT_UP]="LEFT_UP",F[F.MIDDLE_CLICK=Cesium.ScreenSpaceEventType.MIDDLE_CLICK]="MIDDLE_CLICK",F[F.MIDDLE_DOUBLE_CLICK=Cesium.ScreenSpaceEventType.MIDDLE_DOUBLE_CLICK]="MIDDLE_DOUBLE_CLICK",F[F.MIDDLE_DOWN=Cesium.ScreenSpaceEventType.MIDDLE_DOWN]="MIDDLE_DOWN",F[F.MIDDLE_UP=Cesium.ScreenSpaceEventType.MIDDLE_UP]="MIDDLE_UP",F[F.PINCH_START=Cesium.ScreenSpaceEventType.PINCH_START]="PINCH_START",F[F.PINCH_END=Cesium.ScreenSpaceEventType.PINCH_END]="PINCH_END",F[F.PINCH_MOVE=Cesium.ScreenSpaceEventType.PINCH_MOVE]="PINCH_MOVE",F[F.RIGHT_CLICK=Cesium.ScreenSpaceEventType.RIGHT_CLICK]="RIGHT_CLICK",F[F.RIGHT_DOUBLE_CLICK=Cesium.ScreenSpaceEventType.RIGHT_DOUBLE_CLICK]="RIGHT_DOUBLE_CLICK",F[F.RIGHT_DOWN=Cesium.ScreenSpaceEventType.RIGHT_DOWN]="RIGHT_DOWN",F[F.RIGHT_UP=Cesium.ScreenSpaceEventType.RIGHT_UP]="RIGHT_UP",F[F.WHEEL=Cesium.ScreenSpaceEventType.WHEEL]="WHEEL",F[F.LONG_LEFT_PRESS=110]="LONG_LEFT_PRESS",F[F.LONG_RIGHT_PRESS=111]="LONG_RIGHT_PRESS",F[F.LONG_MIDDLE_PRESS=112]="LONG_MIDDLE_PRESS",F[F.LEFT_CLICK_DRAG=113]="LEFT_CLICK_DRAG",F[F.RIGHT_CLICK_DRAG=114]="RIGHT_CLICK_DRAG",F[F.MIDDLE_CLICK_DRAG=115]="MIDDLE_CLICK_DRAG",(H=t.PickOptions||(t.PickOptions={}))[H.NO_PICK=0]="NO_PICK",H[H.PICK_FIRST=1]="PICK_FIRST",H[H.PICK_ONE=2]="PICK_ONE",H[H.PICK_ALL=3]="PICK_ALL";var B=function(){function i(){this._showContextMenu=!1,this._contextMenuChangeNotifier=new e.EventEmitter,this._onOpen=new e.EventEmitter,this._onClose=new e.EventEmitter,this._defaultContextMenuOptions={closeOnLeftCLick:!0,closeOnLeftClickPriority:10}}return Object.defineProperty(i.prototype,"contextMenuChangeNotifier",{get:function(){return this._contextMenuChangeNotifier},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"showContextMenu",{get:function(){return this._showContextMenu},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"position",{get:function(){return this._position},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"content",{get:function(){return this._content},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onOpen",{get:function(){return this._onOpen},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"onClose",{get:function(){return this._onClose},enumerable:!1,configurable:!0}),i.prototype.init=function(t){this.mapEventsManager=t},i.prototype.open=function(e,i,n){var o=this;void 0===n&&(n={}),this.close(),this._content=e,this._position=i,this._options=Object.assign({},this._defaultContextMenuOptions,n),this._showContextMenu=!0,this.mapEventsManager&&this._options.closeOnLeftCLick&&(this.leftClickRegistration=this.mapEventsManager.register({event:t.CesiumEvent.LEFT_CLICK,pick:t.PickOptions.NO_PICK,priority:this._options.closeOnLeftClickPriority}),this.leftClickSubscription=this.leftClickRegistration.subscribe((function(){o.leftClickSubscription.unsubscribe(),o.close()}))),this._contextMenuChangeNotifier.emit(),this._onOpen.emit()},i.prototype.close=function(){this._content=void 0,this._position=void 0,this._options=void 0,this._showContextMenu=!1,this.leftClickRegistration&&(this.leftClickRegistration.dispose(),this.leftClickRegistration=void 0),this.leftClickSubscription&&(this.leftClickSubscription.unsubscribe(),this.leftClickSubscription=void 0),this._contextMenuChangeNotifier.emit(),this._onClose.emit()},i}();B.decorators=[{type:e.Injectable}];var U=n.LatLonVectors;window.geodesy=u;var G=function(){function t(t){this.cesiumService=t}return t.cartesian3ToLatLon=function(t,e){var i=Cesium.Cartographic.fromCartesian(t,e);return{lon:Cesium.Math.toDegrees(i.longitude),lat:Cesium.Math.toDegrees(i.latitude),height:i.height}},t.prototype.screenToCartesian3=function(t,e){if(this.cesiumService){var i=Object.assign({},t);if(e){var n=this.cesiumService.getViewer().canvas.getBoundingClientRect();i.x+=n.left,i.y+=n.top}return this.cesiumService.getViewer().camera.pickEllipsoid(i)}throw new Error("ANGULAR2-CESIUM - Cesium service should be provided in order to do screen position calculations")},t.prototype.screenToCartographic=function(t,e){return this.cartesian3ToCartographic(this.screenToCartesian3(t),e)},t.prototype.cartesian3ToCartographic=function(t,e){return Cesium.Cartographic.fromCartesian(t,e)},t.prototype.degreesToCartographic=function(t,e,i){return Cesium.Cartographic.fromDegrees(t,e,i)},t.prototype.radiansToCartographic=function(t,e,i){return Cesium.Cartographic.fromRadians(t,e,i)},t.prototype.degreesToUTM=function(t,e){return new n.LatLonEllipsoidal(e,t).toUtm()},t.prototype.UTMToDegrees=function(t,e,i,o){return this.geodesyToCesiumObject(new n.Utm(t,e,i,o).toLatLonE())},t.prototype.geodesyToCesiumObject=function(t){return{longitude:t.lon,latitude:t.lat,height:t.height?t.height:0}},t.prototype.midPointToCartesian3=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new U(i(t.latitude),i(t.longitude)),o=new U(i(e.latitude),i(e.longitude)),r=n.midpointTo(o);return Cesium.Cartesian3.fromDegrees(r.lon,r.lat)},t.prototype.middlePointByScreen=function(t,e){var i=this.cesiumService.getScene(),n=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,t),o=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,e),r=new Cesium.Cartesian2((o.x+n.x)/2,(o.y+n.y)/2);return i.pickPosition(r)},t.prototype.bearingTo=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new U(i(t.latitude),i(t.longitude)),o=new U(i(e.latitude),i(e.longitude));return n.bearingTo(o)},t.prototype.bearingToCartesian=function(t,e){var i=Cesium.Cartographic.fromCartesian(t),n=Cesium.Cartographic.fromCartesian(e);return this.bearingTo(i,n)},t}();G.decorators=[{type:e.Injectable}],G.ctorParameters=function(){return[{type:f,decorators:[{type:e.Optional}]}]};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var K=function(t,e){return(K=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function z(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}K(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}Object.create;function W(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,o,r=i.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=r.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(o)throw o.error}}return s}function $(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(W(arguments[e]));return t}Object.create;var Y=function(){function t(){}return t.prototype.setPropsAssigner=function(t){this._propsAssigner=t},t}(),Z=function(t){function e(e,i){var n=t.call(this)||this;return n.drawerType=e,n.cesiumService=i,n._show=!0,n}return z(e,t),e.prototype.init=function(){this._cesiumCollection=new this.drawerType,this._primitiveCollectionWrap=new Cesium.PrimitiveCollection({destroyPrimitives:!1}),this._primitiveCollectionWrap.add(this._cesiumCollection),this.cesiumService.getScene().primitives.add(this._primitiveCollectionWrap)},e.prototype.add=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return this._cesiumCollection.add(t)},e.prototype.update=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];this._propsAssigner?this._propsAssigner(t,e):Object.assign(t,e)},e.prototype.remove=function(t){this._cesiumCollection.remove(t)},e.prototype.removeAll=function(){this._cesiumCollection.removeAll()},e.prototype.setShow=function(t){this._show=t,this._primitiveCollectionWrap.show=t},e.prototype.getShow=function(){return this._show},e}(Y),q=function(){function t(t){this.cesiumService=t}return t.pointByLocationDistanceAndAzimuth=function(e,i,n,o){for(var r,s,a=i/Cesium.Ellipsoid.WGS84.maximumRadius,c=e instanceof Cesium.Cartesian3?Cesium.Cartographic.fromCartesian(e):e,p=e instanceof Cesium.Cartesian3?e:Cesium.Cartesian3.fromRadians(e.longitude,e.latitude,e.height),l=0,d=.1,u=-.1;0===l||l<16&&Math.max(s,i)/Math.min(s,i)>1.000001;){var h=u+(d-u)/2;r=t._pointByLocationDistanceAndAzimuth(c,a*(1+h),n),(s=this.distance(p,r))>i?d=u+(d-u)/2:u+=(d-u)/2,l++}return r},t._pointByLocationDistanceAndAzimuth=function(t,e,i){var n=t.latitude,o=t.longitude,r=Math.asin(Math.sin(n)*Math.cos(e)+Math.cos(n)*Math.sin(e)*Math.cos(i)),s=o+Math.atan2(Math.sin(i)*Math.sin(e)*Math.cos(n),Math.cos(e)-Math.sin(n)*Math.sin(r));return s=(s+3*Math.PI)%(2*Math.PI)-Math.PI,Cesium.Cartesian3.fromRadians(s,r)},t.distance=function(t,e){return Cesium.Cartesian3.distance(t,e)},t.getPositionsDelta=function(t,e){return{x:e.x-t.x,y:e.y-t.y,z:e.z-t.z}},t.addDeltaToPosition=function(t,e,i){if(void 0===i&&(i=!1),i){t.x+=e.x,t.y+=e.y,t.z+=e.z,(o=Cesium.Cartographic.fromCartesian(t)).height=0;var n=Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height);return t.x=n.x,t.y=n.y,t.z=n.z,t}var o;n=new Cesium.Cartesian3(t.x+e.x,t.y+e.y,t.z+e.z);return(o=Cesium.Cartographic.fromCartesian(n)).height=0,Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height)},t.middleCartesian3Point=function(t,e){return new Cesium.Cartesian3(e.x-t.x/2,e.y-t.y/2,e.z-t.z/2)},t.prototype.screenPositionToCartesian3=function(t){return this.cesiumService.getViewer().camera.pickEllipsoid(t)},t}();q.decorators=[{type:e.Injectable}],q.ctorParameters=function(){return[{type:f}]};var X,J=function(t){function e(e){return t.call(this,Cesium.PolylineCollection,e)||this}return z(e,t),e.prototype._calculateArcPositions=function(t){for(var e=t.quality||18,i=t.delta/e,n=[],o=0;o<e+1;++o){var r=q.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle+i*o,!0);n.push(r)}return n},e.prototype._calculateTriangle=function(t){return[t.center,q.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle,!0)]},e.prototype._calculateArc=function(t){var e=this._calculateArcPositions(t);return t.drawEdges?e.concat(this._calculateTriangle(t)):e},e.prototype.add=function(t){if(t.positions=this._calculateArc(t),t.color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.color,t.material=e}return this._cesiumCollection.add(t)},e.prototype.update=function(t,e){return e.constantColor||!e.color||t.material.uniforms.color.equals(e.color)||(t.material.uniforms.color=e.color),t.width=void 0!==e.width?e.width:t.width,t.show=void 0!==e.show?e.show:t.show,t.distanceDisplayCondition=void 0!==e.distanceDisplayCondition?e.distanceDisplayCondition:t.distanceDisplayCondition,t.positions=this._calculateArc(e),t},e}(Z);J.decorators=[{type:e.Injectable}],J.ctorParameters=function(){return[{type:f}]},(X=t.ɵf||(t.ɵf={}))[X.ellipse=Cesium.EllipseGraphics]="ellipse",X[X.ellipsoid=Cesium.EllipsoidGraphics]="ellipsoid",X[X.polygon=Cesium.PolygonGraphics]="polygon",X[X.polyline=Cesium.PolylineGraphics]="polyline",X[X.polylineVolume=Cesium.PolylineVolumeGraphics]="polylineVolume",X[X.box=Cesium.BoxGraphics]="box",X[X.corridor=Cesium.CorridorGraphics]="corridor",X[X.cylinder=Cesium.CylinderGraphics]="cylinder",X[X.label=Cesium.LabelGraphics]="label",X[X.billboard=Cesium.BillboardGraphics]="billboard",X[X.model=Cesium.ModelGraphics]="model",X[X.path=Cesium.PathGraphics]="path",X[X.point=Cesium.PointGraphics]="point",X[X.rectangle=Cesium.RectangleGraphics]="rectangle",X[X.wall=Cesium.WallGraphics]="wall";var Q=function(){function t(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=-1),this.entityCollection=t,this._isSuspended=!1,this._isHardSuspend=!1,this._updateRate=i,this._collectionSize=e}return t.prototype.setShow=function(t){this.entityCollection.show=t},Object.defineProperty(t.prototype,"isSuspended",{get:function(){return this._isSuspended},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"updateRate",{get:function(){return this._updateRate},set:function(t){this._updateRate=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collectionSize",{get:function(){return this._collectionSize},set:function(t){this._collectionSize=t},enumerable:!1,configurable:!0}),t.prototype.collection=function(){return this.entityCollection},t.prototype.isFree=function(){return this._collectionSize<1||this.entityCollection.values.length<this._collectionSize},t.prototype.add=function(t){return this.suspend(),this.entityCollection.add(t)},t.prototype.remove=function(t){return this.suspend(),this.entityCollection.remove(t)},t.prototype.removeNoSuspend=function(t){this.entityCollection.remove(t)},t.prototype.removeAll=function(){this.suspend(),this.entityCollection.removeAll()},t.prototype.onEventSuspension=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventSuspensionCallback={callback:t,once:e},function(){i._onEventSuspensionCallback=void 0}},t.prototype.onEventResume=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventResumeCallback={callback:t,once:e},this._isSuspended||this.triggerEventResume(),function(){i._onEventResumeCallback=void 0}},t.prototype.triggerEventSuspension=function(){if(void 0!==this._onEventSuspensionCallback){var t=this._onEventSuspensionCallback.callback;this._onEventSuspensionCallback.once&&(this._onEventSuspensionCallback=void 0),t()}},t.prototype.triggerEventResume=function(){if(void 0!==this._onEventResumeCallback){var t=this._onEventResumeCallback.callback;this._onEventResumeCallback.once&&(this._onEventResumeCallback=void 0),t()}},t.prototype.suspend=function(){var t=this;this._updateRate<0||this._isHardSuspend||this._isSuspended||(this._isSuspended=!0,this.entityCollection.suspendEvents(),this.triggerEventSuspension(),this._suspensionTimeout=setTimeout((function(){t.entityCollection.resumeEvents(),t.triggerEventResume(),t._isSuspended=!1,t._suspensionTimeout=void 0}),this._updateRate))},t.prototype.hardSuspend=function(){this.entityCollection.suspendEvents(),this._isHardSuspend=!0},t.prototype.hardResume=function(){this.entityCollection.resumeEvents(),this._isHardSuspend=!1},t}(),tt=function(e){function i(i,n,o){void 0===o&&(o={collectionMaxSize:-1,collectionSuspensionTime:-1,collectionsNumber:1});var r=e.call(this)||this;for(var s in r.cesiumService=i,r.graphicsType=n,r.defaultOptions=o,r.entityCollections=new Map,r.graphicsTypeName=t.ɵf[r.graphicsType],t.ɵf)t.ɵf[s]===r.graphicsType&&(r.graphicsTypeName=s);return r}return z(i,e),i.prototype.getFreeEntitiesCollection=function(){var t=null;return this.entityCollections.forEach((function(e){e.isFree()&&(t=e)})),t},i.prototype.init=function(t){for(var e=t||this.defaultOptions,i=[],n=0;n<e.collectionsNumber;n++){var o=new Cesium.CustomDataSource(this.graphicsTypeName);i.push(o),this.cesiumService.getViewer().dataSources.add(o),this.entityCollections.set(o.entities,new Q(o.entities,e.collectionMaxSize,e.collectionSuspensionTime))}return i},i.prototype.add=function(t){var e,i=this.getFreeEntitiesCollection();if(null===i)throw new Error("No more free entity collections");var n=((e={position:void 0!==t.position?t.position:void 0,description:void 0!==t.description?t.description:void 0,orientation:void 0!==t.orientation?t.orientation:void 0,viewFrom:void 0!==t.viewFrom?t.viewFrom:void 0})[this.graphicsTypeName]=t,e);return void 0!==t.name&&(n.name=t.name),void 0!==t.availability&&(n.availability=t.availability),i.add(n)},i.prototype.update=function(t,e){this.suspendEntityCollection(t),t.position instanceof Cesium.CallbackProperty&&t.position._isConstant&&(t.position=e.position),t.position=void 0!==e.position?e.position:void 0,t.name=void 0!==e.name?e.name:t.name,t.description=void 0!==e.description?e.description:t.description,t.orientation=void 0!==e.orientation?e.orientation:t.orientation,t.viewFrom=void 0!==e.viewFrom?e.viewFrom:t.viewFrom,t.availability=(e.availability,e.availability),this._propsAssigner?this._propsAssigner(t[this.graphicsTypeName],e):Object.assign(t[this.graphicsTypeName],e)},i.prototype.remove=function(t){this.entityCollections.get(t.entityCollection).remove(t)},i.prototype.removeAll=function(){this.entityCollections.forEach((function(t){t.removeAll()}))},i.prototype.setShow=function(t){this.entityCollections.forEach((function(e){e.setShow(t)}))},i.prototype.suspendEntityCollection=function(t){var e=t.entityCollection;if(!this.entityCollections.has(e))throw new Error("No EntityCollection for entity.entityCollection");this.entityCollections.get(e).suspend()},i}(Y),et=function(e){function i(i){return e.call(this,i,t.ɵf.billboard)||this}return z(i,e),i}(tt);et.decorators=[{type:e.Injectable}],et.ctorParameters=function(){return[{type:f}]};var it=function(t){function e(e){var i=t.call(this)||this;return i.cesiumService=e,i}return z(e,t),e.prototype.init=function(t){var e=[];return this.czmlStream=new Cesium.CzmlDataSource("czml"),e.push(this.czmlStream),this.cesiumService.getViewer().dataSources.add(this.czmlStream),e},e.prototype.add=function(t){return this.czmlStream.process(t.czmlPacket),t},e.prototype.update=function(t,e){this.czmlStream.process(e.czmlPacket)},e.prototype.remove=function(t){this.czmlStream.entities.removeById(t.acEntity.id)},e.prototype.removeAll=function(){this.czmlStream.entities.removeAll()},e.prototype.setShow=function(t){this.czmlStream.entities.show=t},e}(Y);it.decorators=[{type:e.Injectable}],it.ctorParameters=function(){return[{type:f}]};var nt=function(e){function i(i){return e.call(this,i,t.ɵf.ellipse)||this}return z(i,e),i}(tt);nt.decorators=[{type:e.Injectable}],nt.ctorParameters=function(){return[{type:f}]};var ot=function(e){function i(i){return e.call(this,i,t.ɵf.label)||this}return z(i,e),i}(tt);ot.decorators=[{type:e.Injectable}],ot.ctorParameters=function(){return[{type:f}]};var rt=function(e){function i(i){return e.call(this,i,t.ɵf.point)||this}return z(i,e),i}(tt);rt.decorators=[{type:e.Injectable}],rt.ctorParameters=function(){return[{type:f}]};var st=function(e){function i(i){return e.call(this,i,t.ɵf.polygon)||this}return z(i,e),i}(tt);st.decorators=[{type:e.Injectable}],st.ctorParameters=function(){return[{type:f}]};var at=function(e){function i(i){return e.call(this,i,t.ɵf.polyline)||this}return z(i,e),i}(tt);at.decorators=[{type:e.Injectable}],at.ctorParameters=function(){return[{type:f}]};var ct,pt,lt=function(t){function e(e){return t.call(this,Cesium.PolylineCollection,e)||this}return z(e,t),e.prototype.add=function(t){return this._cesiumCollection.add(this.withColorMaterial(t))},e.prototype.update=function(e,i){i.material instanceof Cesium.Color&&(e.material&&e.material.uniforms&&e.material.uniforms.color instanceof Cesium.Color?this.withColorMaterial(i):e.material.uniforms.color.equals(i.material)||(e.material.uniforms.color=i.material)),t.prototype.update.call(this,e,i)},e.prototype.withColorMaterial=function(t){if(t.material instanceof Cesium.Color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.material,t.material=e}return t},e}(Z);lt.decorators=[{type:e.Injectable}],lt.ctorParameters=function(){return[{type:f}]},(ct=t.KeyboardAction||(t.KeyboardAction={}))[ct.CAMERA_FORWARD=0]="CAMERA_FORWARD",ct[ct.CAMERA_BACKWARD=1]="CAMERA_BACKWARD",ct[ct.CAMERA_RIGHT=2]="CAMERA_RIGHT",ct[ct.CAMERA_LEFT=3]="CAMERA_LEFT",ct[ct.CAMERA_UP=4]="CAMERA_UP",ct[ct.CAMERA_DOWN=5]="CAMERA_DOWN",ct[ct.CAMERA_LOOK_RIGHT=6]="CAMERA_LOOK_RIGHT",ct[ct.CAMERA_LOOK_LEFT=7]="CAMERA_LOOK_LEFT",ct[ct.CAMERA_LOOK_UP=8]="CAMERA_LOOK_UP",ct[ct.CAMERA_LOOK_DOWN=9]="CAMERA_LOOK_DOWN",ct[ct.CAMERA_TWIST_RIGHT=10]="CAMERA_TWIST_RIGHT",ct[ct.CAMERA_TWIST_LEFT=11]="CAMERA_TWIST_LEFT",ct[ct.CAMERA_ROTATE_RIGHT=12]="CAMERA_ROTATE_RIGHT",ct[ct.CAMERA_ROTATE_LEFT=13]="CAMERA_ROTATE_LEFT",ct[ct.CAMERA_ROTATE_UP=14]="CAMERA_ROTATE_UP",ct[ct.CAMERA_ROTATE_DOWN=15]="CAMERA_ROTATE_DOWN",ct[ct.CAMERA_ZOOM_IN=16]="CAMERA_ZOOM_IN",ct[ct.CAMERA_ZOOM_OUT=17]="CAMERA_ZOOM_OUT";var dt,ut=100,ht=.01,gt=.01,yt=((pt={})[t.KeyboardAction.CAMERA_FORWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveForward(n)},pt[t.KeyboardAction.CAMERA_BACKWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveBackward(n)},pt[t.KeyboardAction.CAMERA_UP]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveUp(n)},pt[t.KeyboardAction.CAMERA_DOWN]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveDown(n)},pt[t.KeyboardAction.CAMERA_RIGHT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveRight(n)},pt[t.KeyboardAction.CAMERA_LEFT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||ut);i.moveLeft(n)},pt[t.KeyboardAction.CAMERA_LOOK_RIGHT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||ht;i.lookRight(n.latitude*o)},pt[t.KeyboardAction.CAMERA_LOOK_LEFT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||ht;i.lookLeft(n.latitude*o)},pt[t.KeyboardAction.CAMERA_LOOK_UP]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||ht;i.lookUp(n.longitude*(-1*o))},pt[t.KeyboardAction.CAMERA_LOOK_DOWN]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||ht;i.lookDown(n.longitude*(-1*o))},pt[t.KeyboardAction.CAMERA_TWIST_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistRight(n)},pt[t.KeyboardAction.CAMERA_TWIST_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistLeft(n)},pt[t.KeyboardAction.CAMERA_ROTATE_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.angle||gt;i.rotateRight(n)},pt[t.KeyboardAction.CAMERA_ROTATE_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.angle||gt;i.rotateLeft(n)},pt[t.KeyboardAction.CAMERA_ROTATE_UP]=function(t,e){var i=t.getViewer().camera,n=e.angle||gt;i.rotateUp(n)},pt[t.KeyboardAction.CAMERA_ROTATE_DOWN]=function(t,e){var i=t.getViewer().camera,n=e.angle||gt;i.rotateDown(n)},pt[t.KeyboardAction.CAMERA_ZOOM_IN]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomIn(n)},pt[t.KeyboardAction.CAMERA_ZOOM_OUT]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomOut(n)},pt);!function(t){t[t.IGNORED=0]="IGNORED",t[t.NOT_PRESSED=1]="NOT_PRESSED",t[t.PRESSED=2]="PRESSED"}(dt||(dt={}));var ft=function(){function t(t,e,i){this.ngZone=t,this.cesiumService=e,this.document=i,this._currentDefinitions=null,this._activeDefinitions={},this._keyMappingFn=this.defaultKeyMappingFn}return t.prototype.init=function(){var t=this.cesiumService.getCanvas();t.addEventListener("click",(function(){t.focus()})),this.handleKeydown=this.handleKeydown.bind(this),this.handleKeyup=this.handleKeyup.bind(this),this.handleTick=this.handleTick.bind(this)},t.prototype.setKeyboardControls=function(t,e,i){var n=this;if(void 0===i&&(i=!1),!t)return this.removeKeyboardControls();this._currentDefinitions||this.registerEvents(i),this._currentDefinitions=t,this._keyMappingFn=e||this.defaultKeyMappingFn,Object.keys(this._currentDefinitions).forEach((function(t){n._activeDefinitions[t]={state:dt.NOT_PRESSED,action:null,keyboardEvent:null}}))},t.prototype.removeKeyboardControls=function(){this.unregisterEvents(),this._currentDefinitions=null},t.prototype.getAction=function(t){return this._currentDefinitions[t]||null},t.prototype.defaultKeyMappingFn=function(t){return String.fromCharCode(t.keyCode)},t.prototype.handleKeydown=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);if(i&&this._activeDefinitions[e].state!==dt.IGNORED){var n=!0,o=this.getParams(i.params,t);i.validation&&(n=i.validation(this.cesiumService,o,t)),!0===n&&(this._activeDefinitions[e]={state:dt.PRESSED,action:i,keyboardEvent:t})}},t.prototype.handleKeyup=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);i&&(this._activeDefinitions[e]={state:dt.NOT_PRESSED,action:null,keyboardEvent:t},i.done&&"function"==typeof i.done&&i.done(this.cesiumService,t))},t.prototype.handleTick=function(){var t=this;Object.keys(this._activeDefinitions).forEach((function(e){var i=t._activeDefinitions[e];null!==i&&null!==i.action&&i.state===dt.PRESSED&&t.executeAction(i.action,e,i.keyboardEvent)}))},t.prototype.getParams=function(t,e){return t?"function"==typeof t?t(this.cesiumService,e):t:{}},t.prototype.executeAction=function(t,e,i){if(this._currentDefinitions){var n=this.getParams(t.params,i);if(o.isNumber(t.action)){var r=yt[t.action];r&&r(this.cesiumService,n,i)}else if("function"==typeof t.action){!1===t.action(this.cesiumService,n,i)&&(this._activeDefinitions[e]={state:dt.IGNORED,action:null,keyboardEvent:null})}}},t.prototype.registerEvents=function(t){var e=this,i=function(){e.document.addEventListener("keydown",e.handleKeydown),e.document.addEventListener("keyup",e.handleKeyup),e.cesiumService.getViewer().clock.onTick.addEventListener(e.handleTick)};t?this.ngZone.runOutsideAngular(i):i()},t.prototype.unregisterEvents=function(){this.document.removeEventListener("keydown",this.handleKeydown),this.document.removeEventListener("keyup",this.handleKeyup),this.cesiumService.getViewer().clock.onTick.removeEventListener(this.handleTick)},t}();ft.decorators=[{type:e.Injectable}],ft.ctorParameters=function(){return[{type:e.NgZone},{type:f},{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]}]};var mt=function(){function t(t,e){this.event=t,this.modifier=e}return t.prototype.init=function(t){var e=this;return this.observer=s.Observable.create((function(i){t.setInputAction((function(t){t.position&&(t.startPosition=t.position,t.endPosition=t.position),i.next(t)}),e.event,e.modifier)})),this.observer},t}(),vt=function(e){function i(t,i,n){var o=e.call(this,t,i)||this;return o.event=t,o.modifier=i,o.eventFactory=n,o}return z(i,e),i.prototype.init=function(){var e,n;this.event===t.CesiumEvent.LONG_LEFT_PRESS?(e=t.CesiumEvent.LEFT_DOWN,n=t.CesiumEvent.LEFT_UP):this.event===t.CesiumEvent.LONG_RIGHT_PRESS?(e=t.CesiumEvent.RIGHT_DOWN,n=t.CesiumEvent.RIGHT_UP):this.event===t.CesiumEvent.LONG_MIDDLE_PRESS&&(e=t.CesiumEvent.MIDDLE_DOWN,n=t.CesiumEvent.MIDDLE_UP);var o=this.eventFactory.get(e,this.modifier),a=s.merge(this.eventFactory.get(n,this.modifier),this.eventFactory.get(t.CesiumEvent.MOUSE_MOVE,this.modifier));return r.publish()(o.pipe(r.mergeMap((function(t){return s.of(t).pipe(r.delay(i.LONG_PRESS_EVENTS_DURATION),r.takeUntil(a))}))))},i}(mt);vt.LONG_PRESS_EVENTS_DURATION=250;var Et=function(){function t(t){this.cesiumService=t,this.cesiumEventsObservables=new Map}return t.getEventFullName=function(t,e){return e?t+"_"+e:t.toString()},t.prototype.init=function(){this.eventsHandler=this.cesiumService.getViewer().screenSpaceEventHandler},t.prototype.get=function(e,i){var n=t.getEventFullName(e,i);if(this.cesiumEventsObservables.has(n))return this.cesiumEventsObservables.get(n);var o=this.createCesiumEventObservable(e,i);return this.cesiumEventsObservables.set(n,o),o},t.prototype.createCesiumEventObservable=function(e,i){var n;return(n=t.longPressEvents.has(e)?this.createSpecialCesiumEventObservable(e,i):r.publish()(new mt(e,i).init(this.eventsHandler))).connect(),n},t.prototype.createSpecialCesiumEventObservable=function(t,e){return new vt(t,e,this).init()},t}();Et.longPressEvents=new Set([t.CesiumEvent.LONG_LEFT_PRESS,t.CesiumEvent.LONG_RIGHT_PRESS,t.CesiumEvent.LONG_MIDDLE_PRESS]),Et.decorators=[{type:e.Injectable}],Et.ctorParameters=function(){return[{type:f}]};var Pt=function(){function t(){this._entitesToPlonter=[],this._plonterChangeNotifier=new e.EventEmitter,this._plonterObserver=new s.Subject}return Object.defineProperty(t.prototype,"plonterChangeNotifier",{get:function(){return this._plonterChangeNotifier},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"plonterShown",{get:function(){return this._plonterShown},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"entitesToPlonter",{get:function(){return this._entitesToPlonter},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"plonterClickPosition",{get:function(){return this._eventResult.movement},enumerable:!1,configurable:!0}),t.prototype.plonterIt=function(t){return this._eventResult=t,this._entitesToPlonter=t.entities,this._plonterShown=!0,this._plonterChangeNotifier.emit(),this._plonterObserver},t.prototype.resolvePlonter=function(t){this._plonterShown=!1,this._eventResult.entities=[t],this._plonterChangeNotifier.emit(),this._plonterObserver.next(this._eventResult)},t}();Pt.decorators=[{type:e.Injectable}],Pt.ctorParameters=function(){return[]};var bt=function(t){return t.reduce((function(t,e){return t.indexOf(e)<0&&t.push(e),t}),[])},Ct=function(){function e(){}return e.getDragEventTypes=function(e){var i,n;return e===t.CesiumEvent.LEFT_CLICK_DRAG?(i=t.CesiumEvent.LEFT_DOWN,n=t.CesiumEvent.LEFT_UP):e===t.CesiumEvent.RIGHT_CLICK_DRAG?(i=t.CesiumEvent.RIGHT_DOWN,n=t.CesiumEvent.RIGHT_UP):e===t.CesiumEvent.MIDDLE_CLICK_DRAG&&(i=t.CesiumEvent.MIDDLE_DOWN,n=t.CesiumEvent.MIDDLE_UP),{mouseDownEvent:i,mouseUpEvent:n}},e}();Ct.dragEvents=new Set([t.CesiumEvent.LEFT_CLICK_DRAG,t.CesiumEvent.RIGHT_CLICK_DRAG,t.CesiumEvent.MIDDLE_CLICK_DRAG]);var _t=function(t,e,i,n){this.observable=t,this.stopper=e,this.priority=i,this.isPaused=n},Mt=function(){function e(t,e,i){this.cesiumService=t,this.eventBuilder=e,this.plonterService=i,this.eventRegistrations=new Map}return e.prototype.init=function(){this.eventBuilder.init(),this.scene=this.cesiumService.getScene()},e.prototype.register=function(e){var i=this;if(void 0===this.scene)throw new Error("CesiumService has not been initialized yet - MapEventsManagerService must be injected  under ac-map");if(e.pick=e.pick||t.PickOptions.NO_PICK,e.priority=e.priority||0,e.pickConfig=e.pickConfig||{},e.entityType&&e.pick===t.PickOptions.NO_PICK)throw new Error("MapEventsManagerService: can't register an event with entityType and PickOptions.NO_PICK - It doesn't make sense ");var n=Et.getEventFullName(e.event,e.modifier);this.eventRegistrations.has(n)||this.eventRegistrations.set(n,[]);var o=this.createEventRegistration(e),r=o.observable;return r.dispose=function(){return i.disposeObservable(o,n)},this.eventRegistrations.get(n).push(o),this.sortRegistrationsByPriority(n),r},e.prototype.disposeObservable=function(t,e){t.stopper.next(1);var i=this.eventRegistrations.get(e),n=i.indexOf(t);-1!==n&&i.splice(n,1),this.sortRegistrationsByPriority(e)},e.prototype.sortRegistrationsByPriority=function(t){var e=this.eventRegistrations.get(t);if(e.sort((function(t,e){return e.priority-t.priority})),0!==e.length){var i=e[0].priority;e.forEach((function(t){t.isPaused=t.priority<i}))}},e.prototype.createEventRegistration=function(t){var e,i=this,n=t.event,o=t.modifier,a=t.entityType,c=t.pick,p=t.priority,l=t.pickFilter,d=t.pickConfig,u=this.eventBuilder.get(n,o),h=new s.Subject,g=new _t(void 0,h,p,!1);return e=Ct.dragEvents.has(n)?this.createDragEvent({event:n,modifier:o,entityType:a,pick:c,priority:p,pickFilter:l,pickConfig:d}).pipe(r.takeUntil(h)):u.pipe(r.filter((function(){return!g.isPaused})),r.map((function(t){return i.triggerPick(t,c,d)})),r.filter((function(t){return null!==t.cesiumEntities||void 0===a})),r.map((function(t){return i.addEntities(t,a,c,l)})),r.filter((function(t){return null!==t.entities||void 0===a&&!l})),r.switchMap((function(t){return i.plonter(t,c)})),r.takeUntil(h)),g.observable=e,g},e.prototype.createDragEvent=function(e){var i=e.event,n=e.modifier,o=e.entityType,a=e.pick,c=e.priority,p=e.pickFilter,l=e.pickConfig,d=Ct.getDragEventTypes(i),u=d.mouseDownEvent,h=d.mouseUpEvent,g=this.eventBuilder.get(h),y=this.eventBuilder.get(t.CesiumEvent.MOUSE_MOVE),f=this.createEventRegistration({event:u,modifier:n,entityType:o,pick:a,priority:c,pickFilter:p,pickConfig:l}),m=new s.Subject,v=f.observable.pipe(r.mergeMap((function(t){var e=null,i=t.movement.startPosition.x,n=t.movement.startPosition.y;return y.pipe(r.map((function(o){return e={movement:{drop:!1,startPosition:{x:i,y:n},endPosition:o.endPosition},entities:t.entities,cesiumEntities:t.cesiumEntities}})),r.takeUntil(g),r.tap({complete:function(){if(e){var t=Object.assign({},e);t.movement.drop=!0,m.next(t)}}}))})));return s.merge(v,m)},e.prototype.triggerPick=function(e,i,n){var o=[];switch(i){case t.PickOptions.PICK_ONE:case t.PickOptions.PICK_ALL:o=0===(o=this.scene.drillPick(e.endPosition,n.drillPickLimit,n.pickWidth,n.pickHeight)).length?null:o;break;case t.PickOptions.PICK_FIRST:var r=this.scene.pick(e.endPosition,n.pickWidth,n.pickHeight);o=void 0===r?null:[r];break;case t.PickOptions.NO_PICK:}return o&&(o=o.map((function(t){return t.id&&t.id instanceof Cesium.Entity?t.id:t.primitive}))),{movement:e,cesiumEntities:o}},e.prototype.addEntities=function(e,i,n,o){if(null===e.cesiumEntities)return e.entities=null,e;var r=[];return n!==t.PickOptions.NO_PICK&&(r=i?e.cesiumEntities.map((function(t){return t.acEntity})).filter((function(t){return t&&t instanceof i})):e.cesiumEntities.map((function(t){return t.acEntity})),r=bt(r),0===(r=o&&r?r.filter(o):r).length&&(r=null)),e.entities=r,e},e.prototype.plonter=function(e,i){return i===t.PickOptions.PICK_ONE&&null!==e.entities&&e.entities.length>1?this.plonterService.plonterIt(e):s.of(e)},e}();Mt.decorators=[{type:e.Injectable}],Mt.ctorParameters=function(){return[{type:f},{type:Et},{type:Pt}]};var St=function(){function t(t){this.cesiumService=t,this.layersDataSources=[]}return t.prototype.registerLayerDataSources=function(t,e){var i=this;t.forEach((function(t){t.zIndex=e,i.layersDataSources.push(t)}))},t.prototype.drawAllLayers=function(){var t=this;this.layersDataSources.sort((function(t,e){return t.zIndex-e.zIndex})),this.layersDataSources.forEach((function(e){t.cesiumService.getViewer().dataSources.add(e)}))},t.prototype.updateAndRefresh=function(t,e){var i=this;t&&t.length&&(t.forEach((function(t){var n=i.layersDataSources.indexOf(t);-1!==n&&(i.layersDataSources[n].zIndex=e)})),this.cesiumService.getViewer().dataSources.removeAll(),this.drawAllLayers())},t.prototype.removeDataSources=function(t){var e=this;t.forEach((function(t){var i=e.layersDataSources.indexOf(t);-1!==i&&(e.layersDataSources.splice(i,1),e.cesiumService.getViewer().dataSources.remove(t,!0))}))},t}();St.decorators=[{type:e.Injectable}],St.ctorParameters=function(){return[{type:f}]};var Tt=function(){function t(){this.defaultIdCounter=0,this._Maps=new Map,this.eventRemoveCallbacks=[]}return t.prototype.getMap=function(t){return t?this._Maps.get(t):this.firstMap},t.prototype._registerMap=function(t,e){this.firstMap||(this.firstMap=e);var i=t||this.generateDefaultId();if(this._Maps.has(i))throw new Error("Map with id: "+i+" already exist");return this._Maps.set(i,e),i},t.prototype._removeMapById=function(t){if(this._Maps.has(t)&&this._Maps.get(t)===this.firstMap){var e=this._Maps.values();e.next(),this.firstMap=e.next().value}return this._Maps.delete(t)},t.prototype.generateDefaultId=function(){return this.defaultIdCounter++,"default-map-id-"+this.defaultIdCounter},t.prototype.sync2DMapsCameras=function(t){var e=this;this.unsyncMapsCameras();var i=t.map((function(t){var i=e.getMap(t.id);if(!i)throw new Error("Couldn't find map with id: "+t.id);return{map:i,options:{sensitivity:t.sensitivity,bindZoom:t.bindZoom}}}));i.forEach((function(t){var n=t.map,o=t.options,r=n.getCameraService().getCamera(),s=r.positionCartographic;r.percentageChanged=o.sensitivity||.01;var a=r.changed.addEventListener((function(){i.forEach((function(t){var e=t.map,i=t.options;if(e!==n){var o=e.getCameraService().getCamera(),r=o.positionCartographic,a=Cesium.Ellipsoid.WGS84.cartographicToCartesian({longitude:s.longitude,latitude:s.latitude,height:i.bindZoom?s.height:r.height});e.getCesiumViewer().scene.mode!==Cesium.SceneMode.MORPHING&&o.setView({destination:a,orientation:{heading:o.heading,pitch:o.pitch}})}}))}));e.eventRemoveCallbacks.push(a)}))},t.prototype.unsyncMapsCameras=function(){this.eventRemoveCallbacks.forEach((function(t){return t()})),this.eventRemoveCallbacks=[]},t}();Tt.decorators=[{type:e.Injectable}],Tt.ctorParameters=function(){return[]};var At=function(){function t(t){this.cesiumService=t}return t.prototype.getMapScreenshotDataUrlBase64=function(){return this.cesiumService.getCanvas().toDataURL()},t.prototype.downloadMapScreenshot=function(t){void 0===t&&(t="map.png");var e=this.getMapScreenshotDataUrlBase64();this.downloadURI(e,t)},t.prototype.downloadURI=function(t,e){var i=document.createElement("a");i.download=e,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)},t}();At.decorators=[{type:e.Injectable}],At.ctorParameters=function(){return[{type:f}]};var Ot=function(){function t(t,e,i,n,o,r,s,a,c,p,l,d,u,h,g,y,f,m,v,E){this._cesiumService=t,this._cameraService=e,this._elemRef=i,this.document=n,this.mapsManagerService=o,this.billboardDrawerService=r,this.labelDrawerService=s,this.ellipseDrawerService=a,this.polylineDrawerService=c,this.polygonDrawerService=p,this.arcDrawerService=l,this.pointDrawerService=d,this.czmlDrawerService=u,this.mapEventsManager=h,this.keyboardControlService=g,this.mapLayersService=y,this.configurationService=f,this.screenshotService=m,this.contextMenuService=v,this.coordinateConverter=E,this.disableDefaultPlonter=!1,this.mapContainer=this.document.createElement("div"),this.mapContainer.style.width="100%",this.mapContainer.style.height="100%",this.mapContainer.className="map-container",this._cesiumService.init(this.mapContainer,this),this._cameraService.init(this._cesiumService),this.mapEventsManager.init(),this.billboardDrawerService.init(),this.labelDrawerService.init(),this.ellipseDrawerService.init(),this.polylineDrawerService.init(),this.polygonDrawerService.init(),this.arcDrawerService.init(),this.pointDrawerService.init(),this.czmlDrawerService.init(),this.keyboardControlService.init(),this.contextMenuService.init(this.mapEventsManager)}return t.prototype.ngOnInit=function(){this.mapId=this.mapsManagerService._registerMap(this.mapId,this),this.containerId||this._elemRef.nativeElement.appendChild(this.mapContainer)},t.prototype.ngOnChanges=function(t){if(t.sceneMode&&this._cameraService.setSceneMode(t.sceneMode.currentValue),t.flyTo&&this._cameraService.cameraFlyTo(t.flyTo.currentValue),t.containerId&&!t.containerId.firstChange){var e=this.document.getElementById(t.containerId.currentValue);if(!e)throw new Error("No element found with id: "+t.containerId.currentValue);e.appendChild(this.mapContainer)}},t.prototype.ngAfterViewInit=function(){var t=this;this.mapLayersService.drawAllLayers(),this.containerId&&setTimeout((function(){var e=t.document.getElementById(t.containerId);if(!e)throw new Error("No element found with id: "+t.containerId);e.appendChild(t.mapContainer)}),0)},t.prototype.ngOnDestroy=function(){this.getCesiumViewer().destroy(),this.mapContainer.remove(),this.mapsManagerService._removeMapById(this.mapId)},t.prototype.getCesiumService=function(){return this._cesiumService},t.prototype.getCesiumViewer=function(){return this._cesiumService.getViewer()},t.prototype.getCameraService=function(){return this._cameraService},t.prototype.getId=function(){return this.mapId},t.prototype.getMapContainer=function(){return this.mapContainer},t.prototype.getMapEventsManager=function(){return this.mapEventsManager},t.prototype.getContextMenuService=function(){return this.contextMenuService},t.prototype.getScreenshotService=function(){return this.screenshotService},t.prototype.getKeyboardControlService=function(){return this.keyboardControlService},t.prototype.getCoordinateConverter=function(){return this.coordinateConverter},t}();Ot.decorators=[{type:e.Component,args:[{selector:"ac-map",template:'\n    <ac-default-plonter *ngIf="!disableDefaultPlonter"></ac-default-plonter>\n    <ac-context-menu-wrapper></ac-context-menu-wrapper>\n    <ng-content></ng-content>\n  ',providers:[f,et,Et,ft,Mt,Pt,ot,at,lt,nt,rt,J,it,st,St,V,At,B,G]}]}],Ot.ctorParameters=function(){return[{type:f},{type:V},{type:e.ElementRef},{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]},{type:Tt},{type:et},{type:ot},{type:nt},{type:at},{type:st},{type:J},{type:rt},{type:it},{type:Mt},{type:ft},{type:St},{type:N},{type:At},{type:B},{type:G}]},Ot.propDecorators={disableDefaultPlonter:[{type:e.Input}],mapId:[{type:e.Input}],flyTo:[{type:e.Input}],sceneMode:[{type:e.Input}],containerId:[{type:e.Input}]};var It,Dt=function(){function t(){this._cache=!0,this.descriptions=[],this.layerUpdate=new e.EventEmitter}return Object.defineProperty(t.prototype,"cache",{get:function(){return this._cache},set:function(t){this._cache=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&this.layerUpdate.emit(),this._zIndex=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){t!==this._show&&this.layerUpdate.emit(),this._show=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},set:function(t){this._options=t,this.layerUpdate.emit()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.layerUpdate.emit()},enumerable:!1,configurable:!0}),t.prototype.setEntityName=function(t){this._entityName=t},t.prototype.getEntityName=function(){return this._entityName},t.prototype.registerDescription=function(t){this.descriptions.indexOf(t)<0&&this.descriptions.push(t)},t.prototype.unregisterDescription=function(t){var e=this.descriptions.indexOf(t);e>-1&&this.descriptions.splice(e,1)},t.prototype.getDescriptions=function(){return this.descriptions},t.prototype.layerUpdates=function(){return this.layerUpdate},t}();Dt.decorators=[{type:e.Injectable}],(It=t.ActionType||(t.ActionType={}))[It.ADD_UPDATE=0]="ADD_UPDATE",It[It.DELETE=1]="DELETE";var Lt=function(){function t(){this._cache=new Map}return t.prototype.get=function(t,e){if(this._cache.has(t))return this._cache.get(t);var i=e();return this._cache.set(t,i),i},t.prototype.clear=function(){this._cache.clear()},t}();Lt.decorators=[{type:e.Injectable}];var wt=function(){function t(){}return t.throwIfAnyNotPresent=function(e,i){i.forEach((function(i){return t.throwIfNotPresent(e,i)}))},t.throwIfNotPresent=function(e,i){if(!t.present(e[i]))throw new Error("Error: "+i+" was not given.")},t.present=function(t){return null!=t},t}(),Rt=function(t){function e(e){return t.call(this,Cesium.PrimitiveCollection,e)||this}return z(e,t),e.prototype.add=function(e){return wt.throwIfAnyNotPresent(e,["center","semiMajorAxis","semiMinorAxis"]),t.prototype.add.call(this,new a.EllipsePrimitive(e))},e.prototype.update=function(t,e){return t.updateLocationData(e),t},e}(Z);Rt.decorators=[{type:e.Injectable}],Rt.ctorParameters=function(){return[{type:f}]};var xt=function(t){function e(e){return t.call(this,Cesium.PolylineCollection,e)||this}return z(e,t),e}(Z);xt.decorators=[{type:e.Injectable}],xt.ctorParameters=function(){return[{type:f}]};var jt=function(t){function e(e,i){var n=t.call(this,Cesium.PrimitiveCollection,i)||this;return n.geometryType=e,n}return z(e,t),e.prototype.add=function(e,i,n){if(0===Object.keys(i).length)throw new Error("instanceProps object is empty");i.geometry=new this.geometryType(e),n.geometryInstances=new Cesium.GeometryInstance(i),n.asynchronous=!1;var o=new Cesium.Primitive(n);return t.prototype.add.call(this,o)},e.prototype.update=function(e,i,n,o){return n.geometry=new this.geometryType(i),o.geometryInstances=new Cesium.GeometryInstance(n),this._cesiumCollection.remove(e),t.prototype.add.call(this,new Cesium.Primitive(o))},e}(Z),kt=function(t){function e(e){return t.call(this,Cesium.CircleGeometry,e)||this}return z(e,t),e}(jt);kt.decorators=[{type:e.Injectable}],kt.ctorParameters=function(){return[{type:f}]};var Nt=function(t){function e(e){return t.call(this,Cesium.PolylineGeometry,e)||this}return z(e,t),e.prototype.update=function(t,e,i,n){var o=i.attributes.color.value;return t.ready?t.getGeometryInstanceAttributes().color=o:Cesium.when(t.readyPromise).then((function(t){t.getGeometryInstanceAttributes().color.value=o})),t},e}(jt);Nt.decorators=[{type:e.Injectable}],Nt.ctorParameters=function(){return[{type:f}]};var Ft=function(t){function e(e){return t.call(this,Cesium.PolygonGeometry,e)||this}return z(e,t),e}(jt);Ft.decorators=[{type:e.Injectable}],Ft.ctorParameters=function(){return[{type:f}]};var Ht=function(t){function e(e){return t.call(this,Cesium.EllipseGeometry,e)||this}return z(e,t),e}(jt);Ht.decorators=[{type:e.Injectable}],Ht.ctorParameters=function(){return[{type:f}]};var Vt=function(e){function i(i){return e.call(this,i,t.ɵf.model)||this}return z(i,e),i}(tt);Vt.decorators=[{type:e.Injectable}],Vt.ctorParameters=function(){return[{type:f}]};var Bt=function(e){function i(i){return e.call(this,i,t.ɵf.box)||this}return z(i,e),i}(tt);Bt.decorators=[{type:e.Injectable}],Bt.ctorParameters=function(){return[{type:f}]};var Ut=function(e){function i(i){return e.call(this,i,t.ɵf.corridor)||this}return z(i,e),i}(tt);Ut.decorators=[{type:e.Injectable}],Ut.ctorParameters=function(){return[{type:f}]};var Gt=function(e){function i(i){return e.call(this,i,t.ɵf.cylinder)||this}return z(i,e),i}(tt);Gt.decorators=[{type:e.Injectable}],Gt.ctorParameters=function(){return[{type:f}]};var Kt=function(e){function i(i){return e.call(this,i,t.ɵf.ellipsoid)||this}return z(i,e),i}(tt);Kt.decorators=[{type:e.Injectable}],Kt.ctorParameters=function(){return[{type:f}]};var zt=function(e){function i(i){return e.call(this,i,t.ɵf.polylineVolume)||this}return z(i,e),i}(tt);zt.decorators=[{type:e.Injectable}],zt.ctorParameters=function(){return[{type:f}]};var Wt=function(e){function i(i){return e.call(this,i,t.ɵf.wall)||this}return z(i,e),i}(tt);Wt.decorators=[{type:e.Injectable}],Wt.ctorParameters=function(){return[{type:f}]};var $t=function(e){function i(i){return e.call(this,i,t.ɵf.rectangle)||this}return z(i,e),i}(tt);$t.decorators=[{type:e.Injectable}],$t.ctorParameters=function(){return[{type:f}]};var Yt=function(t){function e(e){return t.call(this,Cesium.LabelCollection,e)||this}return z(e,t),e}(Z);Yt.decorators=[{type:e.Injectable}],Yt.ctorParameters=function(){return[{type:f}]};var Zt=function(t){function e(e){return t.call(this,Cesium.BillboardCollection,e)||this}return z(e,t),e}(Z);Zt.decorators=[{type:e.Injectable}],Zt.ctorParameters=function(){return[{type:f}]};var qt=function(t){function e(e){return t.call(this,Cesium.PointPrimitiveCollection,e)||this}return z(e,t),e}(Z);qt.decorators=[{type:e.Injectable}],qt.ctorParameters=function(){return[{type:f}]};var Xt=function(t){function e(e){var i=t.call(this,Cesium.HtmlCollection,e)||this;return i._cesiumService=e,i}return z(e,t),e.prototype.add=function(e){return e.scene=this._cesiumService.getScene(),e.mapContainer=this._cesiumService.getMap().getMapContainer(),t.prototype.add.call(this,e)},e}(Z);Xt.decorators=[{type:e.Injectable}],Xt.ctorParameters=function(){return[{type:f}]};var Jt=function(){function e(t,e,i,n,o,r,a,c,p,l,d,u,h,g,y,f,m,v,E,P,b,C,_,M,S,T,A,O,I,D){this.layerService=t,this._computationCache=e,this.mapLayersService=i,this.show=!0,this.store=!1,this.zIndex=0,this.debug=!1,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.stopObservable=new s.Subject,this._updateStream=new s.Subject,this.entitiesStore=new Map,this.layerDrawerDataSources=[],this._drawerList=new Map([["billboard",n],["label",o],["ellipse",r],["polyline",a],["polygon",c],["arc",p],["point",l],["model",d],["box",u],["corridor",h],["cylinder",g],["ellipsoid",y],["polylineVolume",f],["rectangle",v],["wall",m],["polylinePrimitive",S],["labelPrimitive",T],["billboardPrimitive",A],["pointPrimitive",O],["html",I],["czml",D],["dynamicEllipse",E],["dynamicPolyline",P],["staticCircle",b],["staticPolyline",C],["staticPolygon",_],["staticEllipse",M]])}return e.prototype.init=function(){var e=this;this.initValidParams(),s.merge(this._updateStream,this.observable).pipe(r.takeUntil(this.stopObservable)).subscribe((function(i){e._computationCache.clear(),e.debug&&console.log("AcLayer received notification:",i);var n=i.entity;e.store&&(n=e.updateStore(i)),e.context[e.entityName]=n,e.layerService.getDescriptions().forEach((function(o){switch(i.actionType){case t.ActionType.ADD_UPDATE:o.draw(e.context,i.id,n);break;case t.ActionType.DELETE:o.remove(i.id);break;default:console.error("[ac-layer] unknown AcNotification.actionType for notification: "+i)}}))}))},e.prototype.updateStore=function(e){if(e.actionType!==t.ActionType.DELETE){if(this.entitiesStore.has(e.id)){var i=this.entitiesStore.get(e.id);return Object.assign(i,e.entity),i}return this.entitiesStore.set(e.id,e.entity),e.entity}this.entitiesStore.delete(e.id)},e.prototype.initValidParams=function(){if(!this.context)throw new Error("ac-layer: must initialize [context] ");if(!this.acForRgx.test(this.acFor))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+this.acFor);var t=this.acFor.split(" ");if(this.observable=this.context[t[3]],this.entityName=t[1],!this.isObservable(this.observable))throw new Error("ac-layer: must initailize [acFor] with rx observable, instead received: "+this.observable);this.layerService.context=this.context,this.layerService.setEntityName(this.entityName)},e.prototype.isObservable=function(t){return t&&"function"==typeof t.subscribe},e.prototype.ngAfterContentInit=function(){this.init()},e.prototype.ngOnInit=function(){var t=this;this.layerService.context=this.context,this.layerService.options=this.options,this.layerService.show=this.show,this.layerService.zIndex=this.zIndex,this._drawerList.forEach((function(e,i){var n,o=t.options?t.options[i]:void 0,r=e.init(o);r&&(n=t.layerDrawerDataSources).push.apply(n,$(r)),e.setShow(t.show)}))},e.prototype.ngOnChanges=function(t){if(t.show&&!t.show.firstChange){var e=t.show.currentValue;this.layerService.show=e,this._drawerList.forEach((function(t){return t.setShow(e)}))}if(t.zIndex&&!t.zIndex.firstChange){var i=t.zIndex.currentValue;this.layerService.zIndex=i,this.mapLayersService.updateAndRefresh(this.layerDrawerDataSources,i)}},e.prototype.ngOnDestroy=function(){this.mapLayersService.removeDataSources(this.layerDrawerDataSources),this.stopObservable.next(!0),this.removeAll()},e.prototype.getLayerService=function(){return this.layerService},e.prototype.getLayerDrawerDataSources=function(){return this.layerDrawerDataSources},e.prototype.getDrawerDataSourcesByName=function(t){return this.layerDrawerDataSources.filter((function(e){return e.name===t}))},e.prototype.getStore=function(){return this.entitiesStore},e.prototype.removeAll=function(){this.layerService.getDescriptions().forEach((function(t){return t.removeAll()})),this.entitiesStore.clear()},e.prototype.remove=function(e){this._updateStream.next({id:e,actionType:t.ActionType.DELETE}),this.entitiesStore.delete(e)},e.prototype.updateNotification=function(t){this._updateStream.next(t)},e.prototype.update=function(e,i){this._updateStream.next({entity:e,id:i,actionType:t.ActionType.ADD_UPDATE})},e.prototype.refreshAll=function(t){var e=this;s.from(t).subscribe((function(t){return e._updateStream.next(t)}))},e}();Jt.decorators=[{type:e.Component,args:[{selector:"ac-layer",template:"<ng-content></ng-content>",providers:[Dt,Lt,et,ot,nt,at,J,rt,st,Vt,Bt,Ut,Gt,Kt,zt,Wt,$t,lt,Yt,Zt,qt,Xt,it,Rt,xt,kt,Nt,Ft,Ht],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Jt.ctorParameters=function(){return[{type:Dt},{type:Lt},{type:St},{type:et},{type:ot},{type:nt},{type:at},{type:st},{type:J},{type:rt},{type:Vt},{type:Bt},{type:Ut},{type:Gt},{type:Kt},{type:zt},{type:Wt},{type:$t},{type:Rt},{type:xt},{type:kt},{type:Nt},{type:Ft},{type:Ht},{type:lt},{type:Yt},{type:Zt},{type:qt},{type:Xt},{type:it}]},Jt.propDecorators={show:[{type:e.Input}],acFor:[{type:e.Input}],context:[{type:e.Input}],store:[{type:e.Input}],options:[{type:e.Input}],zIndex:[{type:e.Input}],debug:[{type:e.Input}]};var Qt=function(){function t(t,e){this._drawer=t,this.mapLayers=e}return t.prototype.ngOnInit=function(){this.selfPrimitiveIsDraw=!1;var t=this._drawer.init();t&&(this.dataSources=t),this.drawOnMap()},t.prototype.ngOnChanges=function(t){var e=t.props;e.currentValue!==e.previousValue&&this.updateOnMap()},t.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.props)},t.prototype.removeFromMap=function(){return this.selfPrimitiveIsDraw=!1,this._drawer.remove(this.selfPrimitive)},t.prototype.updateOnMap=function(){if(this.selfPrimitiveIsDraw)return this._drawer.update(this.selfPrimitive,this.props)},t.prototype.ngOnDestroy=function(){this.mapLayers.removeDataSources(this.dataSources),this.removeFromMap()},t}();Qt.decorators=[{type:e.Directive}],Qt.ctorParameters=function(){return[{type:Y},{type:St}]},Qt.propDecorators={props:[{type:e.Input}]};var te=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);te.decorators=[{type:e.Component,args:[{selector:"ac-billboard",template:""}]}],te.ctorParameters=function(){return[{type:et},{type:St}]};var ee=function(){function t(){this._mapper=new c.JsonStringMapper}return t.prototype.map=function(t){return this._mapper.map(t)},t}();ee.decorators=[{type:e.Injectable}],ee.ctorParameters=function(){return[]};var ie=function(){function t(){}return t.create=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=!0);var i="";t.forEach((function(t){i+=e?"if(!(obj1['"+t+"'] instanceof Cesium.CallbackProperty))obj1['"+t+"'] = obj2['"+t+"']; ":"if (!(obj1['"+t+"'] instanceof Cesium.CallbackProperty) && obj2['"+t+"'] !== undefined) { obj1['"+t+"'] = obj2['"+t+"']; } "})),i+="return obj1";var n=new Function("obj1","obj2",i);return function(t,e){return n(t,e)}},t}(),ne=function(){function t(t,e){this._parser=t,this._jsonMapper=e,this._assignersCache=new Map,this._evaluatorsCache=new Map}return t.prototype._compile=function(t,e){var i=this;void 0===e&&(e=!0);var n={},o=new Map;this._jsonMapper.map(t).forEach((function(t,e){return o.set(e,{expression:t,get:i._parser.eval(t)})})),o.forEach((function(t,i){n[i||"undefined"]=e?"cache.get(`"+t.expression+"`, () => propsMap.get('"+i+"').get(context))":"propsMap.get('"+i+"').get(context)"}));var r="return "+JSON.stringify(n).replace(/"/g,"")+";",s=new Function("propsMap","cache","context",r);return function(t,e){return s(o,t,e)}},t.prototype._build=function(t){var e=Array.from(this._jsonMapper.map(t).keys()),i=ie.create(e);return function(t,e){return i(t,e)}},t.prototype.createEvaluator=function(t,e,i){if(void 0===e&&(e=!0),void 0===i&&(i=!1),!i&&this._evaluatorsCache.has(t))return this._evaluatorsCache.get(t);var n=this._compile(t,e);return this._evaluatorsCache.set(t,n),n},t.prototype.createAssigner=function(t){if(this._assignersCache.has(t))return this._assignersCache.get(t);var e=this._build(t);return this._assignersCache.set(t,e),e},t}();ne.decorators=[{type:e.Injectable}],ne.ctorParameters=function(){return[{type:p.Parse},{type:ee}]};var oe=function(){function t(t,i,n,o){this._drawer=t,this._layerService=i,this._computationCache=n,this._cesiumProperties=o,this.onDraw=new e.EventEmitter,this.onRemove=new e.EventEmitter,this._cesiumObjectsMap=new Map}return t.prototype._propsEvaluator=function(t){return this._propsEvaluateFn(this._computationCache,t)},t.prototype._getPropsAssigner=function(){var t=this;return function(e,i){return t._propsAssignerFn(e,i)}},t.prototype.getLayerService=function(){return this._layerService},t.prototype.setLayerService=function(t){this._layerService.unregisterDescription(this),this._layerService=t,this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache,!0),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.ngOnInit=function(){this.props||console.error("ac-desc components error: [props] input is mandatory"),this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.getCesiumObjectsMap=function(){return this._cesiumObjectsMap},t.prototype.draw=function(t,e,i){var n=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){o=this._cesiumObjectsMap.get(e);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._drawer.setPropsAssigner(this._getPropsAssigner()),this._drawer.update(o,n)}else{var o=this._drawer.add(n);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._cesiumObjectsMap.set(e,o)}},t.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);e&&(this.onRemove.emit({acEntity:e.acEntity,cesiumEntity:e,entityId:t}),this._drawer.remove(e),this._cesiumObjectsMap.delete(t))},t.prototype.removeAll=function(){this._cesiumObjectsMap.clear(),this._drawer.removeAll()},t.prototype.ngOnDestroy=function(){this._layerService.unregisterDescription(this),this.removeAll()},t}();oe.decorators=[{type:e.Directive}],oe.ctorParameters=function(){return[{type:Y},{type:Dt},{type:Lt},{type:ne}]},oe.propDecorators={props:[{type:e.Input}],onDraw:[{type:e.Output}],onRemove:[{type:e.Output}]};var re=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);re.decorators=[{type:e.Component,args:[{selector:"ac-billboard-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return re}))}]}]}],re.ctorParameters=function(){return[{type:et},{type:Dt},{type:Lt},{type:ne}]};var se=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);se.decorators=[{type:e.Component,args:[{selector:"ac-ellipse-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return se}))}]}]}],se.ctorParameters=function(){return[{type:nt},{type:Dt},{type:Lt},{type:ne}]};var ae=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);ae.decorators=[{type:e.Component,args:[{selector:"ac-polyline-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return ae}))}]}]}],ae.ctorParameters=function(){return[{type:at},{type:Dt},{type:Lt},{type:ne}]};var ce=function(){function t(){}return t.prototype.transform=function(t,e){return new Cesium.Cartesian2(t[0],t[1])},t}();ce.decorators=[{type:e.Pipe,args:[{name:"pixelOffset"}]}];var pe=function(){function t(){}return t.prototype.transform=function(t,e){return(360-Math.round(180*t/Math.PI))%360},t}();pe.decorators=[{type:e.Pipe,args:[{name:"radiansToDegrees"}]}];var le=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);le.decorators=[{type:e.Component,args:[{selector:"ac-label-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return le}))}]}]}],le.ctorParameters=function(){return[{type:ot},{type:Dt},{type:Lt},{type:ne}]};var de=function(){};de.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule],providers:[]}]}];var ue=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e.prototype._propsEvaluator=function(e){var i=t.prototype._propsEvaluator.call(this,e);return i.semiMajorAxis=i.radius,i.semiMinorAxis=i.radius,delete i.radius,i},e.prototype._getPropsAssigner=function(){return function(t,e){return Object.assign(t,e)}},e}(oe);ue.decorators=[{type:e.Component,args:[{selector:"ac-circle-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return ue}))}]}]}],ue.ctorParameters=function(){return[{type:nt},{type:Dt},{type:Lt},{type:ne}]};var he=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);he.decorators=[{type:e.Component,args:[{selector:"ac-arc-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return he}))}]}]}],he.ctorParameters=function(){return[{type:J},{type:Dt},{type:Lt},{type:ne}]};var ge,ye,fe=function(){function t(t){Object.assign(this,t)}return t.create=function(e){return e?Object.assign(new t,e):new t},t}(),me=function(){};(ge=t.MapLayerProviderOptions||(t.MapLayerProviderOptions={}))[ge.ArcGisMapServer=Cesium.ArcGisMapServerImageryProvider]="ArcGisMapServer",ge[ge.WebMapTileService=Cesium.WebMapTileServiceImageryProvider]="WebMapTileService",ge[ge.MapTileService=Cesium.TileMapServiceImageryProvider]="MapTileService",ge[ge.WebMapService=Cesium.WebMapServiceImageryProvider]="WebMapService",ge[ge.SingleTileImagery=Cesium.SingleTileImageryProvider]="SingleTileImagery",ge[ge.OpenStreetMap=Cesium.OpenStreetMapImageryProvider]="OpenStreetMap",ge[ge.BingMaps=Cesium.BingMapsImageryProvider]="BingMaps",ge[ge.GoogleEarthEnterpriseMaps=Cesium.GoogleEarthEnterpriseMapsProvider]="GoogleEarthEnterpriseMaps",ge[ge.MapBox=Cesium.MapboxImageryProvider]="MapBox",ge[ge.MapboxStyleImageryProvider=Cesium.MapboxStyleImageryProvider]="MapboxStyleImageryProvider",ge[ge.UrlTemplateImagery=Cesium.UrlTemplateImageryProvider]="UrlTemplateImagery",ge[ge.OFFLINE=null]="OFFLINE",(ye=t.MapTerrainProviderOptions||(t.MapTerrainProviderOptions={}))[ye.CesiumTerrain=Cesium.CesiumTerrainProvider]="CesiumTerrain",ye[ye.ArcGISTiledElevation=Cesium.ArcGISTiledElevationTerrainProvider]="ArcGISTiledElevation",ye[ye.GoogleEarthEnterprise=Cesium.GoogleEarthEnterpriseTerrainProvider]="GoogleEarthEnterprise",ye[ye.VRTheWorld=Cesium.VRTheWorldTerrainProvider]="VRTheWorld",ye[ye.Ellipsoid=Cesium.EllipsoidTerrainProvider]="Ellipsoid",ye[ye.WorldTerrain=Cesium.createWorldTerrain]="WorldTerrain";var ve=function(){function e(e){this.cesiumService=e,this.options={},this.provider=t.MapLayerProviderOptions.OFFLINE,this.show=!0,this.alpha=1,this.brightness=1,this.contrast=1,this.imageryLayersCollection=this.cesiumService.getScene().imageryLayers}return e.prototype.createOfflineMapProvider=function(){return Cesium.createTileMapServiceImageryProvider({url:Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII")})},e.prototype.ngOnInit=function(){if(!wt.present(this.options.url)&&this.provider!==t.MapLayerProviderOptions.OFFLINE)throw new Error("options must have a url");switch(this.provider){case t.MapLayerProviderOptions.WebMapService:case t.MapLayerProviderOptions.WebMapTileService:case t.MapLayerProviderOptions.ArcGisMapServer:case t.MapLayerProviderOptions.SingleTileImagery:case t.MapLayerProviderOptions.BingMaps:case t.MapLayerProviderOptions.GoogleEarthEnterpriseMaps:case t.MapLayerProviderOptions.MapBox:case t.MapLayerProviderOptions.MapboxStyleImageryProvider:case t.MapLayerProviderOptions.UrlTemplateImagery:case t.MapLayerProviderOptions.MapTileService:case t.MapLayerProviderOptions.OpenStreetMap:this.layerProvider=new this.provider(this.options);break;case t.MapLayerProviderOptions.OFFLINE:this.layerProvider=this.createOfflineMapProvider();break;default:console.log("ac-map-layer-provider: [provider] wasn't found. setting OFFLINE provider as default"),this.layerProvider=this.createOfflineMapProvider()}this.show&&(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness)},e.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.imageryLayer?this.imageryLayersCollection.add(this.imageryLayer,this.index):(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness):this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!1));t.alpha&&!t.alpha.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.alpha=this.alpha),t.contrast&&!t.contrast.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.contrast=this.contrast),t.brightness&&!t.brightness.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.brightness=this.brightness)},e.prototype.ngOnDestroy=function(){this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!0)},e}();ve.decorators=[{type:e.Component,args:[{selector:"ac-map-layer-provider",template:""}]}],ve.ctorParameters=function(){return[{type:f}]},ve.propDecorators={options:[{type:e.Input}],provider:[{type:e.Input}],index:[{type:e.Input}],show:[{type:e.Input}],alpha:[{type:e.Input}],brightness:[{type:e.Input}],contrast:[{type:e.Input}]};var Ee=function(){function e(t){this.cesiumService=t,this.options={},this.show=!0}return e.prototype.ngOnInit=function(){if(!wt.present(this.options.url)&&this.provider!==t.MapTerrainProviderOptions.Ellipsoid&&this.provider!==t.MapTerrainProviderOptions.WorldTerrain)throw new Error("options must have a url");switch(this.defaultTerrainProvider=this.cesiumService.getViewer().terrainProvider,this.provider){case t.MapTerrainProviderOptions.CesiumTerrain:case t.MapTerrainProviderOptions.ArcGISTiledElevation:case t.MapTerrainProviderOptions.GoogleEarthEnterprise:case t.MapTerrainProviderOptions.VRTheWorld:case t.MapTerrainProviderOptions.Ellipsoid:this.terrainProvider=new this.provider(this.options);break;case t.MapTerrainProviderOptions.WorldTerrain:this.terrainProvider=this.provider(this.options);break;default:console.log("ac-map-terrain-provider: [provider] wasn't found. setting OFFLINE provider as default"),this.terrainProvider=this.defaultTerrainProvider}this.show&&(this.cesiumService.getViewer().terrainProvider=this.terrainProvider)},e.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.terrainProvider&&(this.cesiumService.getViewer().terrainProvider=this.terrainProvider):this.cesiumService.getViewer().terrainProvider=this.defaultTerrainProvider)},e.prototype.ngOnDestroy=function(){this.cesiumService.getViewer().terrainProvider=this.defaultTerrainProvider},e}();Ee.decorators=[{type:e.Component,args:[{selector:"ac-map-terrain-provider",template:""}]}],Ee.ctorParameters=function(){return[{type:f}]},Ee.propDecorators={options:[{type:e.Input}],provider:[{type:e.Input}],show:[{type:e.Input}]};var Pe=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Pe.decorators=[{type:e.Component,args:[{selector:"ac-point-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Pe}))}]}]}],Pe.ctorParameters=function(){return[{type:rt},{type:Dt},{type:Lt},{type:ne}]};var be=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);be.decorators=[{type:e.Component,args:[{selector:"ac-label",template:""}]}],be.ctorParameters=function(){return[{type:ot},{type:St}]};var Ce=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);Ce.decorators=[{type:e.Component,args:[{selector:"ac-polyline",template:""}]}],Ce.ctorParameters=function(){return[{type:at},{type:St}]};var _e=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);_e.decorators=[{type:e.Component,args:[{selector:"ac-ellipse",template:""}]}],_e.ctorParameters=function(){return[{type:nt},{type:St}]};var Me=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);Me.decorators=[{type:e.Component,args:[{selector:"ac-point",template:""}]}],Me.ctorParameters=function(){return[{type:rt},{type:St}]};var Se=function(){function t(t,e,i){this.cesiumService=t,this.elementRef=e,this.renderer=i,this.isDraw=!1}return t.prototype.setScreenPosition=function(t){t&&(this.renderer.setStyle(this.elementRef.nativeElement,"top",t.y+"px"),this.renderer.setStyle(this.elementRef.nativeElement,"left",t.x+"px"))},t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.elementRef.nativeElement),!1===this.props.show&&this.hideElement()},t.prototype.remove=function(){this.isDraw&&(this.isDraw=!1,this.cesiumService.getScene().preRender.removeEventListener(this.preRenderEventListener),this.hideElement())},t.prototype.hideElement=function(){this.renderer.setStyle(this.elementRef.nativeElement,"display","none")},t.prototype.add=function(){var t=this;this.isDraw||(this.isDraw=!0,this.preRenderEventListener=function(){var e=Cesium.SceneTransforms.wgs84ToWindowCoordinates(t.cesiumService.getScene(),t.props.position);t.setScreenPosition(e)},this.renderer.setStyle(this.elementRef.nativeElement,"display","block"),this.cesiumService.getScene().preRender.addEventListener(this.preRenderEventListener))},t.prototype.ngDoCheck=function(){void 0===this.props.show||this.props.show?this.add():this.remove()},t.prototype.ngOnDestroy=function(){this.remove()},t}();Se.decorators=[{type:e.Component,args:[{selector:"ac-html",template:"<ng-content></ng-content>",styles:[":host {\n                position: absolute;\n                z-index: 100;\n\t\t\t\t}"]}]}],Se.ctorParameters=function(){return[{type:f},{type:e.ElementRef},{type:e.Renderer2}]},Se.propDecorators={props:[{type:e.Input}]};var Te=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e.prototype.updateEllipseProps=function(){this.props.semiMajorAxis=this.props.radius,this.props.semiMinorAxis=this.props.radius,this.props.rotation=0},e.prototype.drawOnMap=function(){this.updateEllipseProps(),t.prototype.drawOnMap.call(this)},e.prototype.updateOnMap=function(){this.updateEllipseProps(),t.prototype.updateOnMap.call(this)},e}(Qt);Te.decorators=[{type:e.Component,args:[{selector:"ac-circle",template:""}]}],Te.ctorParameters=function(){return[{type:nt},{type:St}]};var Ae=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e.prototype.updateOnMap=function(){this.selfPrimitiveIsDraw&&(this.removeFromMap(),this.drawOnMap())},e.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.geometryProps,this.instanceProps,this.primitiveProps)},e.prototype.ngOnChanges=function(t){var e=t.geometryProps,i=t.instanceProps,n=t.primitiveProps;e.currentValue===e.previousValue&&i.currentValue===i.previousValue&&n.currentValue===n.previousValue||this.updateOnMap()},e}(Qt);Ae.decorators=[{type:e.Component,args:[{selector:"ac-arc",template:""}]}],Ae.ctorParameters=function(){return[{type:J},{type:St}]},Ae.propDecorators={geometryProps:[{type:e.Input}],instanceProps:[{type:e.Input}],primitiveProps:[{type:e.Input}]};var Oe=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Oe.decorators=[{type:e.Component,args:[{selector:"ac-polygon-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Oe}))}]}]}],Oe.ctorParameters=function(){return[{type:st},{type:Dt},{type:Lt},{type:ne}]};var Ie=function(){function t(t,e,i){this.plonterService=t,this.cd=e,this.geoConverter=i}return t.prototype.ngOnInit=function(){var t=this;this.plonterService.plonterChangeNotifier.subscribe((function(){return t.cd.detectChanges()}))},Object.defineProperty(t.prototype,"plonterPosition",{get:function(){if(this.plonterService.plonterShown){var t=this.plonterService.plonterClickPosition.endPosition;return this.geoConverter.screenToCartesian3(t)}},enumerable:!1,configurable:!0}),t.prototype.chooseEntity=function(t){this.plonterService.resolvePlonter(t)},t}();Ie.decorators=[{type:e.Component,args:[{selector:"ac-default-plonter",template:'\n      <ac-html *ngIf="plonterService.plonterShown" [props]="{\n        position: plonterPosition\n      }">\n        <div class="plonter-context-menu">\n          <div *ngFor="let entity of plonterService.entitesToPlonter">\n            <div class="plonter-item" (click)="chooseEntity(entity)">{{ entity?.name || entity?.id }}\n            </div>\n          </div>\n        </div>\n      </ac-html>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,providers:[G],styles:["\n        .plonter-context-menu {\n            background-color: rgba(250, 250, 250, 0.8);\n            box-shadow: 1px 1px 5px 0px rgba(0, 0, 0, 0.15);\n        }\n\n        .plonter-item {\n            cursor: pointer;\n            padding: 2px 15px;\n            text-align: start;\n        }\n\n        .plonter-item:hover {\n            background-color: rgba(0, 0, 0, 0.15);\n        }\n\n    "]}]}],Ie.ctorParameters=function(){return[{type:Pt},{type:e.ChangeDetectorRef},{type:G}]};var De=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);De.decorators=[{type:e.Component,args:[{selector:"ac-polygon",template:""}]}],De.ctorParameters=function(){return[{type:st},{type:St}]};var Le=function(t){function e(e,i,n,o){var r=t.call(this,e,i,n,o)||this;return r._staticPrimitiveDrawer=e,r}return z(e,t),e.prototype.ngOnInit=function(){this._layerService.registerDescription(this),this._geometryPropsEvaluator=this._cesiumProperties.createEvaluator(this.geometryProps),this._instancePropsEvaluator=this._cesiumProperties.createEvaluator(this.instanceProps),this._primitivePropsEvaluator=this._cesiumProperties.createEvaluator(this.primitiveProps)},e.prototype.draw=function(t,e,i){var n=this._geometryPropsEvaluator(this._computationCache,t),o=this._instancePropsEvaluator(this._computationCache,t),r=this._primitivePropsEvaluator(this._computationCache,t);if(this._cesiumObjectsMap.has(e)){s=this._cesiumObjectsMap.get(e);this._staticPrimitiveDrawer.update(s,n,o,r)}else{var s;(s=this._staticPrimitiveDrawer.add(n,o,r)).acEntity=i,this._cesiumObjectsMap.set(e,s)}},e}(oe);Le.decorators=[{type:e.Directive}],Le.ctorParameters=function(){return[{type:jt},{type:Dt},{type:Lt},{type:ne}]},Le.propDecorators={geometryProps:[{type:e.Input}],instanceProps:[{type:e.Input}],primitiveProps:[{type:e.Input}]};var we=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(Le);we.decorators=[{type:e.Component,args:[{selector:"ac-static-ellipse-desc",template:""}]}],we.ctorParameters=function(){return[{type:Ht},{type:Dt},{type:Lt},{type:ne}]};var Re=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Re.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-ellipse-desc",template:""}]}],Re.ctorParameters=function(){return[{type:Rt},{type:Dt},{type:Lt},{type:ne}]};var xe=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);xe.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-polyline-desc",template:""}]}],xe.ctorParameters=function(){return[{type:xt},{type:Dt},{type:Lt},{type:ne}]};var je=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(Le);je.decorators=[{type:e.Component,args:[{selector:"ac-static-polygon-desc",template:""}]}],je.ctorParameters=function(){return[{type:Ft},{type:Dt},{type:Lt},{type:ne}]};var ke=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(Le);ke.decorators=[{type:e.Component,args:[{selector:"ac-static-circle",template:""}]}],ke.ctorParameters=function(){return[{type:kt},{type:Dt},{type:Lt},{type:ne}]};var Ne=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e.prototype._propsEvaluator=function(e){var i=t.prototype._propsEvaluator.call(this,e);return i.semiMajorAxis=i.radius,i.semiMinorAxis=i.radius,i},e}(oe);Ne.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-circle-desc",template:""}]}],Ne.ctorParameters=function(){return[{type:Rt},{type:Dt},{type:Lt},{type:ne}]};var Fe=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(Le);Fe.decorators=[{type:e.Component,args:[{selector:"ac-static-polyline-desc",template:""}]}],Fe.ctorParameters=function(){return[{type:Nt},{type:Dt},{type:Lt},{type:ne}]};var He=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);He.decorators=[{type:e.Component,args:[{selector:"ac-model-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return He}))}]}]}],He.ctorParameters=function(){return[{type:Vt},{type:Dt},{type:Lt},{type:ne}]};var Ve=function(){function t(t){this.cesiumService=t,this.options={},this.show=!0,this.tilesetInstance=null}return t.prototype.ngOnInit=function(){if(!wt.present(this.options.url))throw new Error("Options must have a url");this._3dtilesCollection=new Cesium.PrimitiveCollection,this.cesiumService.getScene().primitives.add(this._3dtilesCollection),this.show&&(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style)))},t.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.tilesetInstance?this._3dtilesCollection.add(this.tilesetInstance,this.index):(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))):this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1));if(t.style&&!t.style.isFirstChange()){t.style.currentValue;this.tilesetInstance&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))}},t.prototype.ngOnDestroy=function(){this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1)},t}();Ve.decorators=[{type:e.Component,args:[{selector:"ac-3d-tile-layer",template:""}]}],Ve.ctorParameters=function(){return[{type:f}]},Ve.propDecorators={options:[{type:e.Input}],index:[{type:e.Input}],show:[{type:e.Input}],style:[{type:e.Input}]};var Be=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Be.decorators=[{type:e.Component,args:[{selector:"ac-box-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Be}))}]}]}],Be.ctorParameters=function(){return[{type:Bt},{type:Dt},{type:Lt},{type:ne}]};var Ue=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Ue.decorators=[{type:e.Component,args:[{selector:"ac-cylinder-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Ue}))}]}]}],Ue.ctorParameters=function(){return[{type:Gt},{type:Dt},{type:Lt},{type:ne}]};var Ge=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Ge.decorators=[{type:e.Component,args:[{selector:"ac-corridor-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Ge}))}]}]}],Ge.ctorParameters=function(){return[{type:Ut},{type:Dt},{type:Lt},{type:ne}]};var Ke=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Ke.decorators=[{type:e.Component,args:[{selector:"ac-ellipsoid-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Ke}))}]}]}],Ke.ctorParameters=function(){return[{type:Kt},{type:Dt},{type:Lt},{type:ne}]};var ze=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);ze.decorators=[{type:e.Component,args:[{selector:"ac-polyline-volume-desc",template:""}]}],ze.ctorParameters=function(){return[{type:zt},{type:Dt},{type:Lt},{type:ne}]};var We=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);We.decorators=[{type:e.Component,args:[{selector:"ac-wall-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return We}))}]}]}],We.ctorParameters=function(){return[{type:Wt},{type:Dt},{type:Lt},{type:ne}]};var $e=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);$e.decorators=[{type:e.Component,args:[{selector:"ac-rectangle-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return $e}))}]}]}],$e.ctorParameters=function(){return[{type:$t},{type:Dt},{type:Lt},{type:ne}]};var Ye=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Ye.decorators=[{type:e.Component,args:[{selector:"ac-billboard-primitive-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Ye}))}]}]}],Ye.ctorParameters=function(){return[{type:Zt},{type:Dt},{type:Lt},{type:ne}]};var Ze=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);Ze.decorators=[{type:e.Component,args:[{selector:"ac-label-primitive-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return Ze}))}]}]}],Ze.ctorParameters=function(){return[{type:Yt},{type:Dt},{type:Lt},{type:ne}]};var qe=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);qe.decorators=[{type:e.Component,args:[{selector:"ac-polyline-primitive-desc",template:"",providers:[{provide:oe,useExisting:e.forwardRef((function(){return qe}))}]}]}],qe.ctorParameters=function(){return[{type:lt},{type:Dt},{type:Lt},{type:ne}]};var Xe=function(){function t(t,e){if(void 0===e&&(e=null),"object"!=typeof t)throw new Error("HtmlPrimitive ERROR: invalid html options!");this.scene=t.scene,this._mapContainer=t.mapContainer,this.show=t.show||!0,this.position=t.position,this.pixelOffset=t.pixelOffset,this.element=t.element,this.collection=e}return Object.defineProperty(t.prototype,"scene",{set:function(t){this._scene=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t,Cesium.defined(this.element)&&(this._element.style.display=t?"block":"none")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pixelOffset",{get:function(){return this._pixelOffset},set:function(t){this._pixelOffset=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"element",{get:function(){return this._element},set:function(t){this._element=t,Cesium.defined(t)&&(this._mapContainer.appendChild(t),this._element.style.position="absolute",this._element.style.zIndex=Number.MAX_VALUE.toString())},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"collection",{get:function(){return this._collection},set:function(t){this._collection=t},enumerable:!1,configurable:!0}),t.prototype.update=function(){if(Cesium.defined(this._show)&&Cesium.defined(this._element)){var t=Cesium.SceneTransforms.wgs84ToWindowCoordinates(this._scene,this._position);Cesium.defined(t)?Cesium.defined(this._pixelOffset)&&Cesium.defined(this._pixelOffset.x)&&Cesium.defined(this._pixelOffset.y)&&(t.y+=this._pixelOffset.y,t.x+=this._pixelOffset.x):t=new Cesium.Cartesian2(-1e3,-1e3),this._lastPosition&&this._lastPosition.equals(t)||(this._element.style.top=t.y+"px",this._element.style.left=t.x+"px",this._lastPosition=t)}},t.prototype.remove=function(){this._element&&this._element.remove()},t}(),Je=function(){function t(){this._collection=[]}return Object.defineProperty(t.prototype,"length",{get:function(){return this._collection.length},enumerable:!1,configurable:!0}),t.prototype.get=function(t){return this._collection[t]},t.prototype.add=function(t){var e=new Xe(t,this);return this._collection.push(e),e},t.prototype.remove=function(t){var e=this._collection.indexOf(t);return-1!==e&&(this._collection[e].remove(),this._collection.splice(e,1),!0)},t.prototype.update=function(){for(var t=0,e=this._collection.length;t<e;t++)this._collection[t].update()},t.prototype.removeAll=function(){for(;this._collection.length>0;){this._collection.pop().remove()}},t.prototype.contains=function(t){return Cesium.defined(t)&&t.collection===this},t.prototype.destroy=function(){this.removeAll()},t}(),Qe=function(){function t(){}return t.extend=function(){Cesium.HtmlPrimitive=Xe,Cesium.HtmlCollection=Je},t}(),ti=function(){function t(){this._entities=new Map}return t.prototype.has=function(t){return this._entities.has(t)},t.prototype.get=function(t){return this._entities.get(t)},t.prototype.addOrUpdate=function(t,e){this._entities.set(t,e)},t.prototype.remove=function(t){this._entities.delete(t)},t.prototype.forEach=function(t){this._entities.forEach(t)},t}();ti.decorators=[{type:e.Injectable}],ti.ctorParameters=function(){return[]};var ei=function(t,e){this.id=t,this.context=e},ii=function(){function t(t,e,i,n,o){this._templateRef=t,this._viewContainerRef=e,this._changeDetector=i,this._layerService=n,this._acHtmlManager=o,this._views=new Map}return t.prototype.ngOnInit=function(){},t.prototype._handleView=function(t,e,i){if(!this._views.has(t)&&e.show){var n=new ei(t,{$implicit:i}),o=this._viewContainerRef.createEmbeddedView(this._templateRef,n);this._views.set(t,{viewRef:o,context:n}),this._changeDetector.detectChanges()}else this._views.has(t)&&e.show&&this._changeDetector.detectChanges()},t.prototype.addOrUpdate=function(t,e){var i=this._layerService.context[this._layerService.getEntityName()];this._views.has(t)&&(this._views.get(t).context.context.$implicit=i),this._acHtmlManager.addOrUpdate(t,{entity:i,primitive:e}),this._handleView(t,e,i)},t.prototype.remove=function(t,e){if(this._views.has(t)){var i=this._views.get(t).viewRef;this._viewContainerRef.remove(this._viewContainerRef.indexOf(i)),this._views.delete(t),this._acHtmlManager.remove(t),e.element=null}},t}();ii.decorators=[{type:e.Directive,args:[{selector:"[acHtml]"}]}],ii.ctorParameters=function(){return[{type:e.TemplateRef},{type:e.ViewContainerRef},{type:e.ChangeDetectorRef},{type:Dt},{type:ti}]};var ni=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e.prototype.ngOnInit=function(){if(t.prototype.ngOnInit.call(this),!this.acHtmlCreator)throw new Error("AcHtml desc ERROR: ac html directive not found.");if(!this.acHtmlTemplate)throw new Error("AcHtml desc ERROR: html template not found.")},e.prototype.draw=function(t,e){var i=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){n=this._cesiumObjectsMap.get(e);this._drawer.update(n,i),this.acHtmlCreator.addOrUpdate(e,n)}else{var n=this._drawer.add(i);this._cesiumObjectsMap.set(e,n),this.acHtmlCreator.addOrUpdate(e,n)}},e.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);this._drawer.remove(e),this._cesiumObjectsMap.delete(t),this.acHtmlCreator.remove(t,e)},e.prototype.removeAll=function(){var t=this;this._cesiumObjectsMap.forEach((function(e,i){t.acHtmlCreator.remove(i,e)})),this._cesiumObjectsMap.clear(),this._drawer.removeAll()},e}(oe);ni.decorators=[{type:e.Component,args:[{selector:"ac-html-desc",providers:[ti],template:'\n      <div *acHtml="let acHtmlEntityId = id; let acHtmlContext = context">\n          <div [acHtmlContainer]="acHtmlEntityId">\n              <ng-template [ngTemplateOutlet]="acHtmlTemplate"\n                           [ngTemplateOutletContext]="acHtmlContext"></ng-template>\n          </div>\n      </div>'}]}],ni.ctorParameters=function(){return[{type:Xt},{type:Dt},{type:Lt},{type:ne}]},ni.propDecorators={acHtmlCreator:[{type:e.ViewChild,args:[ii,{static:!0}]}],acHtmlTemplate:[{type:e.ContentChild,args:[e.TemplateRef,{static:!0}]}]};var oi=function(){function t(t,e){this._element=t,this._acHtmlManager=e}return Object.defineProperty(t.prototype,"acHtmlContainer",{set:function(t){this._id=t},enumerable:!1,configurable:!0}),t.prototype.ngOnInit=function(){if(void 0===this._id)throw new Error("AcHtml container ERROR: entity id not defined");this._acHtmlManager.get(this._id).primitive.element=this._element.nativeElement},t}();oi.decorators=[{type:e.Directive,args:[{selector:"[acHtmlContainer]"}]}],oi.ctorParameters=function(){return[{type:e.ElementRef},{type:ti}]},oi.propDecorators={acHtmlContainer:[{type:e.Input}]};var ri=function(){function t(t,e,i){this.contextMenuService=t,this.cd=e,this.componentFactoryResolver=i}return t.prototype.ngOnInit=function(){var t=this;this.contextMenuChangeSubscription=this.contextMenuService.contextMenuChangeNotifier.subscribe((function(){return t.cd.detectChanges()})),this.contextMenuOpenSubscription=this.contextMenuService.onOpen.subscribe((function(){var e=t.componentFactoryResolver.resolveComponentFactory(t.contextMenuService.content);t.viewContainerRef.clear(),t.viewContainerRef.createComponent(e).instance.data=t.contextMenuService.options.data,t.cd.detectChanges()}))},t.prototype.ngOnDestroy=function(){this.contextMenuChangeSubscription&&this.contextMenuChangeSubscription.unsubscribe(),this.contextMenuOpenSubscription&&this.contextMenuOpenSubscription.unsubscribe()},t}();ri.decorators=[{type:e.Component,args:[{selector:"ac-context-menu-wrapper",template:'\n    <ac-html *ngIf="contextMenuService.showContextMenu" [props]="{position: contextMenuService.position}">\n      <ng-template #contextMenuContainer></ng-template>\n    </ac-html>\n  ',changeDetection:e.ChangeDetectionStrategy.OnPush}]}],ri.ctorParameters=function(){return[{type:B},{type:e.ChangeDetectorRef},{type:e.ComponentFactoryResolver}]},ri.propDecorators={viewContainerRef:[{type:e.ViewChild,args:["contextMenuContainer",{read:e.ViewContainerRef}]}]};var si=function(){function t(t,e){this.layerService=t,this.cd=e,this.show=!0,this.entitiesMap=new Map,this.id=0,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.arrayObservable$=new s.Subject}return t.prototype.ngOnChanges=function(t){if(t.acFor.firstChange){var e=t.acFor.currentValue;if(!this.acForRgx.test(e))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+e);var i=t.acFor.currentValue.split(" ");this.arrayPath=i[3],this.entityName=i[1]}},t.prototype.ngOnInit=function(){var t=this;this.layer&&(this.layer.getLayerService().cache=!1),this.layerServiceSubscription=this.layerService.layerUpdates().subscribe((function(){t.cd.detectChanges()}))},t.prototype.ngAfterContentInit=function(){var t=this;this.layerService.context.arrayObservable$=this.arrayObservable$,this.layerService.registerDescription(this),this.basicDescs._results.forEach((function(e){e.setLayerService(t.layer.getLayerService())})),this.arrayDescs._results.splice(0,1),this.arrayDescs._results.forEach((function(e){t.layerService.unregisterDescription(e),t.layer.getLayerService().registerDescription(e),e.layerService=t.layer.getLayerService(),e.setLayerService(t.layer.getLayerService())}))},t.prototype.ngOnDestroy=function(){this.layerServiceSubscription&&this.layerServiceSubscription.unsubscribe()},t.prototype.setLayerService=function(t){this.layerService=t},t.prototype.draw=function(t,e,i){var n=this,o=h(t,this.arrayPath);if(o){var r=this.entitiesMap.get(e),s=[];if(this.entitiesMap.set(e,s),o.forEach((function(t,o){n.layerService.context[n.entityName]=t;var r=n.generateCombinedId(e,t,o);s.push(r),n.layer.update(i,r)})),r){var a=this.idGetter?r.filter((function(t){return s.indexOf(t)<0})):r;a&&a.forEach((function(t){return n.layer.remove(t)}))}}},t.prototype.remove=function(t){var e=this,i=this.entitiesMap.get(t);i&&i.forEach((function(t){return e.layer.remove(t)})),this.entitiesMap.delete(t)},t.prototype.removeAll=function(){this.layer.removeAll(),this.entitiesMap.clear()},t.prototype.getAcForString=function(){return"let "+this.entityName+"___temp of arrayObservable$"},t.prototype.generateCombinedId=function(t,e,i){return t+(this.idGetter?this.idGetter(e,i):this.id++%Number.MAX_SAFE_INTEGER)},t}();si.decorators=[{type:e.Component,args:[{selector:"ac-array-desc",template:'\n    <ac-layer #layer [acFor]="getAcForString()"\n              [context]="layerService.context"\n              [options]="layerService.options"\n              [show]="layerService.show && show"\n              [zIndex]="layerService.zIndex">\n      <ng-content #content></ng-content>\n    </ac-layer>\n  ',changeDetection:e.ChangeDetectionStrategy.OnPush}]}],si.ctorParameters=function(){return[{type:Dt},{type:e.ChangeDetectorRef}]},si.propDecorators={acFor:[{type:e.Input}],idGetter:[{type:e.Input}],show:[{type:e.Input}],layer:[{type:e.ViewChild,args:["layer",{static:!0}]}],basicDescs:[{type:e.ContentChildren,args:[oe,{descendants:!1}]}],arrayDescs:[{type:e.ContentChildren,args:[si,{descendants:!1}]}]};var ai=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);ai.decorators=[{type:e.Component,args:[{selector:"ac-point-primitive-desc",template:""}]}],ai.ctorParameters=function(){return[{type:qt},{type:Dt},{type:Lt},{type:ne}]};var ci=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);ci.decorators=[{type:e.Component,args:[{selector:"ac-primitive-polyline",template:""}]}],ci.ctorParameters=function(){return[{type:lt},{type:St}]};var pi=[{pipeName:"pixelOffset",pipeInstance:new ce},{pipeName:"radiansToDegrees",pipeInstance:new pe}],li=function(t){function e(e,i,n,o){return t.call(this,e,i,n,o)||this}return z(e,t),e}(oe);li.decorators=[{type:e.Component,args:[{selector:"ac-czml-desc",template:""}]}],li.ctorParameters=function(){return[{type:it},{type:Dt},{type:Lt},{type:ne}]};var di=function(t){function e(e,i){return t.call(this,e,i)||this}return z(e,t),e}(Qt);di.decorators=[{type:e.Component,args:[{selector:"ac-rectangle",template:""}]}],di.ctorParameters=function(){return[{type:$t},{type:St}]};var ui=function(){function t(){Qe.extend()}return t.forRoot=function(e){return{ngModule:t,providers:[ee,ne,q,g,Tt,N,{provide:k,useValue:e},{provide:p.PIPES_CONFIG,multi:!0,useValue:e&&e.customPipes||[]},{provide:p.PIPES_CONFIG,multi:!0,useValue:pi}]}},t}();ui.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule,p.Angular2ParseModule,de],declarations:[Ot,Jt,te,re,Ye,le,Ze,se,ae,qe,ce,pe,ue,he,ve,Ee,Pe,be,Ce,ci,_e,Me,te,Se,Te,Ae,Oe,De,Ie,He,Ve,Be,Ue,Ge,Ke,ze,We,$e,ri,ai,ni,ii,oi,si,li,we,Re,xe,Fe,Ne,ke,je,di],exports:[Ot,te,re,Ye,le,Ze,se,ae,qe,Jt,ue,he,ve,Ee,Pe,be,Ce,ci,_e,Me,te,Se,Te,Ae,Oe,De,Ie,He,Ve,Be,Ue,Ge,Ke,ze,We,$e,ai,ni,si,li,di,we,Re,xe,Fe,Ne,ke,je]}]}],ui.ctorParameters=function(){return[]};var hi,gi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}(s.Observable);(hi=t.CesiumEventModifier||(t.CesiumEventModifier={}))[hi.ALT=Cesium.KeyboardEventModifier.ALT]="ALT",hi[hi.CTRL=Cesium.KeyboardEventModifier.CTRL]="CTRL",hi[hi.SHIFT=Cesium.KeyboardEventModifier.SHIFT]="SHIFT";var yi,fi,mi=function(){function e(t){this.mapsManager=t,this.selectedEntitiesItems$=new s.BehaviorSubject([]),this.selectedEntitySubject$=new s.Subject}return e.prototype.selectedEntities$=function(){return this.selectedEntitiesItems$.asObservable()},e.prototype.selectedEntities=function(){return this.selectedEntitiesItems$.getValue()},e.prototype.selectedEntity$=function(){return this.selectedEntitySubject$},e.prototype.toggleSelection=function(t,e){-1===this.selectedEntities().indexOf(t)?this.addToSelected(t,e):this.removeSelected(t,e)},e.prototype.addToSelected=function(t,e){e&&(t.selected=!0);var i=this.selectedEntities();this.selectedEntitySubject$.next(t),this.selectedEntitiesItems$.next($(i,[t]))},e.prototype.removeSelected=function(t,e){e&&(t.selected=!1);var i=this.selectedEntities(),n=i.indexOf(t);-1!==n&&(i.splice(n,1),this.selectedEntitiesItems$.next(i),this.selectedEntitySubject$.next(t))},e.prototype.initSelection=function(e,i,n,o){var s=this;void 0===i&&(i=!0);var a=this.mapsManager.getMap(o);a&&(this.mapEventsManagerService=a.getMapEventsManager(),e||Object.assign(e,{event:t.CesiumEvent.LEFT_CLICK}),this.mapEventsManagerService.register({event:e.event,pick:t.PickOptions.PICK_ONE,modifier:e.modifier,entityType:e.entityType,priority:n}).pipe(r.map((function(t){return t.entities})),r.filter((function(t){return t&&t.length>0}))).subscribe((function(t){var e=t[0];s.toggleSelection(e,i)})))},e}();mi.decorators=[{type:e.Injectable}],mi.ctorParameters=function(){return[{type:Tt}]},(yi=t.EditModes||(t.EditModes={}))[yi.CREATE=0]="CREATE",yi[yi.EDIT=1]="EDIT",yi[yi.CREATE_OR_EDIT=2]="CREATE_OR_EDIT",(fi=t.EditActions||(t.EditActions={}))[fi.INIT=0]="INIT",fi[fi.MOUSE_MOVE=1]="MOUSE_MOVE",fi[fi.ADD_POINT=2]="ADD_POINT",fi[fi.ADD_LAST_POINT=3]="ADD_LAST_POINT",fi[fi.CHANGE_TO_EDIT=4]="CHANGE_TO_EDIT",fi[fi.REMOVE_POINT=5]="REMOVE_POINT",fi[fi.DRAG_POINT=6]="DRAG_POINT",fi[fi.DRAG_POINT_FINISH=7]="DRAG_POINT_FINISH",fi[fi.DRAG_SHAPE=8]="DRAG_SHAPE",fi[fi.DRAG_SHAPE_FINISH=9]="DRAG_SHAPE_FINISH",fi[fi.DONE=10]="DONE",fi[fi.DISABLE=11]="DISABLE",fi[fi.ENABLE=12]="ENABLE",fi[fi.DISPOSE=13]="DISPOSE",fi[fi.SET_EDIT_LABELS_RENDER_CALLBACK=14]="SET_EDIT_LABELS_RENDER_CALLBACK",fi[fi.UPDATE_EDIT_LABELS=15]="UPDATE_EDIT_LABELS",fi[fi.SET_MANUALLY=16]="SET_MANUALLY",fi[fi.TRANSFORM=17]="TRANSFORM";var vi=function(t){function e(e,i,n,o){void 0===o&&(o=!1);var r=t.call(this)||this;return r._show=!0,r.editedEntityId=e,r.position=i,r.id=r.generateId(),r.pointProps=Object.assign({},n),r._virtualEditPoint=o,r}return z(e,t),Object.defineProperty(e.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"props",{get:function(){return this.pointProps},set:function(t){this.pointProps=t},enumerable:!1,configurable:!0}),e.prototype.isVirtualEditPoint=function(){return this._virtualEditPoint},e.prototype.setVirtualEditPoint=function(t){this._virtualEditPoint=t},e.prototype.getEditedEntityId=function(){return this.editedEntityId},e.prototype.getPosition=function(){return this.position.clone()},e.prototype.getPositionCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPosition.bind(this),!1)},e.prototype.setPosition=function(t){this.position.x=t.x,this.position.y=t.y,this.position.z=t.z},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-point-"+e.counter++},e}(fe);function Ei(t){void 0===t&&(t=12);for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<t;n++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}function Pi(t,e){var i;return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var r=this;clearTimeout(i),i=setTimeout((function(){return t.apply(r,n)}),e)}}vi.counter=0;var bi={addLastPointEvent:t.CesiumEvent.LEFT_CLICK,removePointEvent:t.CesiumEvent.RIGHT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.5),outlineWidth:1,pixelSize:10,show:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY}},Ci=function(){function e(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return e.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.pointManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.screenToPosition=function(t){var e=this.coordinateConverter.screenToCartesian3(t);if(e){var i=this.cameraService.getCamera().getPickRay(t);return this.cesiumScene.globe.pick(i,this.cesiumScene)}return e},e.prototype.create=function(e,i){var n=this;void 0===e&&(e=bi),void 0===i&&(i=100);var o=Ei(),r=this.setOptions(e),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.CREATE});this.updateSubject.next({id:o,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,pointOptions:r});var c=function(t){return n.switchToEditMode(o,a,t,i,r,d,!0)},p=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,priority:i,pickConfig:e.pickConfiguration}),l=this.mapEventsManager.register({event:r.addLastPointEvent,modifier:r.addLastPointModifier,pick:t.PickOptions.NO_PICK,priority:i,pickConfig:e.pickConfiguration});this.observablesMap.set(o,[p,l]);var d=this.createEditorObservable(a,o,c);return p.subscribe((function(e){var i=e.movement.endPosition,r=n.screenToPosition(i);r&&n.updateSubject.next({id:o,position:r,editMode:t.EditModes.CREATE,updatedPosition:r,editAction:t.EditActions.MOUSE_MOVE})})),l.subscribe((function(t){var e=t.movement.endPosition,i=n.screenToPosition(e);c(i)})),d},e.prototype.switchToEditMode=function(e,i,n,o,r,s,a){var c={id:e,position:n,editMode:t.EditModes.CREATE_OR_EDIT,updatedPosition:n,editAction:t.EditActions.ADD_LAST_POINT};this.updateSubject.next(c),i.next(Object.assign(Object.assign({},c),{position:n,point:this.getPoint(e)}));var p={id:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return this.updateSubject.next(p),i.next(p),this.observablesMap.has(e)&&this.observablesMap.get(e).forEach((function(t){return t.dispose()})),this.observablesMap.delete(e),this.editPoint(e,n,o,i,r,s),!0,true},e.prototype.edit=function(e,i,n){void 0===i&&(i=bi),void 0===n&&(n=100);var o=Ei(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.EDIT}),c={id:o,position:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,pointOptions:r};return this.updateSubject.next(c),a.next(Object.assign(Object.assign({},c),{position:e,point:this.getPoint(o)})),this.editPoint(o,e,n,a,r)},e.prototype.editPoint=function(e,i,n,o,s,a){var c=this,p=this.mapEventsManager.register({event:s.dragPointEvent,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}}),l=this.mapEventsManager.register({event:s.removePointEvent,modifier:s.removePointModifier,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}});p.pipe(r.tap((function(t){var e=t.movement.drop;return c.cameraService.enableInputs(e)}))).subscribe((function(i){var n=i.movement,r=n.endPosition,s=n.drop,a=(i.entities,c.screenToPosition(r));if(a){var p={id:e,editMode:t.EditModes.EDIT,updatedPosition:a,editAction:s?t.EditActions.DRAG_POINT_FINISH:t.EditActions.DRAG_POINT};c.updateSubject.next(p),o.next(Object.assign(Object.assign({},p),{position:a,point:c.getPoint(e)}))}}));var d=[p,l];return this.observablesMap.set(e,d),this.createEditorObservable(o,e)},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(bi)),i=Object.assign(e,t);return i.pointProps=Object.assign(Object.assign({},bi.pointProps),t.pointProps),i.pointProps=Object.assign(Object.assign({},bi.pointProps),t.pointProps),i},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,position:o.getPosition(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,position:o.getPosition(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n){o.pointManager.get(i).setManually(e,n),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Points editor error edit(): cannot call finishCreation() on edit");return n(null)},e.getCurrentPoint=function(){return o.getPoint(i)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.pointManager.get(i).labels},e},e.prototype.getPosition=function(t){return this.pointManager.get(t).getPosition()},e.prototype.getPoint=function(t){var e=this.pointManager.get(t);if(e)return e.getCurrentPoint()},e}();Ci.decorators=[{type:e.Injectable}];var _i={backgroundColor:new Cesium.Color(.165,.165,.165,.7),backgroundPadding:new Cesium.Cartesian2(25,20),distanceDisplayCondition:void 0,fillColor:Cesium.Color.WHITE,font:"30px sans-serif",heightReference:Cesium.HeightReference.NONE,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelOffset:Cesium.Cartesian2.ZERO,pixelOffsetScaleByDistance:void 0,scale:1,scaleByDistance:void 0,show:!0,showBackground:!1,style:Cesium.LabelStyle.FILL,text:"",translucencyByDistance:void 0,verticalOrigin:Cesium.VerticalOrigin.BASELINE,eyeOffset:Cesium.Cartesian3.ZERO,disableDepthTestDistance:0},Mi=function(t){function e(e,i,n,o,r){var s=t.call(this)||this;return s.id=e,s.pointLayer=i,s.coordinateConverter=n,s.editOptions=o,s._enableEdit=!0,s._labels=[],s._props=Object.assign({},o.pointProps),r&&s.createFromExisting(r),s}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.point.getPosition();this._labels=t.map((function(t,i){return t.position||(t.position=e),Object.assign({},_i,t)}))}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"props",{get:function(){return this._props},set:function(t){this._props=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,t?this.point.props.color=Cesium.Color.WHITE:(this.point.props.color=Cesium.Color.DIMGREY,this.point.props.pixelSize=10),this.updatePointLayer()},enumerable:!1,configurable:!0}),e.prototype.createFromExisting=function(t){this.point=new vi(this.id,t,this._props),this.updatePointLayer()},e.prototype.hasPosition=function(t){return!!t.position},e.prototype.setManually=function(t,e){if(!this.enableEdit)throw new Error("Update manually only in edit mode, after point is created");var i=e;this.hasPosition(t)?(i=t.pointProp?t.pointProp:e,this.point.setPosition(t.position)):this.point.setPosition(t),this.point.props=i,this.updatePointLayer()},e.prototype.addLastPoint=function(t){this.point.setPosition(t),this.updatePointLayer()},e.prototype.movePoint=function(t){this.point?this.point.setPosition(t):this.point=new vi(this.id,t,this._props),this.updatePointLayer()},e.prototype.getCurrentPoint=function(){return this.point},e.prototype.getPosition=function(){return this.point.getPosition()},e.prototype.getPositionCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPosition.bind(this),!1)},e.prototype.updatePointLayer=function(){this.pointLayer.update(this.point,this.point.getId())},e.prototype.update=function(){this.updatePointLayer()},e.prototype.dispose=function(){this.pointLayer.remove(this.point.getId())},e.prototype.getId=function(){return this.id},e}(fe),Si=function(){function t(){this.points=new Map}return t.prototype.createEditablePoint=function(t,e,i,n,o){var r=new Mi(t,e,i,n,o);this.points.set(t,r)},t.prototype.enableAll=function(){this.points.forEach((function(t){return t.enableEdit=!0}))},t.prototype.disableAll=function(){this.points.forEach((function(t){return t.enableEdit=!1}))},t.prototype.dispose=function(t){var e=this.points.get(t);e.getCurrentPoint()&&e.dispose(),this.points.delete(t)},t.prototype.get=function(t){return this.points.get(t)},t.prototype.clear=function(){this.points.forEach((function(t){return t.dispose()})),this.points.clear()},t}();Si.decorators=[{type:e.Injectable}];var Ti=function(){function e(t,e,i,n,o,r){this.pointsEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.pointsManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoint$=new s.Subject,this.pointLabels$=new s.Subject,this.pointsEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o,this.cesiumService),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.pointsEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(i)return t.labels=i,void this.pointLabelsLayer.update(t,t.getId());this.editLabelsRenderFn&&(e.position=t.getPosition(),e.point=t.getCurrentPoint(),t.labels=this.editLabelsRenderFn(e,t.labels),this.pointLabelsLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.pointLabelsLayer.remove(t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.pointsManager.createEditablePoint(e.id,this.editPointLayer,this.coordinateConverter,e.pointOptions,e.position);break;case t.EditActions.ADD_LAST_POINT:var i=this.pointsManager.get(e.id);e.updatedPosition&&(i.addLastPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.MOUSE_MOVE:i=this.pointsManager.get(e.id);e.updatedPosition&&(i.movePoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.pointsManager.get(e.id))&&i.getCurrentPoint()&&this.removeEditLabels(i),this.pointsManager.dispose(e.id),this.editLabelsRenderFn=void 0;break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.pointsManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.pointsManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.pointsManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.pointsManager.createEditablePoint(e.id,this.editPointLayer,this.coordinateConverter,e.pointOptions,e.position);break;case t.EditActions.DRAG_POINT:case t.EditActions.DRAG_POINT_FINISH:(i=this.pointsManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.pointsManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:var i;(i=this.pointsManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.pointsManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();Ti.decorators=[{type:e.Component,args:[{selector:"points-editor",template:'\n    <ac-layer #editPointLayer acFor="let point of editPoint$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      ></ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #pointLabelsLayer acFor="let pointLabels of pointLabels$" [context]="this">\n      <ac-array-desc acFor="let label of pointLabels.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[G,Si],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Ti.ctorParameters=function(){return[{type:Ci},{type:G},{type:Mt},{type:V},{type:Si},{type:f}]},Ti.propDecorators={editPointLayer:[{type:e.ViewChild,args:["editPointLayer"]}],pointLabelsLayer:[{type:e.ViewChild,args:["pointLabelsLayer"]}]};var Ai=function(t){function e(e,i,n,o){var r=t.call(this)||this;return r.editedEntityId=e,r.id=r.generateId(),r.positions=[i,n],r._polylineProps=Object.assign({},o),r}return z(e,t),Object.defineProperty(e.prototype,"props",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!1,configurable:!0}),e.prototype.getEditedEntityId=function(){return this.editedEntityId},e.prototype.getPositions=function(){return this.positions.map((function(t){return t.clone()}))},e.prototype.getPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositions.bind(this),!1)},e.prototype.validatePositions=function(){return void 0!==this.positions[0]&&void 0!==this.positions[1]},e.prototype.getStartPosition=function(){return this.positions[0]},e.prototype.getEndPosition=function(){return this.positions[1]},e.prototype.setStartPosition=function(t){this.positions[0]=t},e.prototype.setEndPosition=function(t){this.positions[1]=t},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-polyline-"+e.counter++},e}(fe);Ai.counter=0;var Oi=function(t){function e(e,i,n,o,r,s,a){var c=t.call(this)||this;return c.id=e,c.polygonsLayer=i,c.pointsLayer=n,c.polylinesLayer=o,c.coordinateConverter=r,c.polygonOptions=s,c.positions=[],c.polylines=[],c.doneCreation=!1,c._enableEdit=!0,c._labels=[],c.polygonProps=Object.assign({},s.polygonProps),c.defaultPointProps=Object.assign({},s.pointProps),c.defaultPolylineProps=Object.assign({},s.polylineProps),a&&a.length>=3&&c.createFromExisting(a),c}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map((function(t,i){return t.position||(t.position=e[i]),Object.assign({},_i,t)}))}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultPolylineProps",{get:function(){return this._defaultPolylineProps},set:function(t){this._defaultPolylineProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polygonProps",{get:function(){return this._polygonProps},set:function(t){this._polygonProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach((function(i){i.show=t,e.updatePointsLayer(!1,i)}))},enumerable:!1,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach((function(t){e.addPointFromExisting(t)})),this.addAllVirtualEditPoints(),this.updatePolygonsLayer(),this.doneCreation=!0},e.prototype.setPointsManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polygon is created");this.positions.forEach((function(t){return i.pointsLayer.remove(t.getId())}));for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new vi(this.id,r.position,r.pointProps):new vi(this.id,r,this.defaultPointProps),n.push(s)}this.positions=n,this.polygonProps=e||this.polygonProps,this.updatePointsLayer.apply(this,$([!0],this.positions)),this.addAllVirtualEditPoints(),this.updatePolygonsLayer()},e.prototype.addAllVirtualEditPoints=function(){var t=this,e=$(this.positions);e.forEach((function(i,n){var o=i,r=(n+1)%e.length,s=e[r],a=t.setMiddleVirtualPoint(o,s);t.updatePointsLayer(!1,a)}))},e.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartesian3.lerp(t.getPosition(),e.getPosition(),.5,new Cesium.Cartesian3),n=new vi(this.id,i,this.defaultPointProps);n.setVirtualEditPoint(!0);var o=this.positions.indexOf(t);return this.positions.splice(o+1,0,n),n},e.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3);t.setPosition(n)},e.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),c=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!0,a,c,t),this.updatePolygonsLayer()},e.prototype.renderPolylines=function(){var t=this;this.polylines.forEach((function(e){return t.polylinesLayer.remove(e.getId())})),this.polylines=[];var e=this.positions.filter((function(t){return!t.isVirtualEditPoint()}));e.forEach((function(i,n){var o=(n+1)%e.length,r=e[o],s=new Ai(t.id,i.getPosition(),r.getPosition(),t.defaultPolylineProps);t.polylines.push(s),t.polylinesLayer.update(s,s.getId())}))},e.prototype.addPointFromExisting=function(t){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},e.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new vi(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint),this.updatePolygonsLayer()}},e.prototype.movePointFinish=function(t){this.polygonOptions.clampHeightTo3D&&(t.props.disableDepthTestDistance=Number.POSITIVE_INFINITY,this.updatePointsLayer(!1,t))},e.prototype.movePoint=function(t,e){if(e.setPosition(t),this.doneCreation){if(e.props.disableDepthTestDistance&&this.polygonOptions.clampHeightTo3D)return void(e.props.disableDepthTestDistance=void 0);e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e),o=this.positions[(n+1)%i],r=this.positions[(n+2)%i],s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(o,e,r),this.updateMiddleVirtualPoint(s,e,a)}this.updatePolygonsLayer(),this.updatePointsLayer(!0,e)},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.movePolygon=function(t,e){var i=this;if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var n=q.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach((function(t){var e=q.addDeltaToPosition(t.getPosition(),n,!0);t.setPosition(e)})),this.updatePointsLayer(),this.lastDraggedToPosition=e,this.positions.forEach((function(t){return i.updatePointsLayer(!0,t)}))}},e.prototype.endMovePolygon=function(){this.lastDraggedToPosition=void 0},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter((function(t){return t.isVirtualEditPoint()})).forEach((function(t){return e.removePosition(t)})),this.addAllVirtualEditPoints(),this.renderPolylines(),this.getPointsCount()>=3&&this.polygonsLayer.update(this,this.id)},e.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.updatePolygonsLayer(),this.addAllVirtualEditPoints()},e.prototype.getRealPositions=function(){return this.getRealPoints().map((function(t){return t.getPosition()}))},e.prototype.getRealPoints=function(){var t=this;return this.positions.filter((function(e){return!e.isVirtualEditPoint()&&e!==t.movingPoint}))},e.prototype.getPoints=function(){var t=this;return this.positions.filter((function(e){return e!==t.movingPoint}))},e.prototype.getPositionsHierarchy=function(){var t=this.positions.filter((function(t){return!t.isVirtualEditPoint()})).map((function(t){return t.getPosition().clone()}));return new Cesium.PolygonHierarchy(t)},e.prototype.getPositionsHierarchyCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositionsHierarchy.bind(this),!1)},e.prototype.removePosition=function(t){var e=this.positions.findIndex((function(e){return e===t}));e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePolygonsLayer=function(){this.getPointsCount()>=3&&this.polygonsLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach((function(t){return e.pointsLayer.update(t,t.getId())}))},e.prototype.dispose=function(){var t=this;this.polygonsLayer.remove(this.id),this.positions.forEach((function(e){t.pointsLayer.remove(e.getId())})),this.polylines.forEach((function(e){return t.polylinesLayer.remove(e.getId())})),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(fe),Ii=function(){function t(){this.polygons=new Map}return t.prototype.createEditablePolygon=function(t,e,i,n,o,r,s){var a=new Oi(t,e,i,n,o,r,s);this.polygons.set(t,a)},t.prototype.dispose=function(t){this.polygons.get(t).dispose(),this.polygons.delete(t)},t.prototype.get=function(t){return this.polygons.get(t)},t.prototype.clear=function(){this.polygons.forEach((function(t){return t.dispose()})),this.polygons.clear()},t}();Ii.decorators=[{type:e.Injectable}];var Di=function(){return Cesium.Color.WHITE},Li={addPointEvent:t.CesiumEvent.LEFT_CLICK,addLastPointEvent:t.CesiumEvent.LEFT_DOUBLE_CLICK,removePointEvent:t.CesiumEvent.RIGHT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polygonProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,classificationType:Cesium.ClassificationType.BOTH,zIndex:0},polylineProps:{material:Di,width:3,clampToGround:!1,zIndex:0,classificationType:Cesium.ClassificationType.BOTH},clampHeightTo3D:!1,clampHeightTo3DOptions:{clampToTerrain:!1,clampMostDetailed:!0,clampToHeightPickWidth:2}},wi=function(){function e(){var t=this;this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map,this.clampPointsDebounced=Pi((function(e,i,n){t.clampPoints(e,i,n)}),300)}return e.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polygonsManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.clampPoints=function(t,e,i){var n=this,o=i.clampToTerrain,r=i.clampMostDetailed,s=i.clampToHeightPickWidth;if(e&&r){var a=this.polygonsManager.get(t).getPoints();if(o){var c=a.map((function(t){return n.coordinateConverter.cartesian3ToCartographic(t.getPosition())})),p=Cesium.sampleTerrain(this.cesiumScene.terrainProvider,11,c);Cesium.when(p,(function(t){a.forEach((function(e,i){e.setPosition(Cesium.Cartographic.toCartesian(t[i]))}))}))}else a.forEach((function(t){t.setPosition(n.cesiumScene.clampToHeight(t.getPosition(),void 0,s))}))}},e.prototype.screenToPosition=function(t,e,i){var n=this,o=i.clampToHeightPickWidth,r=i.clampToTerrain,s=this.coordinateConverter.screenToCartesian3(t);if(e&&s){var a=function(){var e=n.cameraService.getCamera().getPickRay(t);return n.cesiumScene.globe.pick(e,n.cesiumScene)};if(r)return a();var c=this.cesiumScene.pickPosition(t);return G.cartesian3ToLatLon(c).height<0?a():this.cesiumScene.clampToHeight(c,void 0,o)}return s},e.prototype.create=function(e,i){var n=this;void 0===e&&(e=Li),void 0===i&&(i=100);var o=[],r=Ei(),a=this.setOptions(e),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.CREATE}),p=!1;this.updateSubject.next({id:r,positions:o,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,polygonOptions:a});var l=function(t){return n.switchToEditMode(r,t,c,o,i,a,g,p)},d=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i}),u=this.mapEventsManager.register({event:a.addPointEvent,modifier:a.addPointModifier,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i}),h=this.mapEventsManager.register({event:a.addLastPointEvent,modifier:a.addLastPointModifier,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i});this.observablesMap.set(r,[d,u,h]);var g=this.createEditorObservable(c,r,l);return d.subscribe((function(e){var i=e.movement.endPosition,o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);o&&n.updateSubject.next({id:r,positions:n.getPositions(r),editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.MOUSE_MOVE})})),u.subscribe((function(e){var i=e.movement.endPosition;if(!p){var o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);if(o){var s=n.getPositions(r);if(!s.find((function(t){return t.equals(o)}))){var d={id:r,positions:s,editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),c.next(Object.assign(Object.assign({},d),{positions:n.getPositions(r),points:n.getPoints(r)})),a.maximumNumberOfPoints&&s.length+1===a.maximumNumberOfPoints&&(p=l(o))}}}})),h.subscribe((function(e){var i=e.movement.endPosition,o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);if(o){var s=n.getPositions(r);if(!s.find((function(t){return t.equals(o)}))){var d={id:r,positions:s,editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),c.next(Object.assign(Object.assign({},d),{positions:n.getPositions(r),points:n.getPoints(r)}))}p=l(o)}})),g},e.prototype.switchToEditMode=function(e,i,n,o,r,s,a,c){var p={id:e,positions:this.getPositions(e),editMode:t.EditModes.CREATE,updatedPosition:i,editAction:t.EditActions.ADD_LAST_POINT};this.updateSubject.next(p),n.next(Object.assign(Object.assign({},p),{positions:this.getPositions(e),points:this.getPoints(e)}));var l={id:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return this.updateSubject.next(l),n.next(l),this.observablesMap.has(e)&&this.observablesMap.get(e).forEach((function(t){return t.dispose()})),this.observablesMap.delete(e),this.editPolygon(e,o,r,n,s,a),!0,true},e.prototype.edit=function(e,i,n){if(void 0===i&&(i=Li),void 0===n&&(n=100),e.length<3)throw new Error("Polygons editor error edit(): polygon should have at least 3 positions");var o=Ei(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.EDIT}),c={id:o,positions:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,polygonOptions:r};return this.updateSubject.next(c),a.next(Object.assign(Object.assign({},c),{positions:this.getPositions(o),points:this.getPoints(o)})),this.editPolygon(o,e,n,a,r)},e.prototype.editPolygon=function(e,i,n,o,s,a){var c=this;this.clampPoints(e,s.clampHeightTo3D,s.clampHeightTo3DOptions);var p,l=this.mapEventsManager.register({event:s.dragPointEvent,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}});s.allowDrag&&(p=this.mapEventsManager.register({event:s.dragShapeEvent,entityType:Oi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.id}}));var d=this.mapEventsManager.register({event:s.removePointEvent,entityType:vi,modifier:s.removePointModifier,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}});l.pipe(r.tap((function(t){var i=t.movement.drop;return c.polygonsManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.endPosition,a=n.drop,p=i.entities,l=c.screenToPosition(r,s.clampHeightTo3D,s.clampHeightTo3DOptions);if(l){var d=p[0],u={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:l,updatedPoint:d,editAction:a?t.EditActions.DRAG_POINT_FINISH:t.EditActions.DRAG_POINT};c.updateSubject.next(u),o.next(Object.assign(Object.assign({},u),{positions:c.getPositions(e),points:c.getPoints(e)})),c.clampPointsDebounced(e,s.clampHeightTo3D,s.clampHeightTo3DOptions)}})),p&&p.pipe(r.tap((function(t){var i=t.movement.drop;return c.polygonsManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.startPosition,a=n.endPosition,p=n.drop,l=(i.entities,c.screenToPosition(a,!1,s.clampHeightTo3DOptions)),d=c.screenToPosition(r,!1,s.clampHeightTo3DOptions);if(l){var u={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:l,draggedPosition:d,editAction:p?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE};c.updateSubject.next(u),o.next(Object.assign(Object.assign({},u),{positions:c.getPositions(e),points:c.getPoints(e)}))}})),d.subscribe((function(i){var n=i.entities[0],r=$(c.getPositions(e));if(!(r.length<4)&&!(r.findIndex((function(t){return n.getPosition().equals(t)}))<0)){var a={id:e,positions:r,editMode:t.EditModes.EDIT,updatedPoint:n,editAction:t.EditActions.REMOVE_POINT};c.updateSubject.next(a),o.next(Object.assign(Object.assign({},a),{positions:c.getPositions(e),points:c.getPoints(e)})),c.clampPoints(e,s.clampHeightTo3D,s.clampHeightTo3DOptions)}}));var u=[l,d];return p&&u.push(p),this.observablesMap.set(e,u),a||this.createEditorObservable(o,e)},e.prototype.setOptions=function(t){t.maximumNumberOfPoints&&t.maximumNumberOfPoints<3&&(console.warn("Warn: PolygonEditor invalid option. maximumNumberOfPoints smaller then 3, maximumNumberOfPoints changed to 3"),t.maximumNumberOfPoints=3);var e=JSON.parse(JSON.stringify(Li)),i=Object.assign(e,t);if(i.pointProps=Object.assign(Object.assign({},Li.pointProps),t.pointProps),i.polygonProps=Object.assign(Object.assign({},Li.polygonProps),t.polygonProps),i.polylineProps=Object.assign(Object.assign({},Li.polylineProps),t.polylineProps),i.clampHeightTo3DOptions=Object.assign(Object.assign({},Li.clampHeightTo3DOptions),t.clampHeightTo3DOptions),t.clampHeightTo3D){if(!this.cesiumScene.pickPositionSupported||!this.cesiumScene.clampToHeightSupported)throw new Error("Cesium pickPosition and clampToHeight must be supported to use clampHeightTo3D");this.cesiumScene.pickTranslucentDepth&&console.warn("Cesium scene.pickTranslucentDepth must be false in order to make the editors work properly on 3D"),1!==i.pointProps.color.alpha&&1!==i.pointProps.outlineColor.alpha||console.warn("Point color and outline color must have alpha in order to make the editor work properly on 3D"),i.allowDrag=!1,i.polylineProps.clampToGround=!0,i.pointProps.heightReference=i.clampHeightTo3DOptions.clampToTerrain?Cesium.HeightReference.CLAMP_TO_GROUND:Cesium.HeightReference.RELATIVE_TO_GROUND,i.pointProps.disableDepthTestDistance=Number.POSITIVE_INFINITY}return i},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n){o.polygonsManager.get(i).setPointsManually(e,n),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Polygons editor error edit(): cannot call finishCreation() on edit");return n(null)},e.getCurrentPoints=function(){return o.getPoints(i)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.polygonsManager.get(i).labels},e},e.prototype.getPositions=function(t){return this.polygonsManager.get(t).getRealPositions()},e.prototype.getPoints=function(t){return this.polygonsManager.get(t).getRealPoints()},e}();wi.decorators=[{type:e.Injectable}];var Ri=function(){function e(t,e,i,n,o,r){this.polygonsEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polygonsManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editPolylines$=new s.Subject,this.editPolygons$=new s.Subject,this.polygonsEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.polygonsManager,this.cesiumService),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.polygonsEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editPolygonsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editPolygonsLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.editPolygonsLayer.update(t,t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.polygonsManager.createEditablePolygon(e.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,e.polygonOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.polygonsManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.polygonsManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),i.addPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_LAST_POINT:i=this.polygonsManager.get(e.id);e.updatedPosition&&(i.addLastPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.polygonsManager.get(e.id))&&(i.dispose(),this.removeEditLabels(i),this.editLabelsRenderFn=void 0);break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.polygonsManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.polygonsManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.polygonsManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.polygonsManager.createEditablePolygon(e.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,e.polygonOptions,e.positions);break;case t.EditActions.DRAG_POINT:(i=this.polygonsManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.updatedPosition,e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_POINT_FINISH:(i=this.polygonsManager.get(e.id))&&i.enableEdit&&(i.movePointFinish(e.updatedPoint),e.updatedPoint.isVirtualEditPoint()&&(i.changeVirtualPointToRealPoint(e.updatedPoint),this.renderEditLabels(i,e)));break;case t.EditActions.REMOVE_POINT:(i=this.polygonsManager.get(e.id))&&i.enableEdit&&(i.removePoint(e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.polygonsManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.polygonsManager.get(e.id))&&i.enableEdit&&(i.movePolygon(e.draggedPosition,e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:(i=this.polygonsManager.get(e.id))&&i.enableEdit&&(i.endMovePolygon(),this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:var i;(i=this.polygonsManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.polygonsManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();Ri.decorators=[{type:e.Component,args:[{selector:"polygons-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-desc\n        props="{\n        positions: polyline.getPositionsCallbackProperty(),\n        width: polyline.props.width,\n        material: polyline.props.material(),\n        clampToGround: polyline.props.clampToGround,\n        zIndex: polyline.props.zIndex,\n        classificationType: polyline.props.classificationType,\n      }"\n      >\n      </ac-polyline-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editPolygonsLayer acFor="let polygon of editPolygons$" [context]="this">\n      <ac-polygon-desc\n        props="{\n          hierarchy: polygon.getPositionsHierarchyCallbackProperty(),\n          material: polygon.polygonProps.material,\n          fill: polygon.polygonProps.fill,\n          classificationType: polygon.polygonProps.classificationType,\n          zIndex: polygon.polygonProps.zIndex,\n        }"\n      >\n      </ac-polygon-desc>\n      <ac-array-desc acFor="let label of polygon.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[G,Ii],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Ri.ctorParameters=function(){return[{type:wi},{type:G},{type:Mt},{type:V},{type:Ii},{type:f}]},Ri.propDecorators={editPolygonsLayer:[{type:e.ViewChild,args:["editPolygonsLayer"]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}],editPolylinesLayer:[{type:e.ViewChild,args:["editPolylinesLayer"]}]};var xi=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;return a._arcProps=s,a.id=a.generateId(),a.editedEntityId=e,a._center=i,a._radius=n,a._delta=o,a._angle=r,a}return z(e,t),Object.defineProperty(e.prototype,"props",{get:function(){return this._arcProps},set:function(t){this._arcProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"delta",{get:function(){return this._delta},set:function(t){this._delta=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},set:function(t){this._center=t},enumerable:!1,configurable:!0}),e.prototype.updateCenter=function(t){this._center.x=t.x,this._center.y=t.y,this._center.z=t.z},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-arc-"+e.counter++},e}(fe);xi.counter=0;var ji=function(t){function e(e,i,n,o,r){var s=t.call(this)||this;return s.id=e,s.circlesLayer=i,s.pointsLayer=n,s.arcsLayer=o,s.options=r,s.doneCreation=!1,s._enableEdit=!0,s._labels=[],s._circleProps=Object.assign({},r.circleProps),s._pointProps=Object.assign({},r.pointProps),s._polylineProps=Object.assign({},r.polylineProps),s}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){var e=this;t&&this._center&&this._radiusPoint&&(this._labels=t.map((function(i,n){return i.position||(n!==t.length-1?i.position=e._center.getPosition():i.position=e._radiusPoint.getPosition()),Object.assign({},_i,i)})))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"circleProps",{get:function(){return this._circleProps},set:function(t){this._circleProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"radiusPoint",{get:function(){return this._radiusPoint},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._radiusPoint.show=t,this.updatePointsLayer()},enumerable:!1,configurable:!0}),e.prototype.setManually=function(t,e,i,n,o){void 0===i&&(i=this.pointProps),void 0===n&&(n=this.pointProps),void 0===o&&(o=this.circleProps),this._center?this._center.setPosition(t):this._center=new vi(this.id,t,i),this._radiusPoint?this._radiusPoint.setPosition(e):this._radiusPoint=new vi(this.id,e,n),this._outlineArc?this._outlineArc.radius=this.getRadius():this.createOutlineArc(),this.circleProps=o,this.doneCreation=!0,this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer()},e.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new vi(this.id,t,this.pointProps),this._radiusPoint=new vi(this.id,t.clone(),this.pointProps),this._outlineArc||this.createOutlineArc()),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.addLastPoint=function(t){!this.doneCreation&&this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this.doneCreation=!0,this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.movePoint=function(t){this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this._outlineArc.radius=this.getRadius(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.moveCircle=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getRadius(),n=q.getPositionsDelta(this.lastDraggedToPosition,e),o=q.addDeltaToPosition(this.getCenter(),n,!0);this._center.setPosition(o),this.radiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),i,Math.PI/2,!0)),this._outlineArc.radius=this.getRadius(),this._outlineArc.center=this._center.getPosition(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer(),this.lastDraggedToPosition=e}},e.prototype.endMovePolygon=function(){this.lastDraggedToPosition=void 0},e.prototype.getRadius=function(){return this._center&&this._radiusPoint?q.distance(this._center.getPosition(),this._radiusPoint.getPosition()):0},e.prototype.getRadiusCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRadius.bind(this),!1)},e.prototype.getCenter=function(){return this._center?this._center.getPosition():void 0},e.prototype.getCenterCallbackProperty=function(){return new Cesium.CallbackProperty(this.getCenter.bind(this),!1)},e.prototype.getRadiusPoint=function(){return this._radiusPoint?this._radiusPoint.getPosition():void 0},e.prototype.dispose=function(){this._center&&this.pointsLayer.remove(this._center.getId()),this._radiusPoint&&this.pointsLayer.remove(this._radiusPoint.getId()),this._outlineArc&&this.arcsLayer.remove(this._outlineArc.getId()),this.circlesLayer.remove(this.id)},e.prototype.getId=function(){return this.id},e.prototype.updateCirclesLayer=function(){this.circlesLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._radiusPoint&&this.pointsLayer.update(this._radiusPoint,this._radiusPoint.getId())},e.prototype.updateArcsLayer=function(){this._outlineArc&&this.arcsLayer.update(this._outlineArc,this._outlineArc.getId())},e.prototype.createOutlineArc=function(){this._center&&this._radiusPoint&&(this._outlineArc=new xi(this.id,this.getCenter(),this.getRadius(),2*Math.PI,0,this.polylineProps))},e}(fe),ki=function(){function t(){this.circles=new Map}return t.prototype.createEditableCircle=function(t,e,i,n,o){var r=new ji(t,e,i,n,o);return this.circles.set(t,r),r},t.prototype.dispose=function(t){var e=this.circles.get(t);e&&e.dispose(),this.circles.delete(t)},t.prototype.get=function(t){return this.circles.get(t)},t.prototype.clear=function(){this.circles.forEach((function(t){return t.dispose()})),this.circles.clear()},t}();ki.decorators=[{type:e.Injectable}];var Ni={addPointEvent:t.CesiumEvent.LEFT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,circleProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,outline:!1,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{width:1,material:function(){return Cesium.Color.WHITE.withAlpha(.8)}}},Fi=function(){function e(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return e.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.circlesManager=n,this.updatePublisher.connect()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.create=function(e,i){var n,o=this;void 0===e&&(e=Ni),void 0===i&&(i=100);var r=Ei(),a=this.setOptions(e),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.CREATE}),p=!1;this.updateSubject.next({id:r,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,circleOptions:a});var l=function(e){var s={id:r,center:n,radiusPoint:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.ADD_LAST_POINT};o.updateSubject.next(s),c.next(Object.assign(Object.assign({},s),o.getCircleProperties(r)));var l={id:r,center:n,radiusPoint:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return o.updateSubject.next(l),c.next(Object.assign(Object.assign({},s),o.getCircleProperties(r))),o.observablesMap.has(r)&&o.observablesMap.get(r).forEach((function(t){return t.dispose()})),o.observablesMap.delete(r),o.editCircle(r,i,c,a,h),p=!0},d=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i}),u=this.mapEventsManager.register({event:t.CesiumEvent.LEFT_CLICK,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i});this.observablesMap.set(r,[d,u]);var h=this.createEditorObservable(c,r,l);return u.subscribe((function(e){var i=e.movement.endPosition;if(!p){var s=o.coordinateConverter.screenToCartesian3(i);if(s)if(n)p=l(s);else{var a={id:r,center:s,editMode:t.EditModes.CREATE,editAction:t.EditActions.ADD_POINT};o.updateSubject.next(a),c.next(Object.assign(Object.assign({},a),o.getCircleProperties(r))),n=s}}})),d.subscribe((function(e){var i=e.movement.endPosition;if(n){var s=o.coordinateConverter.screenToCartesian3(i);if(s){var a={id:r,center:n,radiusPoint:s,editMode:t.EditModes.CREATE,editAction:t.EditActions.MOUSE_MOVE};o.updateSubject.next(a),c.next(Object.assign(Object.assign({},a),o.getCircleProperties(r)))}}})),h},e.prototype.edit=function(e,i,n,o){void 0===n&&(n=Ni),void 0===o&&(o=100);var r=Ei(),a=this.setOptions(n),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.EDIT}),p={id:r,center:e,radiusPoint:q.pointByLocationDistanceAndAzimuth(e,i,Math.PI/2,!0),editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,circleOptions:a};return this.updateSubject.next(p),c.next(Object.assign(Object.assign({},p),this.getCircleProperties(r))),this.editCircle(r,o,c,a)},e.prototype.editCircle=function(e,i,n,o,s){var a,c=this,p=this.mapEventsManager.register({event:t.CesiumEvent.LEFT_CLICK_DRAG,entityType:vi,pickConfig:o.pickConfiguration,pick:t.PickOptions.PICK_FIRST,priority:i,pickFilter:function(t){return e===t.editedEntityId}});o.allowDrag&&(a=this.mapEventsManager.register({event:t.CesiumEvent.LEFT_CLICK_DRAG,entityType:ji,pickConfig:o.pickConfiguration,pick:t.PickOptions.PICK_FIRST,priority:i,pickFilter:function(t){return e===t.id}})),p.pipe(r.tap((function(t){var e=t.movement.drop;return c.cameraService.enableInputs(e)}))).subscribe((function(i){var r=i.movement,s=r.endPosition,a=r.startPosition,p=r.drop,l=i.entities,d=c.coordinateConverter.screenToCartesian3(a),u=c.coordinateConverter.screenToCartesian3(s);if(u){var h,g=l[0]===c.getCenterPoint(e);if(h=p?g?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_POINT_FINISH:g?t.EditActions.DRAG_SHAPE:t.EditActions.DRAG_POINT,o.allowDrag||h!==t.EditActions.DRAG_SHAPE&&h!==t.EditActions.DRAG_SHAPE_FINISH){var y={id:e,center:c.getCenterPosition(e),radiusPoint:c.getRadiusPosition(e),startDragPosition:d,endDragPosition:u,editMode:t.EditModes.EDIT,editAction:h};c.updateSubject.next(y),n.next(Object.assign(Object.assign({},y),c.getCircleProperties(e)))}else c.cameraService.enableInputs(!0)}})),a&&a.pipe(r.tap((function(t){var e=t.movement.drop;return c.cameraService.enableInputs(e)}))).subscribe((function(i){var o=i.movement,r=o.startPosition,s=o.endPosition,a=o.drop,p=c.coordinateConverter.screenToCartesian3(r),l=c.coordinateConverter.screenToCartesian3(s);if(l&&p){var d={id:e,center:c.getCenterPosition(e),radiusPoint:c.getRadiusPosition(e),startDragPosition:p,endDragPosition:l,editMode:t.EditModes.EDIT,editAction:a?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE};c.updateSubject.next(d),n.next(Object.assign(Object.assign({},d),c.getCircleProperties(e)))}}));var l=[p];return a&&l.push(a),this.observablesMap.set(e,l),s||this.createEditorObservable(n,e)},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,center:o.getCenterPosition(i),radiusPoint:o.getRadiusPosition(i),editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,center:o.getCenterPosition(i),radiusPoint:o.getRadiusPosition(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,center:o.getCenterPosition(i),radiusPoint:o.getRadiusPosition(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n,r,s,a){var c=q.pointByLocationDistanceAndAzimuth(e,n,Math.PI/2,!0);o.circlesManager.get(i).setManually(e,c,r,s,a),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Circles editor error edit(): cannot call finishCreation() on edit");return n(null)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.circlesManager.get(i).labels},e.getCenter=function(){return o.getCenterPosition(i)},e.getRadius=function(){return o.getRadius(i)},e},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Ni)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Ni.pointProps,t.pointProps),i.circleProps=Object.assign({},Ni.circleProps,t.circleProps),i.polylineProps=Object.assign({},Ni.polylineProps,t.polylineProps),i},e.prototype.getCenterPosition=function(t){return this.circlesManager.get(t).getCenter()},e.prototype.getCenterPoint=function(t){return this.circlesManager.get(t).center},e.prototype.getRadiusPosition=function(t){return this.circlesManager.get(t).getRadiusPoint()},e.prototype.getRadius=function(t){return this.circlesManager.get(t).getRadius()},e.prototype.getCircleProperties=function(t){var e=this.circlesManager.get(t);return{center:e.getCenter(),radiusPoint:e.getRadiusPoint(),radius:e.getRadius()}},e}();Fi.decorators=[{type:e.Injectable}];var Hi=function(){function e(t,e,i,n,o){this.circlesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.circlesManager=o,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editCircles$=new s.Subject,this.editArcs$=new s.Subject,this.circlesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.circlesManager),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.circlesEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.radiusPoint=t.getRadiusPoint(),e.radius=t.getRadius(),i)return t.labels=i,void this.editCirclesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editCirclesLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.editCirclesLayer.update(t,t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.circlesManager.createEditableCircle(e.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,e.circleOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.circlesManager.get(e.id);e.radiusPoint&&(i.movePoint(e.radiusPoint),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.circlesManager.get(e.id);e.center&&(i.addPoint(e.center),this.renderEditLabels(i,e));break;case t.EditActions.ADD_LAST_POINT:i=this.circlesManager.get(e.id);e.radiusPoint&&(i.addLastPoint(e.radiusPoint),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.circlesManager.get(e.id))&&(this.removeEditLabels(i),this.circlesManager.dispose(e.id));break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.circlesManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.circlesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.circlesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:(i=this.circlesManager.createEditableCircle(e.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,e.circleOptions)).setManually(e.center,e.radiusPoint);break;case t.EditActions.DRAG_POINT_FINISH:case t.EditActions.DRAG_POINT:(i=this.circlesManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.endDragPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.circlesManager.get(e.id))&&i.enableEdit&&(i.moveCircle(e.startDragPosition,e.endDragPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:(i=this.circlesManager.get(e.id))&&i.enableEdit&&(i.endMovePolygon(),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.circlesManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:var i;(i=this.circlesManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.circlesManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();Hi.decorators=[{type:e.Component,args:[{selector:"circles-editor",template:'\n      <ac-layer #editArcsLayer acFor="let arc of editArcs$" [context]="this">\n          <ac-arc-desc\n                  props="{\n        angle: arc.angle,\n        delta: arc.delta,\n        center: arc.center,\n        radius: arc.radius,\n        quality: 30,\n        color: arc.props.material()\n    }"\n          >\n          </ac-arc-desc>\n      </ac-layer>\n\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc\n                  props="{\n                    position: point.getPositionCallbackProperty(),\n                    pixelSize: getPointSize(point),\n                    color: point.props.color,\n                    outlineColor: point.props.outlineColor,\n                    outlineWidth: point.props.outlineWidth,\n                    show: getPointShow(point),\n                    disableDepthTestDistance: point.props.disableDepthTestDistance,\n                    heightReference: point.props.heightReference,\n    }"\n          >\n          </ac-point-desc>\n      </ac-layer>\n\n      <ac-layer #editCirclesLayer acFor="let circle of editCircles$" [context]="this" [zIndex]="0">\n          <ac-ellipse-desc\n                  props="{\n                  position: circle.getCenterCallbackProperty(),\n                  semiMajorAxis: circle.getRadiusCallbackProperty(),\n                  semiMinorAxis: circle.getRadiusCallbackProperty(),\n                  material: circle.circleProps.material,\n                  outline: circle.circleProps.outline,\n                  height: 0\n                  outlineWidth: circle.circleProps.outlineWidth,\n                  outlineColor: circle.circleProps.outlineColor,\n                  fill: circle.circleProps.fill,\n                  classificationType: circle.circleProps.classificationType,\n                  zIndex: circle.circleProps.zIndex,\n                  shadows: circle.circleProps.shadows,\n    }"\n          >\n          </ac-ellipse-desc>\n\n          <ac-array-desc acFor="let label of circle.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc\n                      props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n              >\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n  ',providers:[G,ki],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Hi.ctorParameters=function(){return[{type:Fi},{type:G},{type:Mt},{type:V},{type:ki}]},Hi.propDecorators={editCirclesLayer:[{type:e.ViewChild,args:["editCirclesLayer"]}],editArcsLayer:[{type:e.ViewChild,args:["editArcsLayer"]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}]};var Vi=function(t){function e(e,i,n,o,r){var s=t.call(this)||this;return s.id=e,s.ellipsesLayer=i,s.pointsLayer=n,s.coordinateConverter=o,s.options=r,s._rotation=0,s.doneCreation=!1,s._enableEdit=!0,s._minorRadiusPoints=[],s._labels=[],s._ellipseProps=Object.assign({},r.ellipseProps),s._pointProps=Object.assign({},r.pointProps),s}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){var e=this;t&&this._center&&(this._labels=t.map((function(t,i){return t.position||(0===i?t.position=e._center.getPosition():1===i?t.position=e._majorRadiusPoint?Cesium.Cartesian3.midpoint(e.getCenter(),e._majorRadiusPoint.getPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3:2===i&&(t.position=e._minorRadiusPoints.length>0&&e._minorRadius?Cesium.Cartesian3.midpoint(e.getCenter(),e.getMinorRadiusPointPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3)),Object.assign({},_i,t)})))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ellipseProps",{get:function(){return this._ellipseProps},set:function(t){this._ellipseProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"majorRadiusPoint",{get:function(){return this._majorRadiusPoint},enumerable:!1,configurable:!0}),e.prototype.getMajorRadiusPointPosition=function(){if(this._majorRadiusPoint)return this._majorRadiusPoint.getPosition()},e.prototype.getMinorRadiusPointPosition=function(){if(!(this._minorRadiusPoints.length<1))return this._minorRadiusPoints[0].getPosition()},Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._majorRadiusPoint.show=t,this.updatePointsLayer()},enumerable:!1,configurable:!0}),e.prototype.setManually=function(t,e,i,n,o,r,s){if(void 0===i&&(i=Math.PI/2),void 0===o&&(o=this.pointProps),void 0===r&&(r=this.pointProps),void 0===s&&(s=this.ellipseProps),e<n)throw new Error("Major radius muse be equal or greater than minor radius");this._rotation=i,this._majorRadius=e,this._center?this._center.setPosition(t):this._center=new vi(this.id,t,o);var a=q.pointByLocationDistanceAndAzimuth(this.center.getPosition(),e,i);this._majorRadiusPoint?this._majorRadiusPoint.setPosition(a):this._majorRadiusPoint=new vi(this.id,a,r),n&&(this._minorRadius=n),this.ellipseProps=s,this.doneCreation=!0,this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()},e.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new vi(this.id,t,this.pointProps),this._majorRadiusPoint=new vi(this.id,t.clone(),this.pointProps),this._majorRadius=0),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},e.prototype.transformToEllipse=function(){this._minorRadius||(this._minorRadius=this.getMajorRadius(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},e.prototype.addLastPoint=function(t){if(!this.doneCreation&&this._center&&this._majorRadiusPoint){var e=q.distance(this._center.getPosition(),t);this._majorRadiusPoint.setPosition(t),this._majorRadius=e,this.doneCreation=!0,this.options.circleToEllipseTransformation||(this._minorRadius=this._majorRadius),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},e.prototype.movePoint=function(t,e){if(this._center&&this._majorRadiusPoint){var i=q.distance(this._center.getPosition(),t);this.majorRadiusPoint===e?i<this._minorRadius?(this._majorRadius=this._minorRadius,this._majorRadiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),this._minorRadius,this._rotation))):(this.majorRadiusPoint.setPosition(t),this._majorRadius=i):i>this._majorRadius?this._minorRadius=this._majorRadius:this._minorRadius=i,this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},e.prototype.moveEllipse=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getMajorRadius(),n=this.getRotation(),o=q.getPositionsDelta(this.lastDraggedToPosition,e),r=q.addDeltaToPosition(this.getCenter(),o,!0);this._center.setPosition(r),this.majorRadiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),i,n)),this.updatePointsLayer(),this.updateMinorRadiusEditPoints(),this.updateEllipsesLayer(),this.lastDraggedToPosition=e}},e.prototype.endMoveEllipse=function(){this.lastDraggedToPosition=void 0},e.prototype.updateMinorRadiusEditPoints=function(){void 0!==this._minorRadius&&(0===this._minorRadiusPoints.length&&(this._minorRadiusPoints.push(new vi(this.id,new Cesium.Cartesian3,this.pointProps,!0)),this._minorRadiusPoints.push(new vi(this.id,new Cesium.Cartesian3,this.pointProps,!0))),this._minorRadiusPoints[0].setPosition(q.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()-Math.PI/2)),this._minorRadiusPoints[1].setPosition(q.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()+Math.PI/2)))},e.prototype.getMajorRadius=function(){return this._majorRadius||0},e.prototype.getMinorRadius=function(){return void 0===this._minorRadius?this.getMajorRadius():this._minorRadius},e.prototype.getRotation=function(){return this._rotation||0},e.prototype.updateRotation=function(){if(!this._majorRadiusPoint)return 0;var t=this.coordinateConverter.bearingToCartesian(this.getCenter(),this._majorRadiusPoint.getPosition());return this._rotation=Cesium.Math.toRadians(t),this._rotation},e.prototype.getRotationCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty((function(){return Math.PI/2-t.getRotation()}),!1)},e.prototype.getMinorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty((function(){return t.getMinorRadius()}),!1)},e.prototype.getMajorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty((function(){return t.getMajorRadius()}),!1)},e.prototype.getCenter=function(){return this._center?this._center.getPosition():void 0},e.prototype.getCenterCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty((function(){return t.getCenter()}),!1)},e.prototype.dispose=function(){var t=this;this._center&&this.pointsLayer.remove(this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.remove(this._majorRadiusPoint.getId()),this._minorRadiusPoints&&this._minorRadiusPoints.forEach((function(e){return t.pointsLayer.remove(e.getId())})),this.ellipsesLayer.remove(this.id)},e.prototype.getId=function(){return this.id},e.prototype.updateEllipsesLayer=function(){this.ellipsesLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.update(this._majorRadiusPoint,this._majorRadiusPoint.getId()),this._minorRadiusPoints.length>0&&(this.pointsLayer.update(this._minorRadiusPoints[0],this._minorRadiusPoints[0].getId()),this.pointsLayer.update(this._minorRadiusPoints[1],this._minorRadiusPoints[1].getId()))},e}(fe),Bi=function(){function t(){this.ellipses=new Map}return t.prototype.createEditableEllipse=function(t,e,i,n,o){var r=new Vi(t,e,i,n,o);return this.ellipses.set(t,r),r},t.prototype.dispose=function(t){this.ellipses.get(t).dispose(),this.ellipses.delete(t)},t.prototype.get=function(t){return this.ellipses.get(t)},t.prototype.clear=function(){this.ellipses.forEach((function(t){return t.dispose()})),this.ellipses.clear()},t}();Bi.decorators=[{type:e.Injectable}];var Ui={addPointEvent:t.CesiumEvent.LEFT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,circleToEllipseTransformEvent:t.CesiumEvent.LEFT_CLICK,circleToEllipseTransformEventModifier:t.CesiumEventModifier.ALT,allowDrag:!0,ellipseProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,outline:!0,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{width:1,material:function(){return Cesium.Color.WHITE}},circleToEllipseTransformation:!1},Gi=function(){function e(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return e.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.ellipsesManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.create=function(e,i){var n,o=this;void 0===e&&(e=Ui),void 0===i&&(i=100);var r=Ei(),a=this.setOptions(e),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.CREATE}),p=!1;this.updateSubject.next({id:r,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,ellipseOptions:a});var l=function(e){var s={id:r,center:n,updatedPosition:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.ADD_LAST_POINT};o.updateSubject.next(s),c.next(Object.assign({},s));var l={id:r,center:n,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return o.updateSubject.next(l),c.next(Object.assign({},s)),o.observablesMap.has(r)&&o.observablesMap.get(r).forEach((function(t){return t.dispose()})),o.observablesMap.delete(r),o.editEllipse(r,i,c,a,h),p=!0},d=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i}),u=this.mapEventsManager.register({event:a.addPointEvent,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i});this.observablesMap.set(r,[d,u]);var h=this.createEditorObservable(c,r,l);return u.subscribe((function(e){var i=e.movement.endPosition;if(!p){var s=o.coordinateConverter.screenToCartesian3(i);if(s)if(n)p=l(s);else{var a={id:r,center:s,editMode:t.EditModes.CREATE,editAction:t.EditActions.ADD_POINT};o.updateSubject.next(a),c.next(Object.assign({},a)),n=s}}})),d.subscribe((function(e){var i=e.movement.endPosition;if(n){var s=o.coordinateConverter.screenToCartesian3(i);if(s){var a={id:r,center:n,updatedPosition:s,editMode:t.EditModes.CREATE,editAction:t.EditActions.MOUSE_MOVE};o.updateSubject.next(a),c.next(Object.assign({},a))}}})),h},e.prototype.edit=function(e,i,n,o,r,a){void 0===n&&(n=Math.PI/2),void 0===r&&(r=Ui),void 0===a&&(a=100);var c=Ei(),p=this.setOptions(r),l=new s.BehaviorSubject({id:c,editAction:null,editMode:t.EditModes.EDIT}),d={id:c,center:e,majorRadius:i,rotation:n,minorRadius:o,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,ellipseOptions:p};return this.updateSubject.next(d),l.next(Object.assign({},d)),this.editEllipse(c,a,l,p)},e.prototype.editEllipse=function(e,i,n,o,s){var a,c,p=this,l=this.mapEventsManager.register({event:o.dragPointEvent,entityType:vi,pickConfig:o.pickConfiguration,pick:t.PickOptions.PICK_FIRST,priority:i,pickFilter:function(t){return e===t.editedEntityId}});o.circleToEllipseTransformation&&(a=this.mapEventsManager.register({event:o.circleToEllipseTransformEvent,modifier:o.circleToEllipseTransformEventModifier,entityType:Vi,pickConfig:o.pickConfiguration,pick:t.PickOptions.PICK_FIRST,priority:i,pickFilter:function(t){return e===t.id}})),o.allowDrag&&(c=this.mapEventsManager.register({event:o.dragShapeEvent,entityType:Vi,pickConfig:o.pickConfiguration,pick:t.PickOptions.PICK_FIRST,priority:i,pickFilter:function(t){return e===t.id}})),l.pipe(r.tap((function(t){var i=t.movement.drop;return p.ellipsesManager.get(e).enableEdit&&p.cameraService.enableInputs(i)}))).subscribe((function(i){var r=i.movement,s=r.endPosition,a=r.startPosition,c=r.drop,l=i.entities,d=p.coordinateConverter.screenToCartesian3(a),u=p.coordinateConverter.screenToCartesian3(s);if(u){var h,g=l[0],y=g===p.getCenterPoint(e);if(h=c?y?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_POINT_FINISH:y?t.EditActions.DRAG_SHAPE:t.EditActions.DRAG_POINT,o.allowDrag||!p.ellipsesManager.get(e).enableEdit||h!==t.EditActions.DRAG_SHAPE&&h!==t.EditActions.DRAG_SHAPE_FINISH){var f=Object.assign({id:e,updatedPoint:g,startDragPosition:d,endDragPosition:u,editMode:t.EditModes.EDIT,editAction:h},p.getEllipseProperties(e));p.updateSubject.next(f),n.next(Object.assign({},f))}else p.cameraService.enableInputs(!0)}})),a&&a.subscribe((function(i){var o=i.movement,r=(o.endPosition,o.startPosition,o.drop,i.entities,Object.assign({id:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.TRANSFORM},p.getEllipseProperties(e)));p.updateSubject.next(r),n.next(Object.assign({},r))})),c&&c.pipe(r.tap((function(t){var i=t.movement.drop;return p.ellipsesManager.get(e).enableEdit&&p.cameraService.enableInputs(i)}))).subscribe((function(i){var o=i.movement,r=o.startPosition,s=o.endPosition,a=o.drop,c=p.coordinateConverter.screenToCartesian3(r),l=p.coordinateConverter.screenToCartesian3(s);if(l&&c){var d=Object.assign({id:e,startDragPosition:c,endDragPosition:l,editMode:t.EditModes.EDIT,editAction:a?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE},p.getEllipseProperties(e));p.updateSubject.next(d),n.next(Object.assign({},d))}}));var d=[l];return c&&d.push(c),a&&d.push(a),this.observablesMap.set(e,d),s||this.createEditorObservable(n,e)},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next(Object.assign({id:i,editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE},o.getEllipseProperties(i)))},e.disable=function(){o.updateSubject.next(Object.assign({id:i,editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE},o.getEllipseProperties(i)))},e.setManually=function(e,n,r,s,a,c,p){o.ellipsesManager.get(i).setManually(e,n,r,s,a,c,p),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Ellipses editor error edit(): cannot call finishCreation() on edit");return n(null)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.ellipsesManager.get(i).labels},e.getCenter=function(){return o.getCenterPosition(i)},e.getMajorRadius=function(){return o.getMajorRadius(i)},e.getMinorRadius=function(){return o.getMinorRadius(i)},e},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Ui)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Ui.pointProps,t.pointProps),i.ellipseProps=Object.assign({},Ui.ellipseProps,t.ellipseProps),i.polylineProps=Object.assign({},Ui.polylineProps,t.polylineProps),i},e.prototype.getCenterPosition=function(t){return this.ellipsesManager.get(t).getCenter()},e.prototype.getCenterPoint=function(t){return this.ellipsesManager.get(t).center},e.prototype.getMajorRadius=function(t){return this.ellipsesManager.get(t).getMajorRadius()},e.prototype.getMinorRadius=function(t){return this.ellipsesManager.get(t).getMinorRadius()},e.prototype.getEllipseProperties=function(t){var e=this.ellipsesManager.get(t);return{center:e.getCenter(),rotation:e.getRotation(),minorRadius:e.getMinorRadius(),majorRadius:e.getMajorRadius(),minorRadiusPointPosition:e.getMinorRadiusPointPosition(),majorRadiusPointPosition:e.getMajorRadiusPointPosition()}},e}();Gi.decorators=[{type:e.Injectable}];var Ki=function(){function e(t,e,i,n,o,r){this.ellipsesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.ellipsesManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editEllipses$=new s.Subject,this.ellipsesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.ellipsesManager,this.cesiumService),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.ellipsesEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.majorRadius=t.getMajorRadius(),e.minorRadius=t.getMinorRadius(),e.rotation=t.getRotation(),i)return t.labels=i,void this.editEllipsesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editEllipsesLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.editEllipsesLayer.update(t,t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.ellipsesManager.createEditableEllipse(e.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,e.ellipseOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.ellipsesManager.get(e.id);e.updatedPosition&&(i.movePoint(e.updatedPosition,i.majorRadiusPoint),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.ellipsesManager.get(e.id);e.center&&(i.addPoint(e.center),this.renderEditLabels(i,e));break;case t.EditActions.ADD_LAST_POINT:i=this.ellipsesManager.get(e.id);e.updatedPosition&&(i.addLastPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.ellipsesManager.get(e.id))&&(this.removeEditLabels(i),this.ellipsesManager.dispose(e.id));break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.ellipsesManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.ellipsesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.ellipsesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:(i=this.ellipsesManager.createEditableEllipse(e.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,e.ellipseOptions)).setManually(e.center,e.majorRadius,e.rotation,e.minorRadius,e.ellipseOptions&&e.ellipseOptions.pointProps||void 0,e.ellipseOptions&&e.ellipseOptions.pointProps||void 0,e.ellipseOptions&&e.ellipseOptions.ellipseProps||void 0),this.renderEditLabels(i,e);break;case t.EditActions.DRAG_POINT_FINISH:case t.EditActions.DRAG_POINT:(i=this.ellipsesManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.endDragPosition,e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.ellipsesManager.get(e.id))&&i.enableEdit&&(i.moveEllipse(e.startDragPosition,e.endDragPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:(i=this.ellipsesManager.get(e.id))&&i.enableEdit&&(i.endMoveEllipse(),this.renderEditLabels(i,e));break;case t.EditActions.TRANSFORM:(i=this.ellipsesManager.get(e.id))&&i.enableEdit&&(i.transformToEllipse(),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.ellipsesManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:var i;(i=this.ellipsesManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.ellipsesManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();Ki.decorators=[{type:e.Component,args:[{selector:"ellipses-editor",template:'\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc\n                  props="{\n                    position: point.getPositionCallbackProperty(),\n                    pixelSize: getPointSize(point),\n                    color: point.props.color,\n                    outlineColor: point.props.outlineColor,\n                    outlineWidth: point.props.outlineWidth,\n                    show: getPointShow(point),\n                    disableDepthTestDistance: point.props.disableDepthTestDistance,\n                    heightReference: point.props.heightReference,\n    }"\n          >\n          </ac-point-desc>\n      </ac-layer>\n\n      <ac-layer #editEllipsesLayer acFor="let ellipse of editEllipses$" [context]="this" [zIndex]="0">\n          <ac-ellipse-desc\n                  props="{\n                    position: ellipse.getCenterCallbackProperty(),\n                    semiMajorAxis: ellipse.getMajorRadiusCallbackProperty(),\n                    semiMinorAxis: ellipse.getMinorRadiusCallbackProperty(),\n                    rotation: ellipse.getRotationCallbackProperty(),\n                    material: ellipse.ellipseProps.material,\n                    outline: ellipse.ellipseProps.outline,\n                    outlineWidth: ellipse.ellipseProps.outlineWidth,\n                    outlineColor: ellipse.ellipseProps.outlineColor,\n                    height: 0,\n                    fill: ellipse.ellipseProps.fill,\n                    classificationType: ellipse.ellipseProps.classificationType,\n                    zIndex: ellipse.ellipseProps.zIndex,\n                    shadows: ellipse.ellipseProps.shadows,\n    }"\n          >\n          </ac-ellipse-desc>\n\n          <ac-array-desc acFor="let label of ellipse.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc\n                      props="{\n                        position: label.position,\n                        text: label.text,\n                        backgroundColor: label.backgroundColor,\n                        backgroundPadding: label.backgroundPadding,\n                        distanceDisplayCondition: label.distanceDisplayCondition,\n                        eyeOffset: label.eyeOffset,\n                        fillColor: label.fillColor,\n                        font: label.font,\n                        heightReference: label.heightReference,\n                        horizontalOrigin: label.horizontalOrigin,\n                        outlineColor: label.outlineColor,\n                        outlineWidth: label.outlineWidth,\n                        pixelOffset: label.pixelOffset,\n                        pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n                        scale: label.scale,\n                        scaleByDistance: label.scaleByDistance,\n                        show: label.show,\n                        showBackground: label.showBackground,\n                        style: label.style,\n                        translucencyByDistance: label.translucencyByDistance,\n                        verticalOrigin: label.verticalOrigin,\n                        disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n              >\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n  ',providers:[G,Bi],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Ki.ctorParameters=function(){return[{type:Gi},{type:G},{type:Mt},{type:V},{type:Bi},{type:f}]},Ki.propDecorators={editEllipsesLayer:[{type:e.ViewChild,args:["editEllipsesLayer"]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}]};var zi=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;return a.id=e,a.pointsLayer=i,a.polylinesLayer=n,a.coordinateConverter=o,a.editOptions=r,a.positions=[],a.polylines=[],a.doneCreation=!1,a._enableEdit=!0,a._labels=[],a._pointProps=Object.assign({},r.pointProps),a.props=Object.assign({},r.polylineProps),s&&s.length>=2&&a.createFromExisting(s),a}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map((function(t,i){return t.position||(t.position=e[i]),Object.assign({},_i,t)}))}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"props",{get:function(){return this.polylineProps},set:function(t){this.polylineProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach((function(i){i.show=t,e.updatePointsLayer(!1,i)}))},enumerable:!1,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach((function(t){e.addPointFromExisting(t)})),this.addAllVirtualEditPoints(),this.doneCreation=!0},e.prototype.setManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polyline is created");this.positions.forEach((function(t){return i.pointsLayer.remove(t.getId())}));for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new vi(this.id,r.position,r.pointProps):new vi(this.id,r,this._pointProps),n.push(s)}this.positions=n,this.polylineProps=e||this.polylineProps,this.updatePointsLayer.apply(this,$([!0],this.positions)),this.addAllVirtualEditPoints()},e.prototype.addAllVirtualEditPoints=function(){var t=this,e=$(this.positions);e.forEach((function(i,n){if(n!==e.length-1){var o=i,r=(n+1)%e.length,s=e[r],a=t.setMiddleVirtualPoint(o,s);t.updatePointsLayer(!1,a)}}))},e.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartesian3.lerp(t.getPosition(),e.getPosition(),.5,new Cesium.Cartesian3),n=new vi(this.id,i,this._pointProps);n.setVirtualEditPoint(!0);var o=this.positions.indexOf(t);return this.positions.splice(o+1,0,n),n},e.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3);t.setPosition(n)},e.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),c=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!1,a,c,t)},e.prototype.renderPolylines=function(){var t=this;this.polylines.forEach((function(e){return t.polylinesLayer.remove(e.getId())})),this.polylines=[];var e=this.positions.filter((function(t){return!t.isVirtualEditPoint()}));e.forEach((function(i,n){if(n!==e.length-1){var o=e[n+1],r=new Ai(t.id,i.getPosition(),o.getPosition(),t.polylineProps);t.polylines.push(r),t.polylinesLayer.update(r,r.getId())}}))},e.prototype.addPointFromExisting=function(t){var e=new vi(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},e.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new vi(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new vi(this.id,t.clone(),this._pointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint)}},e.prototype.movePointFinish=function(t){this.editOptions.clampHeightTo3D&&(t.props.disableDepthTestDistance=Number.POSITIVE_INFINITY,this.updatePointsLayer(!1,t))},e.prototype.movePoint=function(t,e){if(e.setPosition(t),this.doneCreation){if(e.props.disableDepthTestDistance&&this.editOptions.clampHeightTo3D)return void(e.props.disableDepthTestDistance=void 0);e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e);if(n<this.positions.length-1){var o=this.positions[(n+1)%i],r=this.positions[(n+2)%i];this.updateMiddleVirtualPoint(o,e,r)}if(n>0){var s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(s,e,a)}}this.updatePointsLayer(!0,e)},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.moveShape=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=q.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach((function(t){var e=q.addDeltaToPosition(t.getPosition(),i,!0);t.setPosition(e)})),this.updatePointsLayer.apply(this,$([!0],this.positions)),this.lastDraggedToPosition=e}},e.prototype.endMoveShape=function(){this.lastDraggedToPosition=void 0,this.updatePointsLayer.apply(this,$([!0],this.positions))},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter((function(t){return t.isVirtualEditPoint()})).forEach((function(t){return e.removePosition(t)})),this.addAllVirtualEditPoints(),this.renderPolylines()},e.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.addAllVirtualEditPoints()},e.prototype.getRealPositions=function(){return this.getRealPoints().map((function(t){return t.getPosition()}))},e.prototype.getRealPoints=function(){var t=this;return this.positions.filter((function(e){return!e.isVirtualEditPoint()&&e!==t.movingPoint}))},e.prototype.getPoints=function(){var t=this;return this.positions.filter((function(e){return e!==t.movingPoint}))},e.prototype.getPositions=function(){return this.positions.map((function(t){return t.getPosition()}))},e.prototype.getPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositions.bind(this),!1)},e.prototype.removePosition=function(t){var e=this.positions.findIndex((function(e){return e===t}));e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach((function(t){return e.pointsLayer.update(t,t.getId())}))},e.prototype.update=function(){this.updatePointsLayer()},e.prototype.dispose=function(){var t=this;this.positions.forEach((function(e){t.pointsLayer.remove(e.getId())})),this.polylines.forEach((function(e){return t.polylinesLayer.remove(e.getId())})),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(fe),Wi=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;if(a.id=e,a.pointsLayer=i,a.rectangleLayer=n,a.coordinateConverter=o,a.positions=[],a.done=!1,a._enableEdit=!0,a._labels=[],a.defaultPointProps=Object.assign({},r.pointProps),a.rectangleProps=Object.assign({},r.rectangleProps),s&&2===s.length)a.createFromExisting(s);else if(s)throw new Error("Rectangle consist of 2 points but provided "+s.length);return a}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map((function(t,i){return t.position||(t.position=e[i]),Object.assign({},_i,t)}))}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rectangleProps",{get:function(){return this._rectangleProps},set:function(t){this._rectangleProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach((function(i){i.show=t,e.updatePointsLayer(i)}))},enumerable:!1,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach((function(t){e.addPointFromExisting(t)})),this.updateRectangleLayer(),this.updatePointsLayer.apply(this,$(this.positions)),this.done=!0},e.prototype.setPointsManually=function(t,e){var i=this;if(!this.done)throw new Error("Update manually only in edit mode, after rectangle is created");this.positions.forEach((function(t){return i.pointsLayer.remove(t.getId())})),this.positions=t,this.updatePointsLayer.apply(this,$(t)),this.updateRectangleLayer()},e.prototype.addPointFromExisting=function(t){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(e)},e.prototype.addPoint=function(t){if(!this.done)if(!this.positions.length){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.movingPoint=new vi(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(e)}else this.updatePointsLayer.apply(this,$(this.positions)),this.updateRectangleLayer(),this.done=!0,this.movingPoint=null},e.prototype.movePoint=function(t,e){e.isVirtualEditPoint()||(e.setPosition(t),this.updatePointsLayer.apply(this,$(this.positions)),this.updateRectangleLayer())},e.prototype.moveShape=function(t,e){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=Cesium.Cartographic.fromCartesian(this.lastDraggedToPosition),n=Cesium.Cartographic.fromCartesian(e);this.getRealPoints().forEach((function(t){var e=Cesium.Cartographic.fromCartesian(t.getPosition());e.longitude+=n.longitude-i.longitude,e.latitude+=n.latitude-i.latitude,t.setPosition(Cesium.Cartesian3.fromRadians(e.longitude,e.latitude,0))})),this.updatePointsLayer.apply(this,$(this.positions)),this.updateRectangleLayer(),this.lastDraggedToPosition=e},e.prototype.endMoveShape=function(){var t=this;this.lastDraggedToPosition=void 0,this.positions.forEach((function(e){return t.updatePointsLayer(e)})),this.updateRectangleLayer()},e.prototype.endMovePoint=function(){this.updatePointsLayer.apply(this,$(this.positions))},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter((function(t){return t.isVirtualEditPoint()})).forEach((function(t){return e.removePosition(t)}))},e.prototype.addLastPoint=function(t){this.done=!0,this.removePosition(this.movingPoint),this.movingPoint=null},e.prototype.getRealPositions=function(){return this.getRealPoints().map((function(t){return t.getPosition()}))},e.prototype.getRealPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRealPositions.bind(this),!1)},e.prototype.getRealPoints=function(){return this.positions.filter((function(t){return!t.isVirtualEditPoint()}))},e.prototype.getPositions=function(){return this.positions.map((function(t){return t.getPosition()}))},e.prototype.getRectangle=function(){var t=this.getPositions().map((function(t){return Cesium.Cartographic.fromCartesian(t)})),e=t.map((function(t){return t.longitude})),i=t.map((function(t){return t.latitude}));return new Cesium.Rectangle(Math.min.apply(Math,$(e)),Math.min.apply(Math,$(i)),Math.max.apply(Math,$(e)),Math.max.apply(Math,$(i)))},e.prototype.getRectangleCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRectangle.bind(this),!1)},e.prototype.removePosition=function(t){var e=this.positions.findIndex((function(e){return e===t}));e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePointsLayer=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach((function(e){return t.pointsLayer.update(e,e.getId())}))},e.prototype.updateRectangleLayer=function(){this.rectangleLayer.update(this,this.id)},e.prototype.dispose=function(){var t=this;this.rectangleLayer.remove(this.id),this.positions.forEach((function(e){t.pointsLayer.remove(e.getId())})),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(fe),$i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}(s.Observable),Yi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),Zi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),qi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),Xi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),Ji=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),Qi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),tn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return z(e,t),e}($i),en=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;if(a.id=e,a.pointsLayer=i,a.hippodromeLayer=n,a.coordinateConverter=o,a.positions=[],a.done=!1,a._enableEdit=!0,a._labels=[],a.defaultPointProps=Object.assign({},r.pointProps),a.hippodromeProps=Object.assign({},r.hippodromeProps),s&&2===s.length)a.createFromExisting(s);else if(s)throw new Error("Hippodrome consist of 2 points but provided "+s.length);return a}return z(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map((function(t,i){return t.position||(t.position=e[i]),Object.assign({},_i,t)}))}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hippodromeProps",{get:function(){return this._hippodromeProps},set:function(t){this._hippodromeProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach((function(i){i.show=t,e.updatePointsLayer(i)}))},enumerable:!1,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach((function(t){e.addPointFromExisting(t)})),this.createHeightEditPoints(),this.updateHippdromeLayer(),this.updatePointsLayer.apply(this,$(this.positions)),this.done=!0},e.prototype.setPointsManually=function(t,e){var i=this;if(!this.done)throw new Error("Update manually only in edit mode, after polyline is created");this.hippodromeProps.width=e||this.hippodromeProps.width,this.positions.forEach((function(t){return i.pointsLayer.remove(t.getId())})),this.positions=t,this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(t)),this.updateHippdromeLayer()},e.prototype.addPointFromExisting=function(t){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(e)},e.prototype.addPoint=function(t){if(!this.done)if(!this.positions.length){var e=new vi(this.id,t,this.defaultPointProps);this.positions.push(e),this.movingPoint=new vi(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(e)}else this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(this.positions)),this.updateHippdromeLayer(),this.done=!0,this.movingPoint=null},e.prototype.createHeightEditPoints=function(){var t=this;this.positions.filter((function(t){return t.isVirtualEditPoint()})).forEach((function(e){return t.removePosition(e)}));var e=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(e.getPosition(),i.getPosition()),r=Cesium.Math.toRadians(o)-Math.PI/2;this.createMiddleEditablePoint(n,r);var s=Cesium.Math.toRadians(o)+Math.PI/2;this.createMiddleEditablePoint(n,s)},e.prototype.createMiddleEditablePoint=function(t,e){var i=q.pointByLocationDistanceAndAzimuth(t,this.hippodromeProps.width/2,e,!0),n=new vi(this.id,i,this.defaultPointProps);n.setVirtualEditPoint(!0),this.positions.push(n)},e.prototype.movePoint=function(t,e){e.isVirtualEditPoint()?this.changeWidthByNewPoint(t):(e.setPosition(t),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(this.positions)),this.updateHippdromeLayer())},e.prototype.changeWidthByNewPoint=function(t){var e=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(n,t),r=o;o>270?r=o-270:o>180&&(r=o-180);var s=this.coordinateConverter.bearingToCartesian(e.getPosition(),i.getPosition());s>180&&(s=this.coordinateConverter.bearingToCartesian(i.getPosition(),e.getPosition()));var a=s>r?s-r:r-s;o>270&&(a=o-s);var c=Math.abs(q.distance(n,t)),p=Math.sin(Cesium.Math.toRadians(a))*c;this.hippodromeProps.width=2*Math.abs(p),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(this.positions)),this.updateHippdromeLayer()},e.prototype.moveShape=function(t,e){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=q.getPositionsDelta(this.lastDraggedToPosition,e);this.getRealPoints().forEach((function(t){var e=q.addDeltaToPosition(t.getPosition(),i,!0);t.setPosition(e)})),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(this.positions)),this.updateHippdromeLayer(),this.lastDraggedToPosition=e},e.prototype.endMoveShape=function(){var t=this;this.lastDraggedToPosition=void 0,this.createHeightEditPoints(),this.positions.forEach((function(e){return t.updatePointsLayer(e)})),this.updateHippdromeLayer()},e.prototype.endMovePoint=function(){this.createHeightEditPoints(),this.updatePointsLayer.apply(this,$(this.positions))},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter((function(t){return t.isVirtualEditPoint()})).forEach((function(t){return e.removePosition(t)}))},e.prototype.addLastPoint=function(t){this.done=!0,this.removePosition(this.movingPoint),this.movingPoint=null},e.prototype.getRealPositions=function(){return this.getRealPoints().map((function(t){return t.getPosition()}))},e.prototype.getRealPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRealPositions.bind(this),!1)},e.prototype.getRealPoints=function(){return this.positions.filter((function(t){return!t.isVirtualEditPoint()}))},e.prototype.getWidth=function(){return this.hippodromeProps.width},e.prototype.getPositions=function(){return this.positions.map((function(t){return t.getPosition()}))},e.prototype.removePosition=function(t){var e=this.positions.findIndex((function(e){return e===t}));e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePointsLayer=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach((function(e){return t.pointsLayer.update(e,e.getId())}))},e.prototype.updateHippdromeLayer=function(){this.hippodromeLayer.update(this,this.id)},e.prototype.dispose=function(){var t=this;this.hippodromeLayer.remove(this.id),this.positions.forEach((function(e){t.pointsLayer.remove(e.getId())})),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(fe),nn={addPointEvent:t.CesiumEvent.LEFT_CLICK,addLastPointEvent:t.CesiumEvent.LEFT_DOUBLE_CLICK,removePointEvent:t.CesiumEvent.RIGHT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.5),outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{material:function(){return Cesium.Color.BLACK},width:3,clampToGround:!1,zIndex:0,classificationType:Cesium.ClassificationType.BOTH},clampHeightTo3D:!1,clampHeightTo3DOptions:{clampToTerrain:!1,clampMostDetailed:!0,clampToHeightPickWidth:2}},on=function(){function e(){var t=this;this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map,this.clampPointsDebounced=Pi((function(e,i,n){t.clampPoints(e,i,n)}),300)}return e.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polylinesManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.clampPoints=function(t,e,i){var n=this,o=i.clampToTerrain,r=i.clampMostDetailed,s=i.clampToHeightPickWidth;if(e&&r){var a=this.polylinesManager.get(t).getPoints();if(o){var c=a.map((function(t){return n.coordinateConverter.cartesian3ToCartographic(t.getPosition())})),p=Cesium.sampleTerrain(this.cesiumScene.terrainProvider,11,c);Cesium.when(p,(function(t){a.forEach((function(e,i){e.setPosition(Cesium.Cartographic.toCartesian(t[i]))}))}))}else a.forEach((function(t){t.setPosition(n.cesiumScene.clampToHeight(t.getPosition(),void 0,s))}))}},e.prototype.screenToPosition=function(t,e,i){var n=this,o=i.clampToHeightPickWidth,r=i.clampToTerrain,s=this.coordinateConverter.screenToCartesian3(t);if(e&&s){var a=function(){var e=n.cameraService.getCamera().getPickRay(t);return n.cesiumScene.globe.pick(e,n.cesiumScene)};if(r)return a();var c=this.cesiumScene.pickPosition(t);return G.cartesian3ToLatLon(c).height<0?a():this.cesiumScene.clampToHeight(c,void 0,o)}return s},e.prototype.create=function(e,i){var n=this;void 0===e&&(e=nn),void 0===i&&(i=100);var o=[],r=Ei(),a=this.setOptions(e),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.CREATE}),p=!1;this.updateSubject.next({id:r,positions:o,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,polylineOptions:a});var l=function(t){return n.switchToEditMode(r,t,c,o,i,a,g,p)},d=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,priority:i,pickConfig:e.pickConfiguration}),u=this.mapEventsManager.register({event:a.addPointEvent,modifier:a.addPointModifier,pick:t.PickOptions.NO_PICK,priority:i,pickConfig:e.pickConfiguration}),h=this.mapEventsManager.register({event:a.addLastPointEvent,modifier:a.addLastPointModifier,pick:t.PickOptions.NO_PICK,priority:i,pickConfig:e.pickConfiguration});this.observablesMap.set(r,[d,u,h]);var g=this.createEditorObservable(c,r,l);return d.subscribe((function(e){var i=e.movement.endPosition,o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);o&&n.updateSubject.next({id:r,positions:n.getPositions(r),editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.MOUSE_MOVE})})),u.subscribe((function(e){var i=e.movement.endPosition;if(!p){var o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);if(o){var s=n.getPositions(r);if(!s.find((function(t){return t.equals(o)}))){var d={id:r,positions:s,editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),c.next(Object.assign(Object.assign({},d),{positions:n.getPositions(r),points:n.getPoints(r)})),a.maximumNumberOfPoints&&s.length+1===a.maximumNumberOfPoints&&(p=l(o))}}}})),h.subscribe((function(e){var i=e.movement.endPosition,o=n.screenToPosition(i,a.clampHeightTo3D,a.clampHeightTo3DOptions);if(o){var s=n.getPositions(r);if(!s.find((function(t){return t.equals(o)}))){var d={id:r,positions:s,editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),c.next(Object.assign(Object.assign({},d),{positions:n.getPositions(r),points:n.getPoints(r)}))}p=l(o)}})),g},e.prototype.switchToEditMode=function(e,i,n,o,r,s,a,c){var p={id:e,positions:this.getPositions(e),editMode:t.EditModes.CREATE,updatedPosition:i,editAction:t.EditActions.ADD_LAST_POINT};this.updateSubject.next(p),n.next(Object.assign(Object.assign({},p),{positions:this.getPositions(e),points:this.getPoints(e)}));var l={id:e,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return this.updateSubject.next(l),n.next(l),this.observablesMap.has(e)&&this.observablesMap.get(e).forEach((function(t){return t.dispose()})),this.observablesMap.delete(e),this.editPolyline(e,o,r,n,s,a),!0,true},e.prototype.edit=function(e,i,n){if(void 0===i&&(i=nn),void 0===n&&(n=100),e.length<2)throw new Error("Polylines editor error edit(): polyline should have at least 2 positions");var o=Ei(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.EDIT}),c={id:o,positions:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,polylineOptions:r};return this.updateSubject.next(c),a.next(Object.assign(Object.assign({},c),{positions:this.getPositions(o),points:this.getPoints(o)})),this.editPolyline(o,e,n,a,r)},e.prototype.editPolyline=function(e,i,n,o,s,a){var c=this;this.clampPoints(e,s.clampHeightTo3D,s.clampHeightTo3DOptions);var p,l=this.mapEventsManager.register({event:s.dragPointEvent,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}}),d=this.mapEventsManager.register({event:s.removePointEvent,modifier:s.removePointModifier,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}});s.allowDrag&&(p=this.mapEventsManager.register({event:s.dragShapeEvent,entityType:Ai,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}})),p&&p.pipe(r.tap((function(t){var i=t.movement.drop;return c.polylinesManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.startPosition,a=n.endPosition,p=n.drop,l=(i.entities,c.screenToPosition(a,!1,s.clampHeightTo3DOptions)),d=c.screenToPosition(r,!1,s.clampHeightTo3DOptions);if(l){var u={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:l,draggedPosition:d,editAction:p?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE};c.updateSubject.next(u),o.next(Object.assign(Object.assign({},u),{positions:c.getPositions(e),points:c.getPoints(e)}))}})),l.pipe(r.tap((function(t){var i=t.movement.drop;return c.polylinesManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.endPosition,a=n.drop,p=i.entities,l=c.screenToPosition(r,s.clampHeightTo3D,s.clampHeightTo3DOptions);if(l){var d=p[0],u={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:l,updatedPoint:d,editAction:a?t.EditActions.DRAG_POINT_FINISH:t.EditActions.DRAG_POINT};c.updateSubject.next(u),o.next(Object.assign(Object.assign({},u),{positions:c.getPositions(e),points:c.getPoints(e)})),c.clampPointsDebounced(e,s.clampHeightTo3D,s.clampHeightTo3DOptions)}})),d.subscribe((function(i){var n=i.entities[0],r=$(c.getPositions(e));if(!(r.length<3)&&!(r.findIndex((function(t){return n.getPosition().equals(t)}))<0)){var a={id:e,positions:r,editMode:t.EditModes.EDIT,updatedPoint:n,editAction:t.EditActions.REMOVE_POINT};c.updateSubject.next(a),o.next(Object.assign(Object.assign({},a),{positions:c.getPositions(e),points:c.getPoints(e)})),c.clampPoints(e,s.clampHeightTo3D,s.clampHeightTo3DOptions)}}));var u=[l,d];return p&&u.push(p),this.observablesMap.set(e,u),this.createEditorObservable(o,e)},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(nn)),i=Object.assign(e,t);if(i.pointProps=Object.assign(Object.assign({},nn.pointProps),t.pointProps),i.polylineProps=Object.assign(Object.assign({},nn.polylineProps),t.polylineProps),i.clampHeightTo3DOptions=Object.assign(Object.assign({},nn.clampHeightTo3DOptions),t.clampHeightTo3DOptions),t.clampHeightTo3D){if(!this.cesiumScene.pickPositionSupported||!this.cesiumScene.clampToHeightSupported)throw new Error("Cesium pickPosition and clampToHeight must be supported to use clampHeightTo3D");this.cesiumScene.pickTranslucentDepth&&console.warn("Cesium scene.pickTranslucentDepth must be false in order to make the editors work properly on 3D"),1!==i.pointProps.color.alpha&&1!==i.pointProps.outlineColor.alpha||console.warn("Point color and outline color must have alpha in order to make the editor work properly on 3D"),i.allowDrag=!1,i.polylineProps.clampToGround=!0,i.pointProps.heightReference=i.clampHeightTo3DOptions.clampToTerrain?Cesium.HeightReference.CLAMP_TO_GROUND:Cesium.HeightReference.RELATIVE_TO_GROUND,i.pointProps.disableDepthTestDistance=Number.POSITIVE_INFINITY}return i},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n){o.polylinesManager.get(i).setManually(e,n),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Polylines editor error edit(): cannot call finishCreation() on edit");return n(null)},e.getCurrentPoints=function(){return o.getPoints(i)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.polylinesManager.get(i).labels},e},e.prototype.getPositions=function(t){return this.polylinesManager.get(t).getRealPositions()},e.prototype.getPoints=function(t){return this.polylinesManager.get(t).getRealPoints()},e}();on.decorators=[{type:e.Injectable}];var rn=function(){function t(){this.polylines=new Map}return t.prototype.createEditablePolyline=function(t,e,i,n,o,r){var s=new zi(t,e,i,n,o,r);this.polylines.set(t,s)},t.prototype.get=function(t){return this.polylines.get(t)},t.prototype.clear=function(){this.polylines.forEach((function(t){return t.dispose()})),this.polylines.clear()},t}();rn.decorators=[{type:e.Injectable}];var sn=function(){function e(t,e,i,n,o,r){this.polylinesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polylinesManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editPolylines$=new s.Subject,this.polylineLabels$=new s.Subject,this.polylinesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o,this.cesiumService),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.polylinesEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.polylineLabelsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.polylineLabelsLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.polylineLabelsLayer.remove(t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.polylinesManager.createEditablePolyline(e.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,e.polylineOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.polylinesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.polylinesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),i.addPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_LAST_POINT:i=this.polylinesManager.get(e.id);e.updatedPosition&&(i.addLastPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.polylinesManager.get(e.id))&&(i.dispose(),this.removeEditLabels(i),this.editLabelsRenderFn=void 0);break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.polylinesManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.polylinesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.polylinesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.polylinesManager.createEditablePolyline(e.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,e.polylineOptions,e.positions);break;case t.EditActions.DRAG_POINT:(i=this.polylinesManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.updatedPosition,e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_POINT_FINISH:(i=this.polylinesManager.get(e.id))&&i.enableEdit&&(i.movePointFinish(e.updatedPoint),e.updatedPoint.isVirtualEditPoint()&&(i.changeVirtualPointToRealPoint(e.updatedPoint),this.renderEditLabels(i,e)));break;case t.EditActions.REMOVE_POINT:(i=this.polylinesManager.get(e.id))&&i.enableEdit&&(i.removePoint(e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.polylinesManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:(i=this.polylinesManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.polylinesManager.get(e.id))&&i.enableEdit&&(i.moveShape(e.draggedPosition,e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:var i;(i=this.polylinesManager.get(e.id))&&i.enableEdit&&(i.endMoveShape(),this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.polylinesManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();sn.decorators=[{type:e.Component,args:[{selector:"polylines-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-desc\n        props="{\n        positions: polyline.getPositionsCallbackProperty(),\n        width: polyline.props.width,\n        material: polyline.props.material(),\n        clampToGround: polyline.props.clampToGround,\n        zIndex: polyline.props.zIndex,\n        classificationType: polyline.props.classificationType,\n      }"\n      >\n      </ac-polyline-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      ></ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #polylineLabelsLayer acFor="let polylineLabels of polylineLabels$" [context]="this">\n      <ac-array-desc acFor="let label of polylineLabels.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[G,rn],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],sn.ctorParameters=function(){return[{type:on},{type:G},{type:Mt},{type:V},{type:rn},{type:f}]},sn.propDecorators={editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}],editPolylinesLayer:[{type:e.ViewChild,args:["editPolylinesLayer"]}],polylineLabelsLayer:[{type:e.ViewChild,args:["polylineLabelsLayer"]}]};var an=function(){function t(){this.hippodromes=new Map}return t.prototype.createEditableHippodrome=function(t,e,i,n,o,r){var s=new en(t,e,i,n,o,r);this.hippodromes.set(t,s)},t.prototype.get=function(t){return this.hippodromes.get(t)},t.prototype.clear=function(){this.hippodromes.forEach((function(t){return t.dispose()})),this.hippodromes.clear()},t}();an.decorators=[{type:e.Injectable}];var cn={addPointEvent:t.CesiumEvent.LEFT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,hippodromeProps:{fill:!0,material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),outline:!0,width:2e5,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY}},pn=function(){function e(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return e.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.hippodromeManager=n,this.updatePublisher.connect()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.create=function(e,i){var n=this;void 0===e&&(e=cn),void 0===i&&(i=100);var o=Ei(),r=this.setOptions(e),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.CREATE}),c=!1;this.updateSubject.next({id:o,positions:[],editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,hippodromeOptions:r});var p=function(){var e={id:o,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return n.updateSubject.next(e),a.next(e),n.observablesMap.has(o)&&n.observablesMap.get(o).forEach((function(t){return t.dispose()})),n.observablesMap.delete(o),n.editHippodrome(o,i,a,r,u),c=!0},l=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pickConfig:e.pickConfiguration,pick:t.PickOptions.NO_PICK,priority:i}),d=this.mapEventsManager.register({event:r.addPointEvent,pickConfig:e.pickConfiguration,pick:t.PickOptions.NO_PICK,priority:i});this.observablesMap.set(o,[l,d]);var u=this.createEditorObservable(a,o,p);return l.subscribe((function(e){var i=e.movement.endPosition,r=n.coordinateConverter.screenToCartesian3(i);r&&n.updateSubject.next({id:o,positions:n.getPositions(o),editMode:t.EditModes.CREATE,updatedPosition:r,editAction:t.EditActions.MOUSE_MOVE})})),d.subscribe((function(e){var i=e.movement.endPosition;if(!c){var r=n.coordinateConverter.screenToCartesian3(i);if(r){var s=n.getPositions(o),l=0===n.getPositions(o).length,d={id:o,positions:s,editMode:t.EditModes.CREATE,updatedPosition:r,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),a.next(Object.assign(Object.assign({},d),{positions:n.getPositions(o),points:n.getPoints(o),width:n.getWidth(o)})),l||(c=p())}}})),u},e.prototype.edit=function(e,i,n){if(void 0===i&&(i=cn),void 0===n&&(n=100),2!==e.length)throw new Error("Hippodrome editor error edit(): polygon should have 2 positions but received "+e);var o=Ei(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.EDIT}),c={id:o,positions:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,hippodromeOptions:r};return this.updateSubject.next(c),a.next(Object.assign(Object.assign({},c),{positions:this.getPositions(o),points:this.getPoints(o),width:this.getWidth(o)})),this.editHippodrome(o,n,a,r)},e.prototype.editHippodrome=function(e,i,n,o,s){var a,c=this;o.allowDrag&&(a=this.mapEventsManager.register({event:o.dragShapeEvent,entityType:en,pick:t.PickOptions.PICK_FIRST,pickConfig:o.pickConfiguration,priority:i,pickFilter:function(t){return e===t.id}}));var p=this.mapEventsManager.register({event:o.dragPointEvent,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:o.pickConfiguration,priority:i,pickFilter:function(t){return e===t.editedEntityId}});p.pipe(r.tap((function(t){var i=t.movement.drop;return c.hippodromeManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var o=i.movement,r=o.endPosition,s=o.drop,a=i.entities,p=c.coordinateConverter.screenToCartesian3(r);if(p){var l=a[0],d={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:p,updatedPoint:l,editAction:s?t.EditActions.DRAG_POINT_FINISH:t.EditActions.DRAG_POINT};c.updateSubject.next(d),n.next(Object.assign(Object.assign({},d),{positions:c.getPositions(e),points:c.getPoints(e),width:c.getWidth(e)}))}})),a&&a.pipe(r.tap((function(t){var i=t.movement.drop;return c.hippodromeManager.get(e).enableEdit&&c.cameraService.enableInputs(i)}))).subscribe((function(i){var o=i.movement,r=o.startPosition,s=o.endPosition,a=o.drop,p=(i.entities,c.coordinateConverter.screenToCartesian3(s)),l=c.coordinateConverter.screenToCartesian3(r);if(p){var d={id:e,positions:c.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:p,draggedPosition:l,editAction:a?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE};c.updateSubject.next(d),n.next(Object.assign(Object.assign({},d),{positions:c.getPositions(e),points:c.getPoints(e),width:c.getWidth(e)}))}}));var l=[p];return a&&l.push(a),this.observablesMap.set(e,l),this.createEditorObservable(n,e)},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(cn)),i=Object.assign(e,t);return i.hippodromeProps=Object.assign({},cn.hippodromeProps,t.hippodromeProps),i.pointProps=Object.assign({},cn.pointProps,t.pointProps),i},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n,r,s,a){var c=new vi(i,e,s||cn.pointProps),p=new vi(i,n,a||cn.pointProps);o.hippodromeManager.get(i).setPointsManually([c,p],r),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Hippodrome editor error edit(): cannot call finishCreation() on edit");return n()},e.getCurrentPoints=function(){return o.getPoints(i)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.hippodromeManager.get(i).labels},e.getCurrentWidth=function(){return o.getWidth(i)},e},e.prototype.getPositions=function(t){return this.hippodromeManager.get(t).getRealPositions()},e.prototype.getPoints=function(t){return this.hippodromeManager.get(t).getRealPoints()},e.prototype.getWidth=function(t){return this.hippodromeManager.get(t).getWidth()},e}();pn.decorators=[{type:e.Injectable}];var ln=function(){function e(t,e,i,n,o){this.hippodromesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.hippodromesManager=o,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editHippodromes$=new s.Subject,this.hippodromesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.hippodromesEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editHippodromesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editHippodromesLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.editHippodromesLayer.update(t,t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.hippodromesManager.createEditableHippodrome(e.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,e.hippodromeOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.hippodromesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.hippodromesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),i.addPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.hippodromesManager.get(e.id))&&(i.dispose(),this.removeEditLabels(i));break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.hippodromesManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.hippodromesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.hippodromesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.hippodromesManager.createEditableHippodrome(e.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,e.hippodromeOptions,e.positions);break;case t.EditActions.DRAG_POINT:(i=this.hippodromesManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.updatedPosition,e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_POINT_FINISH:(i=this.hippodromesManager.get(e.id))&&i.enableEdit&&(i.endMovePoint(),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.hippodromesManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:(i=this.hippodromesManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.hippodromesManager.get(e.id))&&i.enableEdit&&(i.moveShape(e.draggedPosition,e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:var i;(i=this.hippodromesManager.get(e.id))&&i.enableEdit&&(i.endMoveShape(),this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.hippodromesManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();ln.decorators=[{type:e.Component,args:[{selector:"hippodrome-editor",template:'\n      <ac-layer #editHippodromesLayer acFor="let hippodrome of editHippodromes$" [context]="this">\n          <ac-corridor-desc props="{\n            positions: hippodrome.getRealPositionsCallbackProperty(),\n            cornerType: Cesium.CornerType.ROUNDED,\n            material: hippodrome.hippodromeProps.material,\n            width : hippodrome.hippodromeProps.width,\n            outline: hippodrome.hippodromeProps.outline,\n            outlineColor: hippodrome.hippodromeProps.outlineColor,\n            outlineWidth: hippodrome.hippodromeProps.outlineWidth,\n            height: 0,\n            classificationType: hippodrome.hippodromeProps.classificationType,\n            zIndex: hippodrome.hippodromeProps.zIndex,\n            shadows: hippodrome.hippodromeProps.shadows,\n    }">\n          </ac-corridor-desc>\n\n          <ac-array-desc acFor="let label of hippodrome.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }">\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc props="{\n         position: point.getPositionCallbackProperty(),\n         pixelSize: getPointSize(point),\n         color: point.props.color,\n         outlineColor: point.props.outlineColor,\n         outlineWidth: point.props.outlineWidth,\n         show: getPointShow(point),\n         disableDepthTestDistance: point.props.disableDepthTestDistance,\n         heightReference: point.props.heightReference,\n    }">\n          </ac-point-desc>\n      </ac-layer>\n  ',providers:[G,an],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],ln.ctorParameters=function(){return[{type:pn},{type:G},{type:Mt},{type:V},{type:an}]},ln.propDecorators={editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}],editHippodromesLayer:[{type:e.ViewChild,args:["editHippodromesLayer"]}]};var dn=function(){function t(t,e){this.document=t,this.mapsManager=e,this.mainSubject=new s.Subject}return t.prototype.setCoordinateConverter=function(t){this.coordinateConverter=t},t.prototype.drag=function(t,e){var i=this;if(!this.coordinateConverter){var n=this.mapsManager.getMap();n&&(this.coordinateConverter=n.getCoordinateConverter())}this.cancel();var o=document.createElement("img");o.src=t,o.style.position="fixed",o.style.visibility="hidden",o.style.width="30px",o.style.height="30px",o.style["user-drag"]="none",o.style["user-select"]="none",o.style["-moz-user-select"]="none",o.style["-webkit-user-drag"]="none",o.style["-webkit-user-select"]="none",o.style["-ms-user-select"]="none",Object.assign(o.style,e),document.body.appendChild(o),this.createDragObservable(),this.dragObservable.subscribe((function(t){o.style.visibility="visible",o.style.left=t.screenPosition.x-o.clientWidth/2+"px",o.style.top=t.screenPosition.y-o.clientHeight/2+"px",i.mainSubject.next(t),t.drop&&o.remove()}),(function(t){o.remove()}),(function(){o.remove()}))},t.prototype.dragUpdates=function(){return this.mainSubject},t.prototype.cancel=function(){this.stopper&&(this.stopper.next(!0),this.stopper=void 0,this.dragObservable=void 0)},t.prototype.createDragObservable=function(){var t,e,i,n=this,o=new s.Subject,a=new s.Subject,c=s.fromEvent(document,"pointerup"),p=s.fromEvent(document,"pointermove").pipe(r.map((function(o){return t=t||o.x,e=e||o.y,i={drop:!1,initialScreenPosition:{x:t,y:e},screenPosition:{x:o.x,y:o.y},mapPosition:n.coordinateConverter?n.coordinateConverter.screenToCartesian3({x:o.x,y:o.y}):void 0}})),r.takeUntil(c),r.tap(void 0,void 0,(function(){if(i){var t=Object.assign({},i);t.drop=!0,a.next(t)}})));this.dragObservable=p.pipe(r.merge(a),r.takeUntil(o)),this.stopper=o},t}();dn.decorators=[{type:e.Injectable}],dn.ctorParameters=function(){return[{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]},{type:Tt}]};var un=function(){function t(t,e){this.iconDragService=e,t.nativeElement.style["user-drag"]="none",t.nativeElement.style["user-select"]="none",t.nativeElement.style["-moz-user-select"]="none",t.nativeElement.style["-webkit-user-drag"]="none",t.nativeElement.style["-webkit-user-select"]="none",t.nativeElement.style["-ms-user-select"]="none"}return t.prototype.ngOnInit=function(){"string"==typeof this.draggableToMap?this.src=this.draggableToMap:(this.src=this.draggableToMap.src,this.style=this.draggableToMap.style)},t.prototype.onMouseDown=function(){this.iconDragService.drag(this.src,this.style)},t}();un.decorators=[{type:e.Directive,args:[{selector:"[draggableToMap]"}]}],un.ctorParameters=function(){return[{type:e.ElementRef},{type:dn}]},un.propDecorators={draggableToMap:[{type:e.Input}],onMouseDown:[{type:e.HostListener,args:["mousedown"]}]};var hn=function(){function t(t,i){this.element=t,this.cesiumService=i,this.allowDrag=!0,this.onDrag=new e.EventEmitter,this.dragStyle={"height.px":20,"width.px":20}}return t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.element.nativeElement),this.allowDrag&&this.listenForDragging()},t.prototype.ngOnChanges=function(t){t.allowDrag&&t.allowDrag.currentValue&&!t.allowDrag.previousValue&&this.listenForDragging(),t.allowDrag&&!t.allowDrag.currentValue&&t.allowDrag.previousValue&&this.dragSubscription.unsubscribe()},t.prototype.ngOnDestroy=function(){this.dragSubscription&&this.dragSubscription.unsubscribe()},t.prototype.listenForDragging=function(){var t=this;this.mouseDown$=this.mouseDown$||s.fromEvent(this.element.nativeElement,"mousedown"),this.mouseMove$=this.mouseMove$||s.fromEvent(document,"mousemove"),this.mouseUp$=this.mouseUp$||s.fromEvent(document,"mouseup"),this.drag$=this.drag$||this.mouseDown$.pipe(r.switchMap((function(){return t.mouseMove$.pipe(r.tap(t.onDrag.emit),r.takeUntil(t.mouseUp$))}))),this.dragSubscription=this.drag$.subscribe((function(e){t.element.nativeElement.style.left=e.x+"px",t.element.nativeElement.style.top=e.y+"px"}))},t}();hn.decorators=[{type:e.Component,args:[{selector:"ac-toolbar",template:'\n        <div class="{{toolbarClass}}">\n            <div *ngIf="allowDrag">\n                <ac-toolbar-button>\n                    <ac-drag-icon></ac-drag-icon>\n                </ac-toolbar-button>\n            </div>\n\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,styles:["\n        :host {\n            position: absolute;\n            top: 20px;\n            left: 20px;\n            width: 20px;\n            height: 20px;\n            z-index: 999;\n            -webkit-user-drag: none;\n        }\n    "]}]}],hn.ctorParameters=function(){return[{type:e.ElementRef},{type:f}]},hn.propDecorators={toolbarClass:[{type:e.Input}],allowDrag:[{type:e.Input}],onDrag:[{type:e.Output}]};var gn=function(){};gn.decorators=[{type:e.Component,args:[{selector:"ac-drag-icon",template:'\n        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"  x="0px" y="0px"  height="25"  width="25"\n\t viewBox="0 0 476.737 476.737" style="enable-background:new 0 0 476.737 476.737;" xml:space="preserve">\n<g>\n\t<g>\n\t\t<path style="fill:#010002;" d="M475.498,232.298l-3.401-5.149l-63.565-63.565c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tc-6.198,6.198-6.198,16.273,0,22.47l36.423,36.423H254.26V54.253l36.423,36.423c6.166,6.198,16.273,6.198,22.47,0\n\t\t\tc6.166-6.198,6.166-16.273,0-22.47L249.588,4.64l-0.159-0.095l-4.99-3.305L238.369,0h-0.064l-6.007,1.24l-4.99,3.305l-0.191,0.095\n\t\t\tl-63.565,63.565c-6.198,6.198-6.198,16.273,0,22.47s16.273,6.198,22.47,0l36.455-36.423v168.225H54.253l36.423-36.423\n\t\t\tc6.198-6.198,6.198-16.273,0-22.47s-16.273-6.198-22.47,0L4.64,227.149l-0.095,0.159l-3.305,4.99L0,238.369v0.064l1.24,6.007\n\t\t\tl3.305,4.958l0.095,0.191l63.565,63.565c6.198,6.198,16.273,6.198,22.47,0c6.198-6.166,6.198-16.273,0-22.47L54.253,254.26\n\t\t\th168.225v168.225l-36.423-36.423c-6.198-6.166-16.273-6.166-22.47,0c-6.198,6.198-6.198,16.304,0,22.47l63.565,63.565l5.149,3.432\n\t\t\tl6.007,1.208h0.064l6.07-1.24l5.149-3.401l63.565-63.565c6.166-6.198,6.166-16.304,0-22.47c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tl-36.423,36.423V254.26h168.225l-36.423,36.423c-6.166,6.166-6.166,16.273,0,22.47c6.198,6.166,16.304,6.166,22.47,0\n\t\t\tl63.565-63.565l3.432-5.149l1.208-6.007v-0.064L475.498,232.298z"/>\n\t</g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n</svg>\n    '}]}],gn.ctorParameters=function(){return[]};var yn=function(){function t(){this.onClick=new e.EventEmitter}return t.prototype.ngOnInit=function(){},t}();yn.decorators=[{type:e.Component,args:[{selector:"ac-toolbar-button",template:'\n        <div (click)="onClick.emit()" class="button-container {{buttonClass}}">\n            <img *ngIf="iconUrl" [src]="iconUrl" class="icon {{iconClass}}"/>\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,styles:["\n        .button-container {\n            border-radius: 1px;\n            background-color: rgba(255, 255, 255, 0.8);\n            height: 30px;\n            width: 30px;\n            padding: 5px;\n            transition: all 0.2s;\n            cursor: pointer;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            flex-direction: column;\n        }\n\n        .button-container:hover {\n            background-color: rgba(255, 255, 255, 0.95);\n        }\n\n        .icon {\n            height: 30px;\n            width: 30px;\n        }\n    "]}]}],yn.ctorParameters=function(){return[]},yn.propDecorators={iconUrl:[{type:e.Input}],buttonClass:[{type:e.Input}],iconClass:[{type:e.Input}],onClick:[{type:e.Output}]};var fn,mn=function(){function e(t,e){this.polylineEditor=t,this.coordinateConverter=e,this.lineEditOptions={},this.labelsStyle={},this.distanceLabelsStyle={},this.bearingLabelsStyle={}}return e.prototype.create=function(e){var i=this,n=void 0===e?{lineEditOptions:{},labelsStyle:{},distanceLabelsStyle:{},bearingLabelsStyle:{}}:e,o=n.lineEditOptions,r=void 0===o?{}:o,s=n.labelsStyle,a=void 0===s?{}:s,c=n.distanceLabelsStyle,p=void 0===c?{}:c,l=n.bearingLabelsStyle,d=void 0===l?{}:l,u=n.bearingStringFn,h=n.distanceStringFn,g=n.labelsRenderFn,y=this.polylineEditor.create(Object.assign(Object.assign({allowDrag:!1,pointProps:{showVirtual:!1,pixelSize:8},polylineProps:{width:2}},this.lineEditOptions),r));return g?y.setLabelsRenderFn(g):this.labelsRenderFn?y.setLabelsRenderFn(this.labelsRenderFn):y.setLabelsRenderFn((function(e){var n=e.positions,o=0;return n&&0!==n.length?(e.editMode===t.EditModes.CREATE&&e.editAction!==t.EditActions.ADD_LAST_POINT?$(n,[e.updatedPosition]):n).reduce((function(t,e,n,r){if(0!==n){var s=r[n-1],c=i.coordinateConverter.bearingToCartesian(s,e),l=Cesium.Cartesian3.distance(s,e)/1e3;t.push(Object.assign(Object.assign(Object.assign(Object.assign({text:u&&u(c)||i.bearingStringFn&&i.bearingStringFn(c)||c.toFixed(2)+"°",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:new Cesium.Cartesian3((e.x+s.x)/2,(e.y+s.y)/2,(e.z+s.z)/2),fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},i.labelsStyle),a),i.bearingLabelsStyle),d),Object.assign(Object.assign(Object.assign(Object.assign({text:h&&h(o+l)||i.distanceStringFn&&i.distanceStringFn(o+l)||(o+l).toFixed(2)+" Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-35,-8),position:e,fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},i.labelsStyle),a),i.distanceLabelsStyle),p)),o+=l}return t}),[Object.assign(Object.assign(Object.assign(Object.assign({text:h&&h(0)||i.distanceStringFn&&i.distanceStringFn(0)||"0 Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:n[0],fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},i.labelsStyle),a),i.distanceLabelsStyle),p)]):[]})),y},e}();mn.decorators=[{type:e.Component,args:[{selector:"range-and-bearing",template:"\n    <polylines-editor></polylines-editor>\n  ",changeDetection:e.ChangeDetectionStrategy.OnPush,providers:[on]}]}],mn.ctorParameters=function(){return[{type:on},{type:G}]},mn.propDecorators={lineEditOptions:[{type:e.Input}],labelsStyle:[{type:e.Input}],distanceLabelsStyle:[{type:e.Input}],bearingLabelsStyle:[{type:e.Input}],bearingStringFn:[{type:e.Input}],distanceStringFn:[{type:e.Input}],labelsRenderFn:[{type:e.Input}]},(fn=t.MouseButtons||(t.MouseButtons={}))[fn.LEFT=0]="LEFT",fn[fn.MIDDLE=1]="MIDDLE",fn[fn.RIGHT=2]="RIGHT";var vn=function(){function e(e,i,n){this.mapsManager=e,this.mapsZoomElements=new Map,this.defaultOptions={animationDurationInSeconds:.5,resetKeyCode:27,borderStyle:"2px solid rgba(0,0,0,0.5)",backgroundColor:"rgba(0,0,0,0.2)",autoDisableOnZoom:!0,threshold:9,keepRotation:!0,mouseButton:t.MouseButtons.LEFT}}return e.prototype.init=function(t,e){this.cameraService=e,this.cesiumService=t},e.prototype.activate=function(t,e){var i=this;if(void 0===t&&(t={}),!(this.cameraService&&this.cesiumService||e))throw new Error("The function must receive a mapId if the service wasn't initialized");var n,o,r=Object.assign({},this.defaultOptions,t),s=this.cameraService;if(this.cesiumService&&(n=this.cesiumService.getViewer().container,o=this.cesiumService.getMap()),e){if(!(o=this.mapsManager.getMap(e)))throw new Error("Map not found with id: "+e);s=o.getCameraService(),n=o.getCesiumViewer().container}if(!s||!n)throw new Error("The function must receive a mapId if the service wasn't initialized");this.disable(e);var a=document.createElement("div");n.style.position="relative",a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.top="0",a.style.left="0",n.appendChild(a);var c={container:a};this.mapsZoomElements.set(e||this.cesiumService.getMap().getId(),c);var p,l={endX:0,endY:0,startX:0,startY:0};a.onmousedown=function(e){if(e.button===r.mouseButton&&!p){t&&t.onStart&&t.onStart(o);var i=e.currentTarget.getBoundingClientRect(),n=e.clientX-i.left,s=e.clientY-i.top;l.startX=n,l.startY=s,(p=document.createElement("div")).className="zoom-to-rectangle-border",p.style.position="absolute",p.style.border=r.borderStyle,p.style.backgroundColor=r.backgroundColor,p.style.left=l.startX+"px",p.style.top=l.startY+"px",a.appendChild(p),c.borderElement=p}},a.onmouseup=function(t){if(p){var n=void 0;l&&Math.abs(l.endX-l.startX)*Math.abs(l.endY-l.startY)>r.threshold&&(n=i.zoomCameraToRectangle(s,l,r.animationDurationInSeconds,r)),p.remove(),p=void 0,c.borderElement=void 0,l={endX:0,endY:0,startX:0,startY:0},r.onComplete&&r.onComplete(o),r.autoDisableOnZoom&&n&&i.disable(e)}},a.onmousemove=function(t){if(p){var e=t.currentTarget.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;l.endX=i,l.endY=n,p.style.width=Math.abs(l.endX-l.startX)+"px",p.style.height=Math.abs(l.endY-l.startY)+"px",p.style.left=Math.min(l.startX,l.endX)+"px",p.style.top=Math.min(l.startY,l.endY)+"px"}};var d=function(t){t.keyCode===r.resetKeyCode&&p&&(p.remove(),p=void 0,c.borderElement=void 0,l={endX:0,endY:0,startX:0,startY:0})};document.addEventListener("keydown",d),c.resetOnEscapePressFunc=d},e.prototype.disable=function(t){if(!this.cesiumService&&!t)throw new Error("If the service was not initialized with CesiumService, mapId must be provided");var e=this.mapsZoomElements.get(t||this.cesiumService.getMap().getId());e&&(e.container.remove(),e.borderElement&&e.borderElement.remove(),e.resetOnEscapePressFunc&&document.removeEventListener("keydown",e.resetOnEscapePressFunc)),this.mapsZoomElements.delete(t)},e.prototype.zoomCameraToRectangle=function(t,e,i,n){var o=t.getCamera(),r=o.pickEllipsoid({x:e.startX,y:e.startY}),s=o.pickEllipsoid({x:e.endX,y:e.endY});if(!r||!s)return!1;var a=Cesium.Cartographic.fromCartesian(r),c=Cesium.Cartographic.fromCartesian(s);return t.cameraFlyTo({destination:new Cesium.Rectangle(Math.min(a.longitude,c.longitude),Math.min(a.latitude,c.latitude),Math.max(a.longitude,c.longitude),Math.max(a.latitude,c.latitude)),orientation:n.keepRotation?{heading:o.heading}:void 0,duration:i}),!0},e}();vn.decorators=[{type:e.Injectable}],vn.ctorParameters=function(){return[{type:Tt},{type:V,decorators:[{type:e.Optional}]},{type:f,decorators:[{type:e.Optional}]}]};var En=function(){function t(){this.rectangles=new Map}return t.prototype.createEditableRectangle=function(t,e,i,n,o,r){var s=new Wi(t,i,e,n,o,r);this.rectangles.set(t,s)},t.prototype.dispose=function(t){this.rectangles.get(t).dispose(),this.rectangles.delete(t)},t.prototype.get=function(t){return this.rectangles.get(t)},t.prototype.clear=function(){this.rectangles.forEach((function(t){return t.dispose()})),this.rectangles.clear()},t}();En.decorators=[{type:e.Injectable}];var Pn={addPointEvent:t.CesiumEvent.LEFT_CLICK,dragPointEvent:t.CesiumEvent.LEFT_CLICK_DRAG,dragShapeEvent:t.CesiumEvent.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE,outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},rectangleProps:{height:0,extrudedHeight:0,material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,classificationType:Cesium.ClassificationType.BOTH,outline:!0,outlineColor:Cesium.Color.WHITE,zIndex:0},clampHeightTo3D:!1,clampHeightTo3DOptions:{clampToTerrain:!1}},bn=function(){function e(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return e.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.rectanglesManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},e.prototype.onUpdate=function(){return this.updatePublisher},e.prototype.create=function(e,i){var n=this;void 0===e&&(e=Pn),void 0===i&&(i=100);var o=[],r=Ei(),a=this.setOptions(e),c=new s.BehaviorSubject({id:r,editAction:null,editMode:t.EditModes.CREATE}),p=!1;this.updateSubject.next({id:r,positions:o,editMode:t.EditModes.CREATE,editAction:t.EditActions.INIT,rectangleOptions:a});var l=function(){var e={id:r,editMode:t.EditModes.CREATE,editAction:t.EditActions.CHANGE_TO_EDIT};return n.updateSubject.next(e),c.next(e),n.observablesMap.has(r)&&n.observablesMap.get(r).forEach((function(t){return t.dispose()})),n.observablesMap.delete(r),n.editRectangle(r,o,i,c,a,h),p=!0},d=this.mapEventsManager.register({event:t.CesiumEvent.MOUSE_MOVE,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i}),u=this.mapEventsManager.register({event:a.addPointEvent,pick:t.PickOptions.NO_PICK,pickConfig:e.pickConfiguration,priority:i});this.observablesMap.set(r,[d,u]);var h=this.createEditorObservable(c,r,l);return d.subscribe((function(e){var i=e.movement.endPosition,o=n.coordinateConverter.screenToCartesian3(i);o&&n.updateSubject.next({id:r,positions:n.getPositions(r),editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.MOUSE_MOVE})})),u.subscribe((function(e){var i=e.movement.endPosition;if(!p){var o=n.coordinateConverter.screenToCartesian3(i);if(o){var s=n.getPositions(r),a=0===n.getPositions(r).length,d={id:r,positions:s,editMode:t.EditModes.CREATE,updatedPosition:o,editAction:t.EditActions.ADD_POINT};n.updateSubject.next(d),c.next(Object.assign(Object.assign({},d),{positions:n.getPositions(r),points:n.getPoints(r)})),a||(p=l())}}})),h},e.prototype.edit=function(e,i,n){if(void 0===i&&(i=Pn),void 0===n&&(n=100),2!==e.length)throw new Error("Rectangles editor error edit(): rectangle should have at least 2 positions");var o=Ei(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:t.EditModes.EDIT}),c={id:o,positions:e,editMode:t.EditModes.EDIT,editAction:t.EditActions.INIT,rectangleOptions:r};return this.updateSubject.next(c),a.next(Object.assign(Object.assign({},c),{positions:this.getPositions(o),points:this.getPoints(o)})),this.editRectangle(o,e,n,a,r)},e.prototype.editRectangle=function(e,i,n,o,s,a){var c,p=this,l=this.mapEventsManager.register({event:s.dragPointEvent,entityType:vi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.editedEntityId}});s.allowDrag&&(c=this.mapEventsManager.register({event:s.dragShapeEvent,entityType:Wi,pick:t.PickOptions.PICK_FIRST,pickConfig:s.pickConfiguration,priority:n,pickFilter:function(t){return e===t.id}})),l.pipe(r.tap((function(t){var i=t.movement.drop;return p.rectanglesManager.get(e).enableEdit&&p.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.endPosition,s=n.drop,a=i.entities,c=p.coordinateConverter.screenToCartesian3(r);if(c){var l=a[0],d={id:e,positions:p.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:c,updatedPoint:l,editAction:s?t.EditActions.DRAG_POINT_FINISH:t.EditActions.DRAG_POINT};p.updateSubject.next(d),o.next(Object.assign(Object.assign({},d),{positions:p.getPositions(e),points:p.getPoints(e)}))}})),c&&c.pipe(r.tap((function(t){var i=t.movement.drop;return p.rectanglesManager.get(e).enableEdit&&p.cameraService.enableInputs(i)}))).subscribe((function(i){var n=i.movement,r=n.startPosition,s=n.endPosition,a=n.drop,c=(i.entities,p.coordinateConverter.screenToCartesian3(s)),l=p.coordinateConverter.screenToCartesian3(r);if(c){var d={id:e,positions:p.getPositions(e),editMode:t.EditModes.EDIT,updatedPosition:c,draggedPosition:l,editAction:a?t.EditActions.DRAG_SHAPE_FINISH:t.EditActions.DRAG_SHAPE};p.updateSubject.next(d),o.next(Object.assign(Object.assign({},d),{positions:p.getPositions(e),points:p.getPoints(e)}))}}));var d=[l];return c&&d.push(c),this.observablesMap.set(e,d),a||this.createEditorObservable(o,e)},e.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Pn)),i=Object.assign(e,t);if(i.pointProps=Object.assign({},Pn.pointProps,t.pointProps),i.rectangleProps=Object.assign({},Pn.rectangleProps,t.rectangleProps),t.clampHeightTo3D){if(!this.cesiumScene.pickPositionSupported||!this.cesiumScene.clampToHeightSupported)throw new Error("Cesium pickPosition and clampToHeight must be supported to use clampHeightTo3D");this.cesiumScene.pickTranslucentDepth&&console.warn("Cesium scene.pickTranslucentDepth must be false in order to make the editors work properly on 3D"),1!==i.pointProps.color.alpha&&1!==i.pointProps.outlineColor.alpha||console.warn("Point color and outline color must have alpha in order to make the editor work properly on 3D"),i.pointProps.heightReference=i.clampHeightTo3DOptions.clampToTerrain?Cesium.HeightReference.CLAMP_TO_GROUND:Cesium.HeightReference.RELATIVE_TO_GROUND,i.pointProps.disableDepthTestDistance=Number.POSITIVE_INFINITY}return i},e.prototype.createEditorObservable=function(e,i,n){var o=this;return e.dispose=function(){var e=o.observablesMap.get(i);e&&e.forEach((function(t){return t.dispose()})),o.observablesMap.delete(i),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.DISPOSE})},e.enable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.ENABLE})},e.disable=function(){o.updateSubject.next({id:i,positions:o.getPositions(i),editMode:t.EditModes.EDIT,editAction:t.EditActions.DISABLE})},e.setManually=function(e,n,r,s){var a=new vi(i,e,r||Pn.pointProps),c=new vi(i,n,s||Pn.pointProps);o.rectanglesManager.get(i).setPointsManually([a,c]),o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_MANUALLY})},e.setLabelsRenderFn=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:e})},e.updateLabels=function(e){o.updateSubject.next({id:i,editMode:t.EditModes.CREATE_OR_EDIT,editAction:t.EditActions.UPDATE_EDIT_LABELS,updateLabels:e})},e.finishCreation=function(){if(!n)throw new Error("Rectangles editor error edit(): cannot call finishCreation() on edit");return n()},e.getCurrentPoints=function(){return o.getPoints(i)},e.getEditValue=function(){return e.getValue()},e.getLabels=function(){return o.rectanglesManager.get(i).labels},e},e.prototype.getPositions=function(t){return this.rectanglesManager.get(t).getRealPositions()},e.prototype.getPoints=function(t){return this.rectanglesManager.get(t).getRealPoints()},e}();bn.decorators=[{type:e.Injectable}];var Cn=function(){function e(t,e,i,n,o,r){this.rectanglesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.rectanglesManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editRectangles$=new s.Subject,this.rectanglesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.rectanglesManager,this.cesiumService),this.startListeningToEditorUpdates()}return e.prototype.startListeningToEditorUpdates=function(){var e=this;this.rectanglesEditor.onUpdate().subscribe((function(i){i.editMode===t.EditModes.CREATE||i.editMode===t.EditModes.CREATE_OR_EDIT?e.handleCreateUpdates(i):i.editMode===t.EditModes.EDIT&&e.handleEditUpdates(i)}))},e.prototype.getLabelId=function(t,e){return e.toString()},e.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editRectanglesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editRectanglesLayer.update(t,t.getId()))},e.prototype.removeEditLabels=function(t){t.labels=[],this.editRectanglesLayer.update(t,t.getId())},e.prototype.handleCreateUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.rectanglesManager.createEditableRectangle(e.id,this.editRectanglesLayer,this.editPointsLayer,this.coordinateConverter,e.rectangleOptions);break;case t.EditActions.MOUSE_MOVE:var i=this.rectanglesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_POINT:i=this.rectanglesManager.get(e.id);e.updatedPosition&&(i.moveTempMovingPoint(e.updatedPosition),i.addPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.ADD_LAST_POINT:i=this.rectanglesManager.get(e.id);e.updatedPosition&&(i.addLastPoint(e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DISPOSE:(i=this.rectanglesManager.get(e.id))&&(i.dispose(),this.removeEditLabels(i)),this.editLabelsRenderFn=void 0;break;case t.EditActions.SET_EDIT_LABELS_RENDER_CALLBACK:i=this.rectanglesManager.get(e.id);this.editLabelsRenderFn=e.labelsRenderFn,this.renderEditLabels(i,e);break;case t.EditActions.UPDATE_EDIT_LABELS:i=this.rectanglesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;case t.EditActions.SET_MANUALLY:i=this.rectanglesManager.get(e.id);this.renderEditLabels(i,e,e.updateLabels);break;default:return}},e.prototype.handleEditUpdates=function(e){switch(e.editAction){case t.EditActions.INIT:this.rectanglesManager.createEditableRectangle(e.id,this.editRectanglesLayer,this.editPointsLayer,this.coordinateConverter,e.rectangleOptions,e.positions);break;case t.EditActions.DRAG_POINT:(i=this.rectanglesManager.get(e.id))&&i.enableEdit&&(i.movePoint(e.updatedPosition,e.updatedPoint),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_POINT_FINISH:(i=this.rectanglesManager.get(e.id))&&i.enableEdit&&(i.endMovePoint(),this.renderEditLabels(i,e));break;case t.EditActions.DISABLE:(i=this.rectanglesManager.get(e.id))&&(i.enableEdit=!1,this.renderEditLabels(i,e));break;case t.EditActions.ENABLE:(i=this.rectanglesManager.get(e.id))&&(i.enableEdit=!0,this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE:(i=this.rectanglesManager.get(e.id))&&i.enableEdit&&(i.moveShape(e.draggedPosition,e.updatedPosition),this.renderEditLabels(i,e));break;case t.EditActions.DRAG_SHAPE_FINISH:var i;(i=this.rectanglesManager.get(e.id))&&i.enableEdit&&(i.endMoveShape(),this.renderEditLabels(i,e));break;default:return}},e.prototype.ngOnDestroy=function(){this.rectanglesManager.clear()},e.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},e.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},e}();Cn.decorators=[{type:e.Component,args:[{selector:"rectangles-editor",template:'\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editRectanglesLayer acFor="let rectangle of editRectangles$" [context]="this">\n      <ac-rectangle-desc\n        props="{\n          coordinates: rectangle.getRectangleCallbackProperty(),\n          material: rectangle.rectangleProps.material,\n          fill: rectangle.rectangleProps.fill,\n          classificationType: rectangle.rectangleProps.classificationType,\n          zIndex: rectangle.rectangleProps.zIndex,\n          outline: rectangle.rectangleProps.outline,\n          outlineColor: rectangle.rectangleProps.outlineColor,\n          height: rectangle.rectangleProps.height,\n          extrudedHeight: rectangle.rectangleProps.extrudedHeight\n        }"\n      >\n      </ac-rectangle-desc>\n      <ac-array-desc acFor="let label of rectangle.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[G,En],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],Cn.ctorParameters=function(){return[{type:bn},{type:G},{type:Mt},{type:V},{type:En},{type:f}]},Cn.propDecorators={editRectanglesLayer:[{type:e.ViewChild,args:["editRectanglesLayer"]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer"]}]};var _n=function(){};_n.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule,ui],declarations:[Ti,ln,Ri,Cn,Hi,Ki,sn,un,gn,hn,yn,mn],exports:[Ti,ln,Ri,Cn,Hi,Ki,sn,un,hn,yn,mn],providers:[dn,vn]}]}],t.AcArcComponent=Ae,t.AcArcDescComponent=he,t.AcArrayDescComponent=si,t.AcBillboardComponent=te,t.AcBillboardDescComponent=re,t.AcBillboardPrimitiveDescComponent=Ye,t.AcBoxDescComponent=Be,t.AcCircleComponent=Te,t.AcCircleDescComponent=ue,t.AcCorridorDescComponent=Ge,t.AcCylinderDescComponent=Ue,t.AcCzmlDescComponent=li,t.AcDefaultPlonterComponent=Ie,t.AcDynamicCircleDescComponent=Ne,t.AcDynamicEllipseDescComponent=Re,t.AcDynamicPolylineDescComponent=xe,t.AcEllipseComponent=_e,t.AcEllipseDescComponent=se,t.AcEllipsoidDescComponent=Ke,t.AcEntity=fe,t.AcHtmlComponent=Se,t.AcHtmlDescComponent=ni,t.AcLabelComponent=be,t.AcLabelDescComponent=le,t.AcLabelPrimitiveDescComponent=Ze,t.AcLayerComponent=Jt,t.AcMapComponent=Ot,t.AcMapLayerProviderComponent=ve,t.AcMapTerrainProviderComponent=Ee,t.AcModelDescComponent=He,t.AcNotification=me,t.AcPointComponent=Me,t.AcPointDescComponent=Pe,t.AcPointPrimitiveDescComponent=ai,t.AcPolygonComponent=De,t.AcPolygonDescComponent=Oe,t.AcPolylineComponent=Ce,t.AcPolylineDescComponent=ae,t.AcPolylinePrimitiveDescComponent=qe,t.AcPolylineVolumeDescComponent=ze,t.AcPrimitivePolylineComponent=ci,t.AcRectangleComponent=di,t.AcRectangleDescComponent=$e,t.AcStaticCircleDescComponent=ke,t.AcStaticEllipseDescComponent=we,t.AcStaticPolygonDescComponent=je,t.AcStaticPolylineDescComponent=Fe,t.AcTileset3dComponent=Ve,t.AcToolbarButtonComponent=yn,t.AcToolbarComponent=hn,t.AcWallDescComponent=We,t.AngularCesiumModule=ui,t.AngularCesiumWidgetsModule=_n,t.CameraService=V,t.CesiumService=f,t.CircleEditorObservable=Ji,t.CirclesEditorComponent=Hi,t.CirclesEditorService=Fi,t.ContextMenuService=B,t.CoordinateConverter=G,t.DEFAULT_CIRCLE_OPTIONS=Ni,t.DEFAULT_ELLIPSE_OPTIONS=Ui,t.DEFAULT_HIPPODROME_OPTIONS=cn,t.DEFAULT_POINT_OPTIONS=bi,t.DEFAULT_POLYGON_OPTIONS=Li,t.DEFAULT_POLYLINE_OPTIONS=nn,t.DEFAULT_RECTANGLE_OPTIONS=Pn,t.DisposableObservable=gi,t.DraggableToMapDirective=un,t.DraggableToMapService=dn,t.EditArc=xi,t.EditPoint=vi,t.EditPolyline=Ai,t.EditableCircle=ji,t.EditableEllipse=Vi,t.EditableHippodrome=en,t.EditablePoint=Mi,t.EditablePolygon=Oi,t.EditablePolyline=zi,t.EditableRectangle=Wi,t.EditorObservable=$i,t.EllipseEditorObservable=Qi,t.EllipsesEditorComponent=Ki,t.EllipsesEditorService=Gi,t.GeoUtilsService=q,t.HippodromeEditorComponent=ln,t.HippodromeEditorObservable=tn,t.HippodromeEditorService=pn,t.KeyboardControlService=ft,t.MapEventsManagerService=Mt,t.MapsManagerService=Tt,t.PREDEFINED_KEYBOARD_ACTIONS=yt,t.PixelOffsetPipe=ce,t.PlonterService=Pt,t.PointEditorObservable=Yi,t.PointsEditorComponent=Ti,t.PointsEditorService=Ci,t.PolygonEditorObservable=qi,t.PolygonsEditorComponent=Ri,t.PolygonsEditorService=wi,t.PolylineEditorObservable=Zi,t.PolylinesEditorComponent=sn,t.PolylinesEditorService=on,t.RadiansToDegreesPipe=pe,t.RangeAndBearingComponent=mn,t.RectangleEditorObservable=Xi,t.RectanglesEditorComponent=Cn,t.RectanglesEditorService=bn,t.ScreenshotService=At,t.SelectionManagerService=mi,t.ViewerConfiguration=y,t.ZoomToRectangleService=vn,t.defaultLabelProps=_i,t.ɵ0=Di,t.ɵa=de,t.ɵb=g,t.ɵba=zt,t.ɵbb=Wt,t.ɵbc=$t,t.ɵbd=Yt,t.ɵbe=Zt,t.ɵbf=qt,t.ɵbg=Xt,t.ɵbh=Rt,t.ɵbi=xt,t.ɵbj=kt,t.ɵbk=jt,t.ɵbl=Nt,t.ɵbm=Ft,t.ɵbn=Ht,t.ɵbo=Qt,t.ɵbp=oe,t.ɵbq=ne,t.ɵbr=ee,t.ɵbs=ri,t.ɵbt=ti,t.ɵbu=ei,t.ɵbv=ii,t.ɵbw=oi,t.ɵbx=Le,t.ɵby=Si,t.ɵbz=an,t.ɵc=et,t.ɵca=Ii,t.ɵcb=En,t.ɵcc=ki,t.ɵcd=Bi,t.ɵce=rn,t.ɵcf=gn,t.ɵd=tt,t.ɵe=Y,t.ɵg=Et,t.ɵh=ot,t.ɵi=at,t.ɵj=lt,t.ɵk=Z,t.ɵl=nt,t.ɵm=rt,t.ɵn=J,t.ɵo=it,t.ɵp=st,t.ɵq=St,t.ɵr=k,t.ɵs=N,t.ɵt=Dt,t.ɵu=Lt,t.ɵv=Vt,t.ɵw=Bt,t.ɵx=Ut,t.ɵy=Gt,t.ɵz=Kt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-cesium.umd.min.js.map